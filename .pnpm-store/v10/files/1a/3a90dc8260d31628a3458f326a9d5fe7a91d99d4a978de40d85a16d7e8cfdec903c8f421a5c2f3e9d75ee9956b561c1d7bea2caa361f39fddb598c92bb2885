{"version":3,"sources":["../../../src/server/dev/serialized-errors.ts"],"sourcesContent":["import { streamToUint8Array } from '../stream-utils/node-web-streams-helper'\nimport {\n  HMR_MESSAGE_SENT_TO_BROWSER,\n  type HmrMessageSentToBrowser,\n} from './hot-reloader-types'\n\nconst errorsRscStreamsByHtmlRequestId = new Map<\n  string,\n  ReadableStream<Uint8Array>\n>()\n\nexport function sendSerializedErrorsToClient(\n  errorsRscStream: ReadableStream<Uint8Array>,\n  sendToClient: (message: HmrMessageSentToBrowser) => void\n) {\n  streamToUint8Array(errorsRscStream).then(\n    (serializedErrors) => {\n      sendToClient({\n        type: HMR_MESSAGE_SENT_TO_BROWSER.ERRORS_TO_SHOW_IN_BROWSER,\n        serializedErrors,\n      })\n    },\n    (err) => {\n      console.error(new Error('Failed to serialize errors.', { cause: err }))\n    }\n  )\n}\n\nexport function sendSerializedErrorsToClientForHtmlRequest(\n  htmlRequestId: string,\n  sendToClient: (message: HmrMessageSentToBrowser) => void\n) {\n  const errorsRscStream = errorsRscStreamsByHtmlRequestId.get(htmlRequestId)\n\n  if (!errorsRscStream) {\n    return\n  }\n\n  errorsRscStreamsByHtmlRequestId.delete(htmlRequestId)\n\n  sendSerializedErrorsToClient(errorsRscStream, sendToClient)\n}\n\nexport function setErrorsRscStreamForHtmlRequest(\n  htmlRequestId: string,\n  errorsRscStream: ReadableStream<Uint8Array>\n) {\n  // TODO: Clean up after a timeout, in case the client never connects, e.g.\n  // when CURL'ing the page, or loading the page with JavaScript disabled etc.\n  errorsRscStreamsByHtmlRequestId.set(htmlRequestId, errorsRscStream)\n}\n\nexport function deleteErrorsRscStreamForHtmlRequest(htmlRequestId: string) {\n  errorsRscStreamsByHtmlRequestId.delete(htmlRequestId)\n}\n"],"names":["deleteErrorsRscStreamForHtmlRequest","sendSerializedErrorsToClient","sendSerializedErrorsToClientForHtmlRequest","setErrorsRscStreamForHtmlRequest","errorsRscStreamsByHtmlRequestId","Map","errorsRscStream","sendToClient","streamToUint8Array","then","serializedErrors","type","HMR_MESSAGE_SENT_TO_BROWSER","ERRORS_TO_SHOW_IN_BROWSER","err","console","error","Error","cause","htmlRequestId","get","delete","set"],"mappings":";;;;;;;;;;;;;;;;;IAoDgBA,mCAAmC;eAAnCA;;IAzCAC,4BAA4B;eAA5BA;;IAiBAC,0CAA0C;eAA1CA;;IAeAC,gCAAgC;eAAhCA;;;sCA3CmB;kCAI5B;AAEP,MAAMC,kCAAkC,IAAIC;AAKrC,SAASJ,6BACdK,eAA2C,EAC3CC,YAAwD;IAExDC,IAAAA,wCAAkB,EAACF,iBAAiBG,IAAI,CACtC,CAACC;QACCH,aAAa;YACXI,MAAMC,6CAA2B,CAACC,yBAAyB;YAC3DH;QACF;IACF,GACA,CAACI;QACCC,QAAQC,KAAK,CAAC,qBAAwD,CAAxD,IAAIC,MAAM,+BAA+B;YAAEC,OAAOJ;QAAI,IAAtD,qBAAA;mBAAA;wBAAA;0BAAA;QAAuD;IACvE;AAEJ;AAEO,SAASZ,2CACdiB,aAAqB,EACrBZ,YAAwD;IAExD,MAAMD,kBAAkBF,gCAAgCgB,GAAG,CAACD;IAE5D,IAAI,CAACb,iBAAiB;QACpB;IACF;IAEAF,gCAAgCiB,MAAM,CAACF;IAEvClB,6BAA6BK,iBAAiBC;AAChD;AAEO,SAASJ,iCACdgB,aAAqB,EACrBb,eAA2C;IAE3C,0EAA0E;IAC1E,4EAA4E;IAC5EF,gCAAgCkB,GAAG,CAACH,eAAeb;AACrD;AAEO,SAASN,oCAAoCmB,aAAqB;IACvEf,gCAAgCiB,MAAM,CAACF;AACzC","ignoreList":[0]}