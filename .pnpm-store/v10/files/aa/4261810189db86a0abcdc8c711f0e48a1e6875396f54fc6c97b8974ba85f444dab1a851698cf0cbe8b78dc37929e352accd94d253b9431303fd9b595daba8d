{"version":3,"file":"session.cjs","names":["CockroachPreparedQuery","entityKind","client: NodeCockroachClient","params: unknown[]","logger: Logger","fields: SelectedFieldsOrdered | undefined","_isResponseInArrayMode: boolean","customResultMapper?: (rows: unknown[][]) => T['execute']","tracer","CockroachSession","schema: V1.RelationalSchemaConfig<TSchema> | undefined","options: NodeCockroachSessionOptions","NoopLogger","sql","CockroachTransaction"],"sources":["../../src/cockroach/session.ts"],"sourcesContent":["import type { Client, PoolClient, QueryArrayConfig, QueryConfig, QueryResult, QueryResultRow } from 'pg';\nimport pg from 'pg';\nimport type * as V1 from '~/_relations.ts';\nimport type { CockroachDialect } from '~/cockroach-core/dialect.ts';\nimport { CockroachTransaction } from '~/cockroach-core/index.ts';\nimport type { SelectedFieldsOrdered } from '~/cockroach-core/query-builders/select.types.ts';\nimport type {\n\tCockroachQueryResultHKT,\n\tCockroachTransactionConfig,\n\tPreparedQueryConfig,\n} from '~/cockroach-core/session.ts';\nimport { CockroachPreparedQuery, CockroachSession } from '~/cockroach-core/session.ts';\nimport { entityKind } from '~/entity.ts';\nimport { type Logger, NoopLogger } from '~/logger.ts';\nimport { fillPlaceholders, type Query, type SQL, sql } from '~/sql/sql.ts';\nimport { tracer } from '~/tracing.ts';\nimport { type Assume, mapResultRow } from '~/utils.ts';\n\nconst { Pool, types } = pg;\n\nexport type NodeCockroachClient = pg.Pool | PoolClient | Client;\n\nexport class NodeCockroachPreparedQuery<T extends PreparedQueryConfig> extends CockroachPreparedQuery<T> {\n\tstatic override readonly [entityKind]: string = 'NodeCockroachPreparedQuery';\n\n\tprivate rawQueryConfig: QueryConfig;\n\tprivate queryConfig: QueryArrayConfig;\n\n\tconstructor(\n\t\tprivate client: NodeCockroachClient,\n\t\tqueryString: string,\n\t\tprivate params: unknown[],\n\t\tprivate logger: Logger,\n\t\tprivate fields: SelectedFieldsOrdered | undefined,\n\t\tname: string | undefined,\n\t\tprivate _isResponseInArrayMode: boolean,\n\t\tprivate customResultMapper?: (rows: unknown[][]) => T['execute'],\n\t) {\n\t\tsuper({ sql: queryString, params });\n\t\tthis.rawQueryConfig = {\n\t\t\tname,\n\t\t\ttext: queryString,\n\t\t\ttypes: {\n\t\t\t\t// @ts-ignore\n\t\t\t\tgetTypeParser: (typeId, format) => {\n\t\t\t\t\tif (typeId === types.builtins.TIMESTAMPTZ) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\tif (typeId === types.builtins.TIMESTAMP) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\tif (typeId === types.builtins.DATE) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\tif (typeId === types.builtins.INTERVAL) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\t// numeric[]\n\t\t\t\t\tif (typeId as number === 1231) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\t// timestamp[]\n\t\t\t\t\tif (typeId as number === 1115) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\t// timestamp with timezone[]\n\t\t\t\t\tif (typeId as number === 1185) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\t// interval[]\n\t\t\t\t\tif (typeId as number === 1187) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\t// date[]\n\t\t\t\t\tif (typeId as number === 1182) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\treturn types.getTypeParser(typeId, format);\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\t\tthis.queryConfig = {\n\t\t\tname,\n\t\t\ttext: queryString,\n\t\t\trowMode: 'array',\n\t\t\ttypes: {\n\t\t\t\t// @ts-ignore\n\t\t\t\tgetTypeParser: (typeId, format) => {\n\t\t\t\t\tif (typeId === types.builtins.TIMESTAMPTZ) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\tif (typeId === types.builtins.TIMESTAMP) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\tif (typeId === types.builtins.DATE) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\tif (typeId === types.builtins.INTERVAL) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\t// numeric[]\n\t\t\t\t\tif (typeId as number === 1231) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\t// timestamp[]\n\t\t\t\t\tif (typeId as number === 1115) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\t// timestamp with timezone[]\n\t\t\t\t\tif (typeId as number === 1185) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\t// interval[]\n\t\t\t\t\tif (typeId as number === 1187) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\t// date[]\n\t\t\t\t\tif (typeId as number === 1182) {\n\t\t\t\t\t\treturn (val: any) => val;\n\t\t\t\t\t}\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\treturn types.getTypeParser(typeId, format);\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\t}\n\n\tasync execute(placeholderValues: Record<string, unknown> | undefined = {}): Promise<T['execute']> {\n\t\treturn tracer.startActiveSpan('drizzle.execute', async () => {\n\t\t\tconst params = fillPlaceholders(this.params, placeholderValues);\n\n\t\t\tthis.logger.logQuery(this.rawQueryConfig.text, params);\n\n\t\t\tconst { fields, rawQueryConfig: rawQuery, client, queryConfig: query, joinsNotNullableMap, customResultMapper } =\n\t\t\t\tthis;\n\t\t\tif (!fields && !customResultMapper) {\n\t\t\t\treturn tracer.startActiveSpan('drizzle.driver.execute', async (span) => {\n\t\t\t\t\tspan?.setAttributes({\n\t\t\t\t\t\t'drizzle.query.name': rawQuery.name,\n\t\t\t\t\t\t'drizzle.query.text': rawQuery.text,\n\t\t\t\t\t\t'drizzle.query.params': JSON.stringify(params),\n\t\t\t\t\t});\n\t\t\t\t\treturn client.query(rawQuery, params);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst result = await tracer.startActiveSpan('drizzle.driver.execute', (span) => {\n\t\t\t\tspan?.setAttributes({\n\t\t\t\t\t'drizzle.query.name': query.name,\n\t\t\t\t\t'drizzle.query.text': query.text,\n\t\t\t\t\t'drizzle.query.params': JSON.stringify(params),\n\t\t\t\t});\n\t\t\t\treturn client.query(query, params);\n\t\t\t});\n\n\t\t\treturn tracer.startActiveSpan('drizzle.mapResponse', () => {\n\t\t\t\treturn customResultMapper\n\t\t\t\t\t? customResultMapper(result.rows)\n\t\t\t\t\t: result.rows.map((row) => mapResultRow<T['execute']>(fields!, row, joinsNotNullableMap));\n\t\t\t});\n\t\t});\n\t}\n\n\tall(placeholderValues: Record<string, unknown> | undefined = {}): Promise<T['all']> {\n\t\treturn tracer.startActiveSpan('drizzle.execute', () => {\n\t\t\tconst params = fillPlaceholders(this.params, placeholderValues);\n\t\t\tthis.logger.logQuery(this.rawQueryConfig.text, params);\n\t\t\treturn tracer.startActiveSpan('drizzle.driver.execute', (span) => {\n\t\t\t\tspan?.setAttributes({\n\t\t\t\t\t'drizzle.query.name': this.rawQueryConfig.name,\n\t\t\t\t\t'drizzle.query.text': this.rawQueryConfig.text,\n\t\t\t\t\t'drizzle.query.params': JSON.stringify(params),\n\t\t\t\t});\n\t\t\t\treturn this.client.query(this.rawQueryConfig, params).then((result) => result.rows);\n\t\t\t});\n\t\t});\n\t}\n\n\t/** @internal */\n\tisResponseInArrayMode(): boolean {\n\t\treturn this._isResponseInArrayMode;\n\t}\n}\n\nexport interface NodeCockroachSessionOptions {\n\tlogger?: Logger;\n}\n\nexport class NodeCockroachSession<\n\tTFullSchema extends Record<string, unknown>,\n\tTSchema extends V1.TablesRelationalConfig,\n> extends CockroachSession<NodeCockroachQueryResultHKT, TFullSchema, TSchema> {\n\tstatic override readonly [entityKind]: string = 'NodeCockroachSession';\n\n\tprivate logger: Logger;\n\n\tconstructor(\n\t\tprivate client: NodeCockroachClient,\n\t\tdialect: CockroachDialect,\n\t\tprivate schema: V1.RelationalSchemaConfig<TSchema> | undefined,\n\t\tprivate options: NodeCockroachSessionOptions = {},\n\t) {\n\t\tsuper(dialect);\n\t\tthis.logger = options.logger ?? new NoopLogger();\n\t}\n\n\tprepareQuery<T extends PreparedQueryConfig = PreparedQueryConfig>(\n\t\tquery: Query,\n\t\tfields: SelectedFieldsOrdered | undefined,\n\t\tname: string | undefined,\n\t\tisResponseInArrayMode: boolean,\n\t\tcustomResultMapper?: (rows: unknown[][]) => T['execute'],\n\t): CockroachPreparedQuery<T> {\n\t\treturn new NodeCockroachPreparedQuery(\n\t\t\tthis.client,\n\t\t\tquery.sql,\n\t\t\tquery.params,\n\t\t\tthis.logger,\n\t\t\tfields,\n\t\t\tname,\n\t\t\tisResponseInArrayMode,\n\t\t\tcustomResultMapper,\n\t\t);\n\t}\n\n\toverride async transaction<T>(\n\t\ttransaction: (tx: NodeCockroachTransaction<TFullSchema, TSchema>) => Promise<T>,\n\t\tconfig?: CockroachTransactionConfig | undefined,\n\t): Promise<T> {\n\t\tconst session = this.client instanceof Pool // oxlint-disable-line drizzle-internal/no-instanceof\n\t\t\t? new NodeCockroachSession(await this.client.connect(), this.dialect, this.schema, this.options)\n\t\t\t: this;\n\t\tconst tx = new NodeCockroachTransaction<TFullSchema, TSchema>(this.dialect, session, this.schema);\n\t\tawait tx.execute(sql`begin${config ? sql` ${tx.getTransactionConfigSQL(config)}` : undefined}`);\n\t\ttry {\n\t\t\tconst result = await transaction(tx);\n\t\t\tawait tx.execute(sql`commit`);\n\t\t\treturn result;\n\t\t} catch (error) {\n\t\t\tawait tx.execute(sql`rollback`);\n\t\t\tthrow error;\n\t\t} finally {\n\t\t\tif (this.client instanceof Pool) { // oxlint-disable-line drizzle-internal/no-instanceof\n\t\t\t\t(session.client as PoolClient).release();\n\t\t\t}\n\t\t}\n\t}\n\n\toverride async count(sql: SQL): Promise<number> {\n\t\tconst res = await this.execute<{ rows: [{ count: string }] }>(sql);\n\t\treturn Number(\n\t\t\tres['rows'][0]['count'],\n\t\t);\n\t}\n}\n\nexport class NodeCockroachTransaction<\n\tTFullSchema extends Record<string, unknown>,\n\tTSchema extends V1.TablesRelationalConfig,\n> extends CockroachTransaction<NodeCockroachQueryResultHKT, TFullSchema, TSchema> {\n\tstatic override readonly [entityKind]: string = 'NodeCockroachTransaction';\n\n\toverride async transaction<T>(\n\t\ttransaction: (tx: NodeCockroachTransaction<TFullSchema, TSchema>) => Promise<T>,\n\t): Promise<T> {\n\t\tconst savepointName = `sp${this.nestedIndex + 1}`;\n\t\tconst tx = new NodeCockroachTransaction<TFullSchema, TSchema>(\n\t\t\tthis.dialect,\n\t\t\tthis.session,\n\t\t\tthis.schema,\n\t\t\tthis.nestedIndex + 1,\n\t\t);\n\t\tawait tx.execute(sql.raw(`savepoint ${savepointName}`));\n\t\ttry {\n\t\t\tconst result = await transaction(tx);\n\t\t\tawait tx.execute(sql.raw(`release savepoint ${savepointName}`));\n\t\t\treturn result;\n\t\t} catch (err) {\n\t\t\tawait tx.execute(sql.raw(`rollback to savepoint ${savepointName}`));\n\t\t\tthrow err;\n\t\t}\n\t}\n}\n\nexport interface NodeCockroachQueryResultHKT extends CockroachQueryResultHKT {\n\ttype: QueryResult<Assume<this['row'], QueryResultRow>>;\n}\n"],"mappings":"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"}