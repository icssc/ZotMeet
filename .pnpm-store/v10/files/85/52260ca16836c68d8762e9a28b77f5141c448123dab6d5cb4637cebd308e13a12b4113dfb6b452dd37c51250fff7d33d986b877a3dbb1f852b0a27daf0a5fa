{"version":3,"file":"view.cjs","names":["entityKind","name: TConfig['name']","schema: string | undefined","QueryBuilder","SelectionProxyHandler","mssqlTable","MsSqlViewBase","MsSqlViewConfig"],"sources":["../../src/mssql-core/view.ts"],"sourcesContent":["import type { BuildColumns, ColumnBuilderBase } from '~/column-builder.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { TypedQueryBuilder } from '~/query-builders/query-builder.ts';\nimport type { AddAliasToSelection } from '~/query-builders/select.types.ts';\nimport { SelectionProxyHandler } from '~/selection-proxy.ts';\nimport type { ColumnsSelection, SQL } from '~/sql/sql.ts';\nimport { getTableColumns } from '~/utils.ts';\nimport type { MsSqlColumn } from './columns/index.ts';\nimport { QueryBuilder } from './query-builders/query-builder.ts';\nimport type { SelectedFields } from './query-builders/select.types.ts';\nimport { mssqlTable } from './table.ts';\nimport { MsSqlViewBase } from './view-base.ts';\nimport { MsSqlViewConfig } from './view-common.ts';\n\nexport interface ViewBuilderConfig {\n\tencryption?: boolean;\n\tschemaBinding?: boolean;\n\tviewMetadata?: boolean;\n\tcheckOption?: boolean;\n}\n\nexport class ViewBuilderCore<TConfig extends { name: string; columns?: unknown }> {\n\tstatic readonly [entityKind]: string = 'MsSqlViewBuilder';\n\n\tdeclare readonly _: {\n\t\treadonly name: TConfig['name'];\n\t\treadonly columns: TConfig['columns'];\n\t};\n\n\tconstructor(\n\t\tprotected name: TConfig['name'],\n\t\tprotected schema: string | undefined,\n\t) {}\n\n\tprotected config: ViewBuilderConfig = {\n\t\tencryption: false,\n\t\tschemaBinding: false,\n\t\tviewMetadata: false,\n\t};\n\n\twith(\n\t\tconfig?: ViewBuilderConfig,\n\t): this {\n\t\tthis.config.encryption = config?.encryption;\n\t\tthis.config.schemaBinding = config?.schemaBinding;\n\t\tthis.config.viewMetadata = config?.viewMetadata;\n\t\tthis.config.checkOption = config?.checkOption;\n\t\treturn this;\n\t}\n}\n\nexport class ViewBuilder<TName extends string = string> extends ViewBuilderCore<{ name: TName }> {\n\tstatic override readonly [entityKind]: string = 'MsSqlViewBuilder';\n\n\tas<TSelectedFields extends SelectedFields>(\n\t\tqb: TypedQueryBuilder<TSelectedFields> | ((qb: QueryBuilder) => TypedQueryBuilder<TSelectedFields>),\n\t): MsSqlViewWithSelection<TName, false, AddAliasToSelection<TSelectedFields, TName, 'mssql'>> {\n\t\tif (typeof qb === 'function') {\n\t\t\tqb = qb(new QueryBuilder());\n\t\t}\n\t\tconst selectionProxy = new SelectionProxyHandler<TSelectedFields>({\n\t\t\talias: this.name,\n\t\t\tsqlBehavior: 'error',\n\t\t\tsqlAliasedBehavior: 'alias',\n\t\t\treplaceOriginalName: true,\n\t\t});\n\t\tconst aliasedSelection = new Proxy(qb.getSelectedFields(), selectionProxy);\n\t\treturn new Proxy(\n\t\t\tnew MsSqlView({\n\t\t\t\tmssqlConfig: this.config,\n\t\t\t\tconfig: {\n\t\t\t\t\tname: this.name,\n\t\t\t\t\tschema: this.schema,\n\t\t\t\t\tselectedFields: aliasedSelection,\n\t\t\t\t\tquery: qb.getSQL().inlineParams(),\n\t\t\t\t},\n\t\t\t}),\n\t\t\tselectionProxy as any,\n\t\t) as MsSqlViewWithSelection<TName, false, AddAliasToSelection<TSelectedFields, TName, 'mssql'>>;\n\t}\n}\n\nexport class ManualViewBuilder<\n\tTName extends string = string,\n\tTColumns extends Record<string, ColumnBuilderBase> = Record<string, ColumnBuilderBase>,\n> extends ViewBuilderCore<{ name: TName; columns: TColumns }> {\n\tstatic override readonly [entityKind]: string = 'MsSqlManualViewBuilder';\n\n\tprivate columns: Record<string, MsSqlColumn>;\n\n\tconstructor(\n\t\tname: TName,\n\t\tcolumns: TColumns,\n\t\tschema: string | undefined,\n\t) {\n\t\tsuper(name, schema);\n\t\tthis.columns = getTableColumns(mssqlTable(name, columns)) as BuildColumns<TName, TColumns, 'mssql'>;\n\t}\n\n\texisting(): MsSqlViewWithSelection<TName, true, BuildColumns<TName, TColumns, 'mssql'>> {\n\t\treturn new Proxy(\n\t\t\tnew MsSqlView({\n\t\t\t\tmssqlConfig: undefined,\n\t\t\t\tconfig: {\n\t\t\t\t\tname: this.name,\n\t\t\t\t\tschema: this.schema,\n\t\t\t\t\tselectedFields: this.columns,\n\t\t\t\t\tquery: undefined,\n\t\t\t\t},\n\t\t\t}),\n\t\t\tnew SelectionProxyHandler({\n\t\t\t\talias: this.name,\n\t\t\t\tsqlBehavior: 'error',\n\t\t\t\tsqlAliasedBehavior: 'alias',\n\t\t\t\treplaceOriginalName: true,\n\t\t\t}),\n\t\t) as MsSqlViewWithSelection<TName, true, BuildColumns<TName, TColumns, 'mssql'>>;\n\t}\n\n\tas(query: SQL): MsSqlViewWithSelection<TName, false, BuildColumns<TName, TColumns, 'mssql'>> {\n\t\treturn new Proxy(\n\t\t\tnew MsSqlView({\n\t\t\t\tmssqlConfig: this.config,\n\t\t\t\tconfig: {\n\t\t\t\t\tname: this.name,\n\t\t\t\t\tschema: this.schema,\n\t\t\t\t\tselectedFields: this.columns,\n\t\t\t\t\tquery: query.inlineParams(),\n\t\t\t\t},\n\t\t\t}),\n\t\t\tnew SelectionProxyHandler({\n\t\t\t\talias: this.name,\n\t\t\t\tsqlBehavior: 'error',\n\t\t\t\tsqlAliasedBehavior: 'alias',\n\t\t\t\treplaceOriginalName: true,\n\t\t\t}),\n\t\t) as MsSqlViewWithSelection<TName, false, BuildColumns<TName, TColumns, 'mssql'>>;\n\t}\n}\n\nexport class MsSqlView<\n\tTName extends string = string,\n\tTExisting extends boolean = boolean,\n\tTSelectedFields extends ColumnsSelection = ColumnsSelection,\n> extends MsSqlViewBase<TName, TExisting, TSelectedFields> {\n\tstatic override readonly [entityKind]: string = 'MsSqlView';\n\n\tdeclare protected $MsSqlViewBrand: 'MsSqlView';\n\n\t[MsSqlViewConfig]: ViewBuilderConfig | undefined;\n\n\tconstructor({ mssqlConfig, config }: {\n\t\tmssqlConfig: ViewBuilderConfig | undefined;\n\t\tconfig: {\n\t\t\tname: TName;\n\t\t\tschema: string | undefined;\n\t\t\tselectedFields: SelectedFields;\n\t\t\tquery: SQL | undefined;\n\t\t};\n\t}) {\n\t\tsuper(config);\n\t\tthis[MsSqlViewConfig] = mssqlConfig;\n\t}\n}\n\nexport type MsSqlViewWithSelection<\n\tTName extends string,\n\tTExisting extends boolean,\n\tTSelectedFields extends ColumnsSelection,\n> = MsSqlView<TName, TExisting, TSelectedFields> & TSelectedFields;\n\n/** @internal */\nexport function mssqlViewWithSchema(\n\tname: string,\n\tselection: Record<string, ColumnBuilderBase> | undefined,\n\tschema: string | undefined,\n): ViewBuilder | ManualViewBuilder {\n\tif (selection) {\n\t\treturn new ManualViewBuilder(name, selection, schema);\n\t}\n\treturn new ViewBuilder(name, schema);\n}\n\nexport function mssqlView<TName extends string>(name: TName): ViewBuilder<TName>;\nexport function mssqlView<TName extends string, TColumns extends Record<string, ColumnBuilderBase>>(\n\tname: TName,\n\tcolumns: TColumns,\n): ManualViewBuilder<TName, TColumns>;\nexport function mssqlView(\n\tname: string,\n\tselection?: Record<string, ColumnBuilderBase>,\n): ViewBuilder | ManualViewBuilder {\n\treturn mssqlViewWithSchema(name, selection, undefined);\n}\n"],"mappings":";;;;;;;;;;AAqBA,IAAa,kBAAb,MAAkF;CACjF,QAAiBA,0BAAsB;CAOvC,YACC,AAAUC,MACV,AAAUC,QACT;EAFS;EACA;;CAGX,AAAU,SAA4B;EACrC,YAAY;EACZ,eAAe;EACf,cAAc;EACd;CAED,KACC,QACO;AACP,OAAK,OAAO,aAAa,QAAQ;AACjC,OAAK,OAAO,gBAAgB,QAAQ;AACpC,OAAK,OAAO,eAAe,QAAQ;AACnC,OAAK,OAAO,cAAc,QAAQ;AAClC,SAAO;;;AAIT,IAAa,cAAb,cAAgE,gBAAiC;CAChG,QAA0BF,0BAAsB;CAEhD,GACC,IAC6F;AAC7F,MAAI,OAAO,OAAO,WACjB,MAAK,GAAG,IAAIG,8DAAc,CAAC;EAE5B,MAAM,iBAAiB,IAAIC,2CAAuC;GACjE,OAAO,KAAK;GACZ,aAAa;GACb,oBAAoB;GACpB,qBAAqB;GACrB,CAAC;EACF,MAAM,mBAAmB,IAAI,MAAM,GAAG,mBAAmB,EAAE,eAAe;AAC1E,SAAO,IAAI,MACV,IAAI,UAAU;GACb,aAAa,KAAK;GAClB,QAAQ;IACP,MAAM,KAAK;IACX,QAAQ,KAAK;IACb,gBAAgB;IAChB,OAAO,GAAG,QAAQ,CAAC,cAAc;IACjC;GACD,CAAC,EACF,eACA;;;AAIH,IAAa,oBAAb,cAGU,gBAAoD;CAC7D,QAA0BJ,0BAAsB;CAEhD,AAAQ;CAER,YACC,MACA,SACA,QACC;AACD,QAAM,MAAM,OAAO;AACnB,OAAK,0CAA0BK,oCAAW,MAAM,QAAQ,CAAC;;CAG1D,WAAwF;AACvF,SAAO,IAAI,MACV,IAAI,UAAU;GACb,aAAa;GACb,QAAQ;IACP,MAAM,KAAK;IACX,QAAQ,KAAK;IACb,gBAAgB,KAAK;IACrB,OAAO;IACP;GACD,CAAC,EACF,IAAID,2CAAsB;GACzB,OAAO,KAAK;GACZ,aAAa;GACb,oBAAoB;GACpB,qBAAqB;GACrB,CAAC,CACF;;CAGF,GAAG,OAA0F;AAC5F,SAAO,IAAI,MACV,IAAI,UAAU;GACb,aAAa,KAAK;GAClB,QAAQ;IACP,MAAM,KAAK;IACX,QAAQ,KAAK;IACb,gBAAgB,KAAK;IACrB,OAAO,MAAM,cAAc;IAC3B;GACD,CAAC,EACF,IAAIA,2CAAsB;GACzB,OAAO,KAAK;GACZ,aAAa;GACb,oBAAoB;GACpB,qBAAqB;GACrB,CAAC,CACF;;;AAIH,IAAa,YAAb,cAIUE,2CAAiD;CAC1D,QAA0BN,0BAAsB;CAIhD,CAACO;CAED,YAAY,EAAE,aAAa,UAQxB;AACF,QAAM,OAAO;AACb,OAAKA,kDAAmB;;;;AAW1B,SAAgB,oBACf,MACA,WACA,QACkC;AAClC,KAAI,UACH,QAAO,IAAI,kBAAkB,MAAM,WAAW,OAAO;AAEtD,QAAO,IAAI,YAAY,MAAM,OAAO;;AAQrC,SAAgB,UACf,MACA,WACkC;AAClC,QAAO,oBAAoB,MAAM,WAAW,OAAU"}