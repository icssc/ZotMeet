{"version":3,"file":"vector.js","names":[],"sources":["../../../src/singlestore-core/columns/vector.ts"],"sourcesContent":["import type { HasGenerated } from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { SingleStoreTable } from '~/singlestore-core/table.ts';\nimport type { SQL } from '~/sql/sql.ts';\nimport { type Equal, getColumnNameAndConfig } from '~/utils.ts';\nimport { SingleStoreColumn, SingleStoreColumnBuilder, type SingleStoreGeneratedColumnConfig } from './common.ts';\n\nexport class SingleStoreVectorBuilder extends SingleStoreColumnBuilder<{\n\tdataType: 'array vector';\n\tdata: Array<number>;\n\tdriverParam: string | Buffer;\n\tisLengthExact: true;\n}, { length: number; isLengthExact: true; elementType?: Exclude<ElementType, 'I64'> }> {\n\tstatic override readonly [entityKind]: string = 'SingleStoreVectorBuilder';\n\n\tconstructor(name: string, config: SingleStoreVectorConfig) {\n\t\tsuper(name, 'array vector', 'SingleStoreVector');\n\t\tthis.config.length = config.dimensions;\n\t\tthis.config.elementType = config.elementType as Exclude<ElementType, 'I64'> | undefined;\n\t\tthis.config.isLengthExact = true;\n\t}\n\n\t/** @internal */\n\toverride build(table: SingleStoreTable) {\n\t\treturn new SingleStoreVector(\n\t\t\ttable,\n\t\t\tthis.config as any,\n\t\t);\n\t}\n\n\t/** @internal */\n\toverride generatedAlwaysAs(\n\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\t\tas: SQL | (() => SQL) | this['_']['data'],\n\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\t\tconfig?: Partial<SingleStoreGeneratedColumnConfig>,\n\t): HasGenerated<this, { type: 'always' }> {\n\t\tthrow new Error('Method not implemented.');\n\t}\n}\n\nexport class SingleStoreVector<T extends ColumnBaseConfig<'array vector'>>\n\textends SingleStoreColumn<T, { length: number; elementType?: Exclude<ElementType, 'I64'> }>\n{\n\tstatic override readonly [entityKind]: string = 'SingleStoreVector';\n\n\treadonly elementType: Exclude<ElementType, 'I64'> | undefined = this.config.elementType;\n\n\tgetSQLType(): string {\n\t\treturn `vector(${this.config.length}, ${this.elementType || 'F32'})`;\n\t}\n\n\toverride mapToDriverValue(value: Array<number>): string {\n\t\treturn `[${value.map((e) => e.toString()).join(',')}]`;\n\t}\n\n\toverride mapFromDriverValue(value: string | Buffer | Array<number>): Array<number> {\n\t\tif (typeof value === 'string') {\n\t\t\tif (value.startsWith('[')) return value.slice(1, -1).split(',').map(Number);\n\n\t\t\tvalue = Buffer.from(value, 'hex');\n\t\t}\n\n\t\tif (Buffer.isBuffer(value)) {\n\t\t\tconst type = this.elementType || 'F32';\n\t\t\tconst bytearr = new Uint8Array(value);\n\t\t\tswitch (type) {\n\t\t\t\tcase 'I8': {\n\t\t\t\t\t// eslint-disable-next-line unicorn/prefer-spread\n\t\t\t\t\treturn Array.from(new Int8Array(bytearr.buffer, 0, bytearr.length / 1));\n\t\t\t\t}\n\t\t\t\tcase 'I16': {\n\t\t\t\t\t// eslint-disable-next-line unicorn/prefer-spread\n\t\t\t\t\treturn Array.from(new Int16Array(bytearr.buffer, 0, bytearr.length / 2));\n\t\t\t\t}\n\t\t\t\tcase 'I32': {\n\t\t\t\t\t// eslint-disable-next-line unicorn/prefer-spread\n\t\t\t\t\treturn Array.from(new Int32Array(bytearr.buffer, 0, bytearr.length / 4));\n\t\t\t\t}\n\t\t\t\tcase 'F32': {\n\t\t\t\t\t// eslint-disable-next-line unicorn/prefer-spread\n\t\t\t\t\treturn Array.from(new Float32Array(bytearr.buffer, 0, bytearr.length / 4));\n\t\t\t\t}\n\t\t\t\tcase 'F64': {\n\t\t\t\t\t// eslint-disable-next-line unicorn/prefer-spread\n\t\t\t\t\treturn Array.from(new Float64Array(bytearr.buffer, 0, bytearr.length / 8));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn value;\n\t}\n}\n\nexport class SingleStoreBigIntVectorBuilder extends SingleStoreColumnBuilder<{\n\tdataType: 'array int64vector';\n\tdata: Array<bigint>;\n\tdriverParam: string | Buffer;\n\tisLengthExact: true;\n}, { length: number; isLengthExact: true }> {\n\tstatic override readonly [entityKind]: string = 'SingleStoreBigIntVectorBuilder';\n\n\tconstructor(name: string, config: SingleStoreVectorConfig) {\n\t\tsuper(name, 'array int64vector', 'SingleStoreBigIntVector');\n\t\tthis.config.length = config.dimensions;\n\t\tthis.config.isLengthExact = true;\n\t}\n\n\t/** @internal */\n\toverride build(table: SingleStoreTable) {\n\t\treturn new SingleStoreBigIntVector(\n\t\t\ttable,\n\t\t\tthis.config as any,\n\t\t);\n\t}\n\n\t/** @internal */\n\toverride generatedAlwaysAs(\n\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\t\tas: SQL | (() => SQL) | this['_']['data'],\n\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\t\tconfig?: Partial<SingleStoreGeneratedColumnConfig>,\n\t): HasGenerated<this, { type: 'always' }> {\n\t\tthrow new Error('Method not implemented.');\n\t}\n}\n\nexport class SingleStoreBigIntVector<T extends ColumnBaseConfig<'array int64vector'>>\n\textends SingleStoreColumn<T, { length: number }>\n{\n\tstatic override readonly [entityKind]: string = 'SingleStoreBigIntVector';\n\n\treadonly elementType = 'I64';\n\n\tgetSQLType(): string {\n\t\treturn `vector(${this.config.length}, ${this.elementType})`;\n\t}\n\n\toverride mapToDriverValue(value: Array<bigint>): string {\n\t\treturn `[${value.map((e) => e.toString()).join(',')}]`;\n\t}\n\n\toverride mapFromDriverValue(value: string | Buffer | Array<bigint>): Array<bigint> {\n\t\tif (typeof value === 'string') {\n\t\t\tif (value.startsWith('[')) return value.slice(1, -1).split(',').map(BigInt);\n\n\t\t\tvalue = Buffer.from(value, 'hex');\n\t\t}\n\n\t\tif (Buffer.isBuffer(value)) {\n\t\t\tconst bytearr = new Uint8Array(value);\n\t\t\t// eslint-disable-next-line unicorn/prefer-spread\n\t\t\treturn Array.from(new BigInt64Array(bytearr.buffer, 0, bytearr.length / 8));\n\t\t}\n\n\t\treturn value;\n\t}\n}\n\ntype ElementType = 'I8' | 'I16' | 'I32' | 'I64' | 'F32' | 'F64';\n\nexport interface SingleStoreVectorConfig<TType extends ElementType | undefined = ElementType | undefined> {\n\tdimensions: number;\n\telementType?: TType;\n}\n\nexport function vector<TType extends ElementType | undefined>(\n\tconfig: SingleStoreVectorConfig<TType>,\n): Equal<TType, 'I64'> extends true ? SingleStoreBigIntVectorBuilder : SingleStoreVectorBuilder;\nexport function vector<TType extends ElementType | undefined>(\n\tname: string,\n\tconfig: SingleStoreVectorConfig<TType>,\n): Equal<TType, 'I64'> extends true ? SingleStoreBigIntVectorBuilder : SingleStoreVectorBuilder;\nexport function vector(a: string | SingleStoreVectorConfig, b?: SingleStoreVectorConfig) {\n\tconst { name, config } = getColumnNameAndConfig<SingleStoreVectorConfig>(a, b);\n\treturn config.elementType === 'I64'\n\t\t? new SingleStoreBigIntVectorBuilder(name, config)\n\t\t: new SingleStoreVectorBuilder(name, config);\n}\n"],"mappings":"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"}