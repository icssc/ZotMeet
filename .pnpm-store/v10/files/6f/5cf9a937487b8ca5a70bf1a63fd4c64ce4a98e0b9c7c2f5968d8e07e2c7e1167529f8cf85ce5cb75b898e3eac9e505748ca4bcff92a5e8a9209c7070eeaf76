const require_chunk = require('./chunk-CdAKIUsw.js');
require('./ddl-SsGc2gVn.js');
require('./grammar-B2XVJ90y.js');
const require_views = require('./views-BA7qJeG7.js');
require('./snapshot-BG6vPgbm.js');
require('./brace-expansion-BfFnz-Zg.js');
require('./pull-utils-DDU5rq0R.js');
require('./diff-ss2kcRXi.js');
require('./utils-node-C6Uy_GN3.js');
require('./prompts-CF9zxmUG.js');
require('./drizzle-BfPXPbBQ.js');
require('./drizzle-D-GiuQ98.js');

//#region src/cli/selector-ui.ts
var import_hanji$1 = require_views.require_hanji();

//#endregion
//#region src/cli/commands/push-postgres.ts
var import_hanji = require_views.require_hanji();
const identifier = (it) => {
	const { schema, name } = it;
	return `${schema && schema !== "public" ? `"${schema}".` : ""}"${name}"`;
};
const suggestions = async (db, jsonStatements) => {
	const grouped = [];
	const filtered = jsonStatements.filter((it) => {
		if (it.type === "drop_view" && it.cause) return false;
		if (it.type === "alter_column" && it.diff.generated) return false;
		return true;
	});
	for (const statement of filtered) {
		if (statement.type === "drop_table") {
			if ((await db.query(`select 1 from ${statement.key} limit 1`)).length > 0) grouped.push({ hint: `· You're about to delete non-empty ${statement.key} table` });
			continue;
		}
		if (statement.type === "drop_view" && statement.view.materialized) {
			const id = identifier(statement.view);
			if ((await db.query(`select 1 from ${id} limit 1`)).length === 0) continue;
			grouped.push({ hint: `· You're about to delete non-empty ${id} materialized view` });
			continue;
		}
		if (statement.type === "drop_column") {
			const column = statement.column;
			const id = identifier({
				schema: column.schema,
				name: column.table
			});
			if ((await db.query(`select 1 from ${id} limit 1`)).length === 0) continue;
			grouped.push({ hint: `· You're about to delete non-empty ${column.name} column in ${id} table` });
			continue;
		}
		if (statement.type === "drop_schema") {
			const res = await db.query(`select count(*) as count from information_schema.tables where table_schema = '${statement.name}';`);
			const count = Number(res[0].count);
			if (count === 0) continue;
			grouped.push({ hint: `· You're about to delete ${require_views.source_default.underline(statement.name)} schema with ${count} tables` });
			continue;
		}
		if (statement.type === "drop_pk") {
			const schema = statement.pk.schema ?? "public";
			const table = statement.pk.table;
			const id = `"${schema}"."${table}"`;
			if ((await db.query(`select 1 from ${id} limit 1`)).length === 0) continue;
			const hint = `· You're about to drop ${require_views.source_default.underline(id)} primary key, this statements may fail and your table may loose primary key`;
			if (statement.pk.nameExplicit) {
				grouped.push({ hint });
				continue;
			}
			const [{ name: pkName }] = await db.query(`
        SELECT constraint_name as name 
        FROM information_schema.table_constraints
        WHERE 
          table_schema = '${schema}'
          AND table_name = '${table}'
          AND constraint_type = 'PRIMARY KEY';`);
			grouped.push({
				hint,
				statement: `ALTER TABLE ${id} DROP CONSTRAINT "${pkName}"`
			});
			continue;
		}
		if (statement.type === "add_column" && statement.column.notNull && statement.column.default === null && !statement.column.generated && !statement.column.identity) {
			const column = statement.column;
			const id = identifier({
				schema: column.schema,
				name: column.table
			});
			if ((await db.query(`select 1 from ${id} limit 1`)).length === 0) continue;
			const hint = `· You're about to add not-null ${require_views.source_default.underline(statement.column.name)} column without default value to a non-empty ${id} table`;
			grouped.push({ hint });
			continue;
		}
		if (statement.type === "add_unique") {
			const unique = statement.unique;
			const id = identifier({
				schema: unique.schema,
				name: unique.table
			});
			if ((await db.query(`select 1 from ${id} limit 1`)).length === 0) continue;
			grouped.push({ hint: `· You're about to add ${require_views.source_default.underline(unique.name)} unique constraint to a non-empty ${id} table which may fail` });
			continue;
		}
	}
	return grouped;
};

//#endregion
exports.suggestions = suggestions;