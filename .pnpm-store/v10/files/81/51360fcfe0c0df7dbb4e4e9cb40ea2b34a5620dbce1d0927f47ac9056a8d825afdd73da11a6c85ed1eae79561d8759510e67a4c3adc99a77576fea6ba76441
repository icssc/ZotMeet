{"version":3,"file":"query-builder.js","names":[],"sources":["../../../src/mssql-core/query-builders/query-builder.ts"],"sourcesContent":["import { entityKind, is } from '~/entity.ts';\nimport { MsSqlDialect, type MsSqlDialectConfig } from '~/mssql-core/dialect.ts';\nimport type { WithSubqueryWithSelection } from '~/mssql-core/subquery.ts';\nimport type { TypedQueryBuilder } from '~/query-builders/query-builder.ts';\nimport { SelectionProxyHandler } from '~/selection-proxy.ts';\nimport type { ColumnsSelection } from '~/sql/sql.ts';\nimport { WithSubquery } from '~/subquery.ts';\nimport { MsSqlSelectBuilder } from './select.ts';\nimport type { SelectedFields } from './select.types.ts';\n\nexport class QueryBuilder {\n\tstatic readonly [entityKind]: string = 'MsSqlQueryBuilder';\n\n\tprivate dialect: MsSqlDialect | undefined;\n\tprivate dialectConfig: MsSqlDialectConfig | undefined;\n\n\tconstructor(dialect?: MsSqlDialect | MsSqlDialectConfig) {\n\t\tthis.dialect = is(dialect, MsSqlDialect) ? dialect : undefined;\n\t\tthis.dialectConfig = is(dialect, MsSqlDialect) ? undefined : dialect;\n\t}\n\n\t$with<TAlias extends string>(alias: TAlias) {\n\t\tconst queryBuilder = this;\n\n\t\treturn {\n\t\t\tas<TSelection extends ColumnsSelection>(\n\t\t\t\tqb: TypedQueryBuilder<TSelection> | ((qb: QueryBuilder) => TypedQueryBuilder<TSelection>),\n\t\t\t): WithSubqueryWithSelection<TSelection, TAlias> {\n\t\t\t\tif (typeof qb === 'function') {\n\t\t\t\t\tqb = qb(queryBuilder);\n\t\t\t\t}\n\n\t\t\t\treturn new Proxy(\n\t\t\t\t\tnew WithSubquery(qb.getSQL(), qb.getSelectedFields() as SelectedFields, alias, true),\n\t\t\t\t\tnew SelectionProxyHandler({ alias, sqlAliasedBehavior: 'alias', sqlBehavior: 'error' }),\n\t\t\t\t) as WithSubqueryWithSelection<TSelection, TAlias>;\n\t\t\t},\n\t\t};\n\t}\n\n\twith(...queries: WithSubquery[]) {\n\t\tconst self = this;\n\n\t\tfunction select(): MsSqlSelectBuilder<undefined, never, 'qb'>;\n\t\tfunction select<TSelection extends SelectedFields>(\n\t\t\tfields: TSelection,\n\t\t): MsSqlSelectBuilder<TSelection, never, 'qb'>;\n\t\tfunction select<TSelection extends SelectedFields>(\n\t\t\tfields?: TSelection,\n\t\t): MsSqlSelectBuilder<TSelection | undefined, never, 'qb'> {\n\t\t\treturn new MsSqlSelectBuilder({\n\t\t\t\tfields: fields ?? undefined,\n\t\t\t\tsession: undefined,\n\t\t\t\tdialect: self.getDialect(),\n\t\t\t\twithList: queries,\n\t\t\t});\n\t\t}\n\n\t\tfunction selectDistinct(): MsSqlSelectBuilder<undefined, never, 'qb'>;\n\t\tfunction selectDistinct<TSelection extends SelectedFields>(\n\t\t\tfields: TSelection,\n\t\t): MsSqlSelectBuilder<TSelection, never, 'qb'>;\n\t\tfunction selectDistinct<TSelection extends SelectedFields>(\n\t\t\tfields?: TSelection,\n\t\t): MsSqlSelectBuilder<TSelection | undefined, never, 'qb'> {\n\t\t\treturn new MsSqlSelectBuilder({\n\t\t\t\tfields: fields ?? undefined,\n\t\t\t\tsession: undefined,\n\t\t\t\tdialect: self.getDialect(),\n\t\t\t\twithList: queries,\n\t\t\t\tdistinct: true,\n\t\t\t});\n\t\t}\n\n\t\treturn { select, selectDistinct };\n\t}\n\n\tselect(): MsSqlSelectBuilder<undefined, never, 'qb'>;\n\tselect<TSelection extends SelectedFields>(fields: TSelection): MsSqlSelectBuilder<TSelection, never, 'qb'>;\n\tselect<TSelection extends SelectedFields>(\n\t\tfields?: TSelection,\n\t): MsSqlSelectBuilder<TSelection | undefined, never, 'qb'> {\n\t\treturn new MsSqlSelectBuilder({ fields: fields ?? undefined, session: undefined, dialect: this.getDialect() });\n\t}\n\n\tselectDistinct(): MsSqlSelectBuilder<undefined, never, 'qb'>;\n\tselectDistinct<TSelection extends SelectedFields>(\n\t\tfields: TSelection,\n\t): MsSqlSelectBuilder<TSelection, never, 'qb'>;\n\tselectDistinct<TSelection extends SelectedFields>(\n\t\tfields?: TSelection,\n\t): MsSqlSelectBuilder<TSelection | undefined, never, 'qb'> {\n\t\treturn new MsSqlSelectBuilder({\n\t\t\tfields: fields ?? undefined,\n\t\t\tsession: undefined,\n\t\t\tdialect: this.getDialect(),\n\t\t\tdistinct: true,\n\t\t});\n\t}\n\n\t// Lazy load dialect to avoid circular dependency\n\tprivate getDialect() {\n\t\tif (!this.dialect) {\n\t\t\tthis.dialect = new MsSqlDialect(this.dialectConfig);\n\t\t}\n\n\t\treturn this.dialect;\n\t}\n}\n"],"mappings":";;;;;;;AAUA,IAAa,eAAb,MAA0B;CACzB,QAAiB,cAAsB;CAEvC,AAAQ;CACR,AAAQ;CAER,YAAY,SAA6C;AACxD,OAAK,UAAU,GAAG,SAAS,aAAa,GAAG,UAAU;AACrD,OAAK,gBAAgB,GAAG,SAAS,aAAa,GAAG,SAAY;;CAG9D,MAA6B,OAAe;EAC3C,MAAM,eAAe;AAErB,SAAO,EACN,GACC,IACgD;AAChD,OAAI,OAAO,OAAO,WACjB,MAAK,GAAG,aAAa;AAGtB,UAAO,IAAI,MACV,IAAI,aAAa,GAAG,QAAQ,EAAE,GAAG,mBAAmB,EAAoB,OAAO,KAAK,EACpF,IAAI,sBAAsB;IAAE;IAAO,oBAAoB;IAAS,aAAa;IAAS,CAAC,CACvF;KAEF;;CAGF,KAAK,GAAG,SAAyB;EAChC,MAAM,OAAO;EAMb,SAAS,OACR,QAC0D;AAC1D,UAAO,IAAI,mBAAmB;IAC7B,QAAQ,UAAU;IAClB,SAAS;IACT,SAAS,KAAK,YAAY;IAC1B,UAAU;IACV,CAAC;;EAOH,SAAS,eACR,QAC0D;AAC1D,UAAO,IAAI,mBAAmB;IAC7B,QAAQ,UAAU;IAClB,SAAS;IACT,SAAS,KAAK,YAAY;IAC1B,UAAU;IACV,UAAU;IACV,CAAC;;AAGH,SAAO;GAAE;GAAQ;GAAgB;;CAKlC,OACC,QAC0D;AAC1D,SAAO,IAAI,mBAAmB;GAAE,QAAQ,UAAU;GAAW,SAAS;GAAW,SAAS,KAAK,YAAY;GAAE,CAAC;;CAO/G,eACC,QAC0D;AAC1D,SAAO,IAAI,mBAAmB;GAC7B,QAAQ,UAAU;GAClB,SAAS;GACT,SAAS,KAAK,YAAY;GAC1B,UAAU;GACV,CAAC;;CAIH,AAAQ,aAAa;AACpB,MAAI,CAAC,KAAK,QACT,MAAK,UAAU,IAAI,aAAa,KAAK,cAAc;AAGpD,SAAO,KAAK"}