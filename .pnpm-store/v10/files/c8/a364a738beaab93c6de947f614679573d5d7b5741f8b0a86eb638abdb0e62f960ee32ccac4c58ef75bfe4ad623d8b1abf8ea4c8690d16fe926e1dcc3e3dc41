{"version":3,"file":"patch-history-C8rMQUGm.js","names":[],"sources":["../src/adapters/lib/patch-history.ts"],"sourcesContent":["import { debug } from '../../lib/debug'\nimport type { Emitter } from '../../lib/emitter'\nimport { error } from '../../lib/errors'\nimport { resetQueues, spinQueueResetMutex } from '../../lib/queues/reset'\n\nexport type SearchParamsSyncEmitterEvents = { update: URLSearchParams }\n\nexport const historyUpdateMarker = '__nuqs__'\n\ndeclare global {\n  interface History {\n    nuqs?: {\n      version: string\n      adapters: string[]\n    }\n  }\n}\n\nexport function getSearchParams(url: string | URL): URLSearchParams {\n  if (url instanceof URL) {\n    return url.searchParams\n  }\n  if (url.startsWith('?')) {\n    return new URLSearchParams(url)\n  }\n  try {\n    return new URL(url, location.origin).searchParams\n  } catch {\n    return new URLSearchParams(url)\n  }\n}\n\nexport function shouldPatchHistory(adapter: string): boolean {\n  if (typeof history === 'undefined') {\n    return false\n  }\n  if (\n    history.nuqs?.version &&\n    history.nuqs.version !== '0.0.0-inject-version-here'\n  ) {\n    console.error(\n      error(409),\n      history.nuqs.version,\n      `0.0.0-inject-version-here`,\n      adapter\n    )\n    return false\n  }\n  if (history.nuqs?.adapters?.includes(adapter)) {\n    return false\n  }\n  return true\n}\n\nexport function markHistoryAsPatched(adapter: string): void {\n  history.nuqs = history.nuqs ?? {\n    // This will be replaced by the prepack script\n    version: '0.0.0-inject-version-here',\n    adapters: []\n  }\n  history.nuqs.adapters.push(adapter)\n}\n\nexport function patchHistory(\n  emitter: Emitter<SearchParamsSyncEmitterEvents>,\n  adapter: string\n): void {\n  if (!shouldPatchHistory(adapter)) {\n    return\n  }\n  let lastSearchSeen = typeof location === 'object' ? location.search : ''\n\n  emitter.on('update', search => {\n    const searchString = search.toString()\n    lastSearchSeen = searchString.length ? '?' + searchString : ''\n  })\n\n  window.addEventListener('popstate', () => {\n    lastSearchSeen = location.search\n    resetQueues()\n  })\n\n  debug(\n    '[nuqs %s] Patching history (%s adapter)',\n    '0.0.0-inject-version-here',\n    adapter\n  )\n  function sync(url: URL | string) {\n    spinQueueResetMutex()\n    try {\n      const newSearch = new URL(url, location.origin).search\n      if (newSearch === lastSearchSeen) {\n        return\n      }\n    } catch {}\n    try {\n      emitter.emit('update', getSearchParams(url))\n    } catch (e) {\n      console.error(e)\n    }\n  }\n  const originalPushState = history.pushState\n  const originalReplaceState = history.replaceState\n  history.pushState = function nuqs_pushState(state, marker, url) {\n    originalPushState.call(history, state, '', url)\n    if (url && marker !== historyUpdateMarker) {\n      sync(url)\n    }\n  }\n  history.replaceState = function nuqs_replaceState(state, marker, url) {\n    originalReplaceState.call(history, state, '', url)\n    if (url && marker !== historyUpdateMarker) {\n      sync(url)\n    }\n  }\n  markHistoryAsPatched(adapter)\n}\n"],"mappings":";;;;AAOA,MAAa,sBAAsB;AAWnC,SAAgB,gBAAgB,KAAoC;AAClE,KAAI,eAAe,IACjB,QAAO,IAAI;AAEb,KAAI,IAAI,WAAW,IAAI,CACrB,QAAO,IAAI,gBAAgB,IAAI;AAEjC,KAAI;AACF,SAAO,IAAI,IAAI,KAAK,SAAS,OAAO,CAAC;SAC/B;AACN,SAAO,IAAI,gBAAgB,IAAI;;;AAInC,SAAgB,mBAAmB,SAA0B;AAC3D,KAAI,OAAO,YAAY,YACrB,QAAO;AAET,KACE,QAAQ,MAAM,WACd,QAAQ,KAAK,YAAY,6BACzB;AACA,UAAQ,MACN,MAAM,IAAI,EACV,QAAQ,KAAK,SACb,6BACA,QACD;AACD,SAAO;;AAET,KAAI,QAAQ,MAAM,UAAU,SAAS,QAAQ,CAC3C,QAAO;AAET,QAAO;;AAGT,SAAgB,qBAAqB,SAAuB;AAC1D,SAAQ,OAAO,QAAQ,QAAQ;EAE7B,SAAS;EACT,UAAU,EAAE;EACb;AACD,SAAQ,KAAK,SAAS,KAAK,QAAQ;;AAGrC,SAAgB,aACd,SACA,SACM;AACN,KAAI,CAAC,mBAAmB,QAAQ,CAC9B;CAEF,IAAI,iBAAiB,OAAO,aAAa,WAAW,SAAS,SAAS;AAEtE,SAAQ,GAAG,WAAU,WAAU;EAC7B,MAAM,eAAe,OAAO,UAAU;AACtC,mBAAiB,aAAa,SAAS,MAAM,eAAe;GAC5D;AAEF,QAAO,iBAAiB,kBAAkB;AACxC,mBAAiB,SAAS;AAC1B,eAAa;GACb;AAEF,OACE,2CACA,6BACA,QACD;CACD,SAAS,KAAK,KAAmB;AAC/B,uBAAqB;AACrB,MAAI;AAEF,OADkB,IAAI,IAAI,KAAK,SAAS,OAAO,CAAC,WAC9B,eAChB;UAEI;AACR,MAAI;AACF,WAAQ,KAAK,UAAU,gBAAgB,IAAI,CAAC;WACrC,GAAG;AACV,WAAQ,MAAM,EAAE;;;CAGpB,MAAM,oBAAoB,QAAQ;CAClC,MAAM,uBAAuB,QAAQ;AACrC,SAAQ,YAAY,SAAS,eAAe,OAAO,QAAQ,KAAK;AAC9D,oBAAkB,KAAK,SAAS,OAAO,IAAI,IAAI;AAC/C,MAAI,OAAO,WAAW,oBACpB,MAAK,IAAI;;AAGb,SAAQ,eAAe,SAAS,kBAAkB,OAAO,QAAQ,KAAK;AACpE,uBAAqB,KAAK,SAAS,OAAO,IAAI,IAAI;AAClD,MAAI,OAAO,WAAW,oBACpB,MAAK,IAAI;;AAGb,sBAAqB,QAAQ"}