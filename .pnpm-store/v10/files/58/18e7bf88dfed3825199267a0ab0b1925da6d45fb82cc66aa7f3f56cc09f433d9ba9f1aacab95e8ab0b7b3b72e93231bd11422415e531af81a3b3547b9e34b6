{"version":3,"sources":["../../../src/next-devtools/server/attach-nodejs-debugger-middleware.ts"],"sourcesContent":["import { middlewareResponse } from './middleware-response'\nimport type { ServerResponse, IncomingMessage } from 'http'\nimport * as inspector from 'inspector'\n\nexport function getAttachNodejsDebuggerMiddleware() {\n  return async function (\n    req: IncomingMessage,\n    res: ServerResponse,\n    next: () => void\n  ): Promise<void> {\n    const { pathname } = new URL(`http://n${req.url}`)\n\n    if (pathname !== '/__nextjs_attach-nodejs-inspector') {\n      return next()\n    }\n\n    try {\n      const isInspecting = inspector.url() !== undefined\n      const debugPort = process.debugPort\n      if (!isInspecting) {\n        // Node.js will already log that the inspector is listening.\n        inspector.open(debugPort)\n      }\n\n      const inspectorURLRaw = inspector.url()\n      if (inspectorURLRaw === undefined) {\n        // could not open, possibly because already in use.\n        return middlewareResponse.badRequest(\n          res,\n          `Failed to open port \"${debugPort}\". Address may be already in use.`\n        )\n      }\n      const inspectorURL = new URL(inspectorURLRaw)\n\n      const debugInfoListResponse = await fetch(\n        `http://${inspectorURL.host}/json/list`\n      )\n      const debugInfoList = await debugInfoListResponse.json()\n      if (!Array.isArray(debugInfoList) || debugInfoList.length === 0) {\n        throw new Error('No debug targets found')\n      }\n\n      return middlewareResponse.json(res, debugInfoList[0].devtoolsFrontendUrl)\n    } catch (error) {\n      return middlewareResponse.internalServerError(res)\n    }\n  }\n}\n"],"names":["getAttachNodejsDebuggerMiddleware","req","res","next","pathname","URL","url","isInspecting","inspector","undefined","debugPort","process","open","inspectorURLRaw","middlewareResponse","badRequest","inspectorURL","debugInfoListResponse","fetch","host","debugInfoList","json","Array","isArray","length","Error","devtoolsFrontendUrl","error","internalServerError"],"mappings":";;;;+BAIgBA;;;eAAAA;;;;oCAJmB;qEAER;AAEpB,SAASA;IACd,OAAO,eACLC,GAAoB,EACpBC,GAAmB,EACnBC,IAAgB;QAEhB,MAAM,EAAEC,QAAQ,EAAE,GAAG,IAAIC,IAAI,CAAC,QAAQ,EAAEJ,IAAIK,GAAG,EAAE;QAEjD,IAAIF,aAAa,qCAAqC;YACpD,OAAOD;QACT;QAEA,IAAI;YACF,MAAMI,eAAeC,WAAUF,GAAG,OAAOG;YACzC,MAAMC,YAAYC,QAAQD,SAAS;YACnC,IAAI,CAACH,cAAc;gBACjB,4DAA4D;gBAC5DC,WAAUI,IAAI,CAACF;YACjB;YAEA,MAAMG,kBAAkBL,WAAUF,GAAG;YACrC,IAAIO,oBAAoBJ,WAAW;gBACjC,mDAAmD;gBACnD,OAAOK,sCAAkB,CAACC,UAAU,CAClCb,KACA,CAAC,qBAAqB,EAAEQ,UAAU,iCAAiC,CAAC;YAExE;YACA,MAAMM,eAAe,IAAIX,IAAIQ;YAE7B,MAAMI,wBAAwB,MAAMC,MAClC,CAAC,OAAO,EAAEF,aAAaG,IAAI,CAAC,UAAU,CAAC;YAEzC,MAAMC,gBAAgB,MAAMH,sBAAsBI,IAAI;YACtD,IAAI,CAACC,MAAMC,OAAO,CAACH,kBAAkBA,cAAcI,MAAM,KAAK,GAAG;gBAC/D,MAAM,qBAAmC,CAAnC,IAAIC,MAAM,2BAAV,qBAAA;2BAAA;gCAAA;kCAAA;gBAAkC;YAC1C;YAEA,OAAOX,sCAAkB,CAACO,IAAI,CAACnB,KAAKkB,aAAa,CAAC,EAAE,CAACM,mBAAmB;QAC1E,EAAE,OAAOC,OAAO;YACd,OAAOb,sCAAkB,CAACc,mBAAmB,CAAC1B;QAChD;IACF;AACF","ignoreList":[0]}