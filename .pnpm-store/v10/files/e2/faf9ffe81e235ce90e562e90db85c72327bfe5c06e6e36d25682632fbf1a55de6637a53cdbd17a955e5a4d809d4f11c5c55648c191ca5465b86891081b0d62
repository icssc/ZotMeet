{"version":3,"file":"migrator.cjs","names":["migrationQueries: MigrationMeta[]","fs","crypto","formatToMillis"],"sources":["../src/migrator.ts"],"sourcesContent":["import crypto from 'node:crypto';\nimport fs, { existsSync, readdirSync } from 'node:fs';\nimport { join } from 'node:path';\nimport { formatToMillis } from './migrator.utils';\n\nexport interface KitConfig {\n\tout: string;\n\tschema: string;\n}\n\nexport interface MigrationConfig {\n\tmigrationsFolder: string;\n\tmigrationsTable?: string;\n\tmigrationsSchema?: string;\n\t/** @internal */\n\tinit?: boolean;\n}\n\nexport interface MigrationMeta {\n\tsql: string[];\n\tfolderMillis: number;\n\thash: string;\n\tbps: boolean;\n}\n\nexport interface MigrationFromJournalConfig {\n\tmigrationsJournal: MigrationsJournal;\n\tmigrationsTable?: string;\n}\n\nexport type MigrationsJournal = {\n\tsql: string;\n\ttimestamp: number;\n}[];\n\n/** Only gets returned if migrator failed with `init: true` used by `drizzle-kit pull --init`*/\nexport interface MigratorInitFailResponse {\n\texitCode: 'databaseMigrations' | 'localMigrations';\n}\n\n/** Only gets returned if migrator failed with `init: true` used by `drizzle-kit pull --init`*/\nexport interface MigratorInitFailResponse {\n\texitCode: 'databaseMigrations' | 'localMigrations';\n}\n\nfunction readMigrationFilesOLD(config: MigrationConfig): MigrationMeta[] {\n\tconst migrationFolderTo = config.migrationsFolder;\n\n\tconst migrationQueries: MigrationMeta[] = [];\n\n\tconst journalPath = `${migrationFolderTo}/meta/_journal.json`;\n\n\tconst journalAsString = fs.readFileSync(journalPath).toString();\n\n\tconst journal = JSON.parse(journalAsString) as {\n\t\tentries: { idx: number; when: number; tag: string; breakpoints: boolean }[];\n\t};\n\n\tfor (const journalEntry of journal.entries) {\n\t\tconst migrationPath = `${migrationFolderTo}/${journalEntry.tag}.sql`;\n\n\t\ttry {\n\t\t\tconst query = fs.readFileSync(`${migrationFolderTo}/${journalEntry.tag}.sql`).toString();\n\n\t\t\tconst result = query.split('--> statement-breakpoint').map((it) => {\n\t\t\t\treturn it;\n\t\t\t});\n\n\t\t\tmigrationQueries.push({\n\t\t\t\tsql: result,\n\t\t\t\tbps: journalEntry.breakpoints,\n\t\t\t\tfolderMillis: journalEntry.when,\n\t\t\t\thash: crypto.createHash('sha256').update(query).digest('hex'),\n\t\t\t});\n\t\t} catch {\n\t\t\tthrow new Error(`No file ${migrationPath} found in ${migrationFolderTo} folder`);\n\t\t}\n\t}\n\n\treturn migrationQueries;\n}\n\nexport function readMigrationFiles(config: MigrationConfig): MigrationMeta[] {\n\tif (fs.existsSync(`${config.migrationsFolder}/meta/_journal.json`)) {\n\t\t// it means user has folders V2\n\t\t// we need to warn to up the folders version but still apply migrations\n\t\tconsole.log(\n\t\t\t'\\nWarning: We detected that you have old drizzle-kit migration folders. We suggest to upgrade drizzle-kit and run \"drizzle-kit up\"\\n',\n\t\t);\n\t\treturn readMigrationFilesOLD(config);\n\t}\n\n\tconst migrationFolderTo = config.migrationsFolder;\n\n\tconst migrationQueries: MigrationMeta[] = [];\n\n\tconst migrations = readdirSync(migrationFolderTo)\n\t\t.map((subdir) => ({ path: join(migrationFolderTo, subdir, 'migration.sql'), name: subdir }))\n\t\t.filter((it) => existsSync(it.path));\n\n\tmigrations.sort((a, b) => a.name.localeCompare(b.name));\n\n\tfor (const migration of migrations) {\n\t\tconst migrationPath = migration.path;\n\t\tconst migrationDate = migration.name.slice(0, 14);\n\n\t\tconst query = fs.readFileSync(migrationPath).toString();\n\n\t\tconst result = query.split('--> statement-breakpoint').map((it) => {\n\t\t\treturn it;\n\t\t});\n\n\t\tconst millis = formatToMillis(migrationDate);\n\n\t\tmigrationQueries.push({\n\t\t\tsql: result,\n\t\t\tbps: true,\n\t\t\tfolderMillis: millis,\n\t\t\thash: crypto.createHash('sha256').update(query).digest('hex'),\n\t\t});\n\t}\n\n\treturn migrationQueries;\n}\n"],"mappings":";;;;;;;;;AA6CA,SAAS,sBAAsB,QAA0C;CACxE,MAAM,oBAAoB,OAAO;CAEjC,MAAMA,mBAAoC,EAAE;CAE5C,MAAM,cAAc,GAAG,kBAAkB;CAEzC,MAAM,kBAAkBC,gBAAG,aAAa,YAAY,CAAC,UAAU;CAE/D,MAAM,UAAU,KAAK,MAAM,gBAAgB;AAI3C,MAAK,MAAM,gBAAgB,QAAQ,SAAS;EAC3C,MAAM,gBAAgB,GAAG,kBAAkB,GAAG,aAAa,IAAI;AAE/D,MAAI;GACH,MAAM,QAAQA,gBAAG,aAAa,GAAG,kBAAkB,GAAG,aAAa,IAAI,MAAM,CAAC,UAAU;GAExF,MAAM,SAAS,MAAM,MAAM,2BAA2B,CAAC,KAAK,OAAO;AAClE,WAAO;KACN;AAEF,oBAAiB,KAAK;IACrB,KAAK;IACL,KAAK,aAAa;IAClB,cAAc,aAAa;IAC3B,MAAMC,oBAAO,WAAW,SAAS,CAAC,OAAO,MAAM,CAAC,OAAO,MAAM;IAC7D,CAAC;UACK;AACP,SAAM,IAAI,MAAM,WAAW,cAAc,YAAY,kBAAkB,SAAS;;;AAIlF,QAAO;;AAGR,SAAgB,mBAAmB,QAA0C;AAC5E,KAAID,gBAAG,WAAW,GAAG,OAAO,iBAAiB,qBAAqB,EAAE;AAGnE,UAAQ,IACP,yIACA;AACD,SAAO,sBAAsB,OAAO;;CAGrC,MAAM,oBAAoB,OAAO;CAEjC,MAAMD,mBAAoC,EAAE;CAE5C,MAAM,sCAAyB,kBAAkB,CAC/C,KAAK,YAAY;EAAE,0BAAW,mBAAmB,QAAQ,gBAAgB;EAAE,MAAM;EAAQ,EAAE,CAC3F,QAAQ,+BAAkB,GAAG,KAAK,CAAC;AAErC,YAAW,MAAM,GAAG,MAAM,EAAE,KAAK,cAAc,EAAE,KAAK,CAAC;AAEvD,MAAK,MAAM,aAAa,YAAY;EACnC,MAAM,gBAAgB,UAAU;EAChC,MAAM,gBAAgB,UAAU,KAAK,MAAM,GAAG,GAAG;EAEjD,MAAM,QAAQC,gBAAG,aAAa,cAAc,CAAC,UAAU;EAEvD,MAAM,SAAS,MAAM,MAAM,2BAA2B,CAAC,KAAK,OAAO;AAClE,UAAO;IACN;EAEF,MAAM,SAASE,sCAAe,cAAc;AAE5C,mBAAiB,KAAK;GACrB,KAAK;GACL,KAAK;GACL,cAAc;GACd,MAAMD,oBAAO,WAAW,SAAS,CAAC,OAAO,MAAM,CAAC,OAAO,MAAM;GAC7D,CAAC;;AAGH,QAAO"}