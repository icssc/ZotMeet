{"version":3,"sources":["../../../../src/build/turbopack-analyze/index.ts"],"sourcesContent":["import type { NextConfigComplete } from '../../server/config-shared'\nimport type { __ApiPreviewProps } from '../../server/api-utils'\n\nimport path from 'path'\nimport { validateTurboNextConfig } from '../../lib/turbopack-warning'\nimport { isFileSystemCacheEnabledForBuild } from '../../shared/lib/turbopack/utils'\nimport { createDefineEnv, loadBindings } from '../swc'\nimport { isCI } from '../../server/ci-info'\nimport { backgroundLogCompilationEvents } from '../../shared/lib/turbopack/compilation-events'\nimport { getSupportedBrowsers } from '../utils'\nimport { normalizePath } from '../../lib/normalize-path'\nimport { PHASE_PRODUCTION_BUILD } from '../../shared/lib/constants'\n\nexport type AnalyzeContext = {\n  config: NextConfigComplete\n  distDir: string\n  dir: string\n  noMangling: boolean\n  appDirOnly: boolean\n}\n\nexport async function turbopackAnalyze(\n  analyzeContext: AnalyzeContext\n): Promise<{\n  duration: number\n  shutdownPromise: Promise<void>\n}> {\n  await validateTurboNextConfig({\n    dir: analyzeContext.dir,\n    configPhase: PHASE_PRODUCTION_BUILD,\n  })\n\n  const { config, dir, distDir, noMangling } = analyzeContext\n  const currentNodeJsVersion = process.versions.node\n\n  const startTime = process.hrtime()\n  const bindings = await loadBindings(config?.experimental?.useWasmBinary)\n  const dev = false\n\n  const supportedBrowsers = getSupportedBrowsers(dir, dev)\n\n  const persistentCaching = isFileSystemCacheEnabledForBuild(config)\n  const rootPath = config.turbopack?.root || config.outputFileTracingRoot || dir\n  const project = await bindings.turbo.createProject(\n    {\n      rootPath: config.turbopack?.root || config.outputFileTracingRoot || dir,\n      projectPath: normalizePath(path.relative(rootPath, dir) || '.'),\n      distDir,\n      nextConfig: config,\n      watch: {\n        enable: false,\n      },\n      dev,\n      env: process.env as Record<string, string>,\n      defineEnv: createDefineEnv({\n        isTurbopack: true,\n        config,\n        dev,\n        distDir,\n        projectPath: dir,\n        fetchCacheKeyPrefix: config.experimental.fetchCacheKeyPrefix,\n        hasRewrites: false,\n        // Implemented separately in Turbopack, doesn't have to be passed here.\n        middlewareMatchers: undefined,\n        rewrites: {\n          beforeFiles: [],\n          afterFiles: [],\n          fallback: [],\n        },\n      }),\n      buildId: 'analyze-build',\n      encryptionKey: '',\n      previewProps: {\n        previewModeId: '',\n        previewModeEncryptionKey: '',\n        previewModeSigningKey: '',\n      },\n      browserslistQuery: supportedBrowsers.join(', '),\n      noMangling,\n      writeRoutesHashesManifest: false,\n      currentNodeJsVersion,\n    },\n    {\n      persistentCaching,\n      memoryLimit: config.experimental?.turbopackMemoryLimit,\n      dependencyTracking: persistentCaching,\n      isCi: isCI,\n      isShortSession: true,\n    }\n  )\n\n  try {\n    backgroundLogCompilationEvents(project)\n\n    await project.writeAnalyzeData(analyzeContext.appDirOnly)\n\n    const shutdownPromise = project.shutdown()\n\n    const time = process.hrtime(startTime)\n    return {\n      duration: time[0] + time[1] / 1e9,\n      shutdownPromise,\n    }\n  } catch (err) {\n    await project.shutdown()\n    throw err\n  }\n}\n\nlet shutdownPromise: Promise<void> | undefined\nexport async function waitForShutdown(): Promise<void> {\n  if (shutdownPromise) {\n    await shutdownPromise\n  }\n}\n"],"names":["path","validateTurboNextConfig","isFileSystemCacheEnabledForBuild","createDefineEnv","loadBindings","isCI","backgroundLogCompilationEvents","getSupportedBrowsers","normalizePath","PHASE_PRODUCTION_BUILD","turbopackAnalyze","analyzeContext","config","dir","configPhase","distDir","noMangling","currentNodeJsVersion","process","versions","node","startTime","hrtime","bindings","experimental","useWasmBinary","dev","supportedBrowsers","persistentCaching","rootPath","turbopack","root","outputFileTracingRoot","project","turbo","createProject","projectPath","relative","nextConfig","watch","enable","env","defineEnv","isTurbopack","fetchCacheKeyPrefix","hasRewrites","middlewareMatchers","undefined","rewrites","beforeFiles","afterFiles","fallback","buildId","encryptionKey","previewProps","previewModeId","previewModeEncryptionKey","previewModeSigningKey","browserslistQuery","join","writeRoutesHashesManifest","memoryLimit","turbopackMemoryLimit","dependencyTracking","isCi","isShortSession","writeAnalyzeData","appDirOnly","shutdownPromise","shutdown","time","duration","err","waitForShutdown"],"mappings":"AAGA,OAAOA,UAAU,OAAM;AACvB,SAASC,uBAAuB,QAAQ,8BAA6B;AACrE,SAASC,gCAAgC,QAAQ,mCAAkC;AACnF,SAASC,eAAe,EAAEC,YAAY,QAAQ,SAAQ;AACtD,SAASC,IAAI,QAAQ,uBAAsB;AAC3C,SAASC,8BAA8B,QAAQ,gDAA+C;AAC9F,SAASC,oBAAoB,QAAQ,WAAU;AAC/C,SAASC,aAAa,QAAQ,2BAA0B;AACxD,SAASC,sBAAsB,QAAQ,6BAA4B;AAUnE,OAAO,eAAeC,iBACpBC,cAA8B;QAcMC,sBAMnBA,mBAGHA,oBAuCGA;IAzDjB,MAAMX,wBAAwB;QAC5BY,KAAKF,eAAeE,GAAG;QACvBC,aAAaL;IACf;IAEA,MAAM,EAAEG,MAAM,EAAEC,GAAG,EAAEE,OAAO,EAAEC,UAAU,EAAE,GAAGL;IAC7C,MAAMM,uBAAuBC,QAAQC,QAAQ,CAACC,IAAI;IAElD,MAAMC,YAAYH,QAAQI,MAAM;IAChC,MAAMC,WAAW,MAAMnB,aAAaQ,2BAAAA,uBAAAA,OAAQY,YAAY,qBAApBZ,qBAAsBa,aAAa;IACvE,MAAMC,MAAM;IAEZ,MAAMC,oBAAoBpB,qBAAqBM,KAAKa;IAEpD,MAAME,oBAAoB1B,iCAAiCU;IAC3D,MAAMiB,WAAWjB,EAAAA,oBAAAA,OAAOkB,SAAS,qBAAhBlB,kBAAkBmB,IAAI,KAAInB,OAAOoB,qBAAqB,IAAInB;IAC3E,MAAMoB,UAAU,MAAMV,SAASW,KAAK,CAACC,aAAa,CAChD;QACEN,UAAUjB,EAAAA,qBAAAA,OAAOkB,SAAS,qBAAhBlB,mBAAkBmB,IAAI,KAAInB,OAAOoB,qBAAqB,IAAInB;QACpEuB,aAAa5B,cAAcR,KAAKqC,QAAQ,CAACR,UAAUhB,QAAQ;QAC3DE;QACAuB,YAAY1B;QACZ2B,OAAO;YACLC,QAAQ;QACV;QACAd;QACAe,KAAKvB,QAAQuB,GAAG;QAChBC,WAAWvC,gBAAgB;YACzBwC,aAAa;YACb/B;YACAc;YACAX;YACAqB,aAAavB;YACb+B,qBAAqBhC,OAAOY,YAAY,CAACoB,mBAAmB;YAC5DC,aAAa;YACb,uEAAuE;YACvEC,oBAAoBC;YACpBC,UAAU;gBACRC,aAAa,EAAE;gBACfC,YAAY,EAAE;gBACdC,UAAU,EAAE;YACd;QACF;QACAC,SAAS;QACTC,eAAe;QACfC,cAAc;YACZC,eAAe;YACfC,0BAA0B;YAC1BC,uBAAuB;QACzB;QACAC,mBAAmB/B,kBAAkBgC,IAAI,CAAC;QAC1C3C;QACA4C,2BAA2B;QAC3B3C;IACF,GACA;QACEW;QACAiC,WAAW,GAAEjD,wBAAAA,OAAOY,YAAY,qBAAnBZ,sBAAqBkD,oBAAoB;QACtDC,oBAAoBnC;QACpBoC,MAAM3D;QACN4D,gBAAgB;IAClB;IAGF,IAAI;QACF3D,+BAA+B2B;QAE/B,MAAMA,QAAQiC,gBAAgB,CAACvD,eAAewD,UAAU;QAExD,MAAMC,kBAAkBnC,QAAQoC,QAAQ;QAExC,MAAMC,OAAOpD,QAAQI,MAAM,CAACD;QAC5B,OAAO;YACLkD,UAAUD,IAAI,CAAC,EAAE,GAAGA,IAAI,CAAC,EAAE,GAAG;YAC9BF;QACF;IACF,EAAE,OAAOI,KAAK;QACZ,MAAMvC,QAAQoC,QAAQ;QACtB,MAAMG;IACR;AACF;AAEA,IAAIJ;AACJ,OAAO,eAAeK;IACpB,IAAIL,iBAAiB;QACnB,MAAMA;IACR;AACF","ignoreList":[0]}