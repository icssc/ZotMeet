{"version":3,"sources":["../../../../src/server/lib/dev-bundler-service.ts"],"sourcesContent":["import type { IncomingMessage } from 'http'\nimport type { DevBundler } from './router-utils/setup-dev-bundler'\nimport type { WorkerRequestHandler } from './types'\n\nimport { LRUCache } from './lru-cache'\nimport { createRequestResponseMocks } from './mock-request'\nimport {\n  HMR_MESSAGE_SENT_TO_BROWSER,\n  type HmrMessageSentToBrowser,\n  type NextJsHotReloaderInterface,\n} from '../dev/hot-reloader-types'\n\n/**\n * The DevBundlerService provides an interface to perform tasks with the\n * bundler while in development.\n */\nexport class DevBundlerService {\n  public appIsrManifestInner: InstanceType<typeof LRUCache<boolean>>\n  public close: NextJsHotReloaderInterface['close']\n  public setCacheStatus: NextJsHotReloaderInterface['setCacheStatus']\n  public setReactDebugChannel: NextJsHotReloaderInterface['setReactDebugChannel']\n  public sendErrorsToBrowser: NextJsHotReloaderInterface['sendErrorsToBrowser']\n\n  constructor(\n    private readonly bundler: DevBundler,\n    private readonly handler: WorkerRequestHandler\n  ) {\n    this.appIsrManifestInner = new LRUCache(\n      8_000,\n\n      function length() {\n        return 16\n      }\n    )\n\n    const { hotReloader } = bundler\n\n    this.close = hotReloader.close.bind(hotReloader)\n    this.setCacheStatus = hotReloader.setCacheStatus.bind(hotReloader)\n    this.setReactDebugChannel =\n      hotReloader.setReactDebugChannel.bind(hotReloader)\n    this.sendErrorsToBrowser = hotReloader.sendErrorsToBrowser.bind(hotReloader)\n  }\n\n  public ensurePage: typeof this.bundler.hotReloader.ensurePage = async (\n    definition\n  ) => {\n    // TODO: remove after ensure is pulled out of server\n    return await this.bundler.hotReloader.ensurePage(definition)\n  }\n\n  public logErrorWithOriginalStack =\n    this.bundler.logErrorWithOriginalStack.bind(this.bundler)\n\n  public async getFallbackErrorComponents(url?: string) {\n    await this.bundler.hotReloader.buildFallbackError()\n    // Build the error page to ensure the fallback is built too.\n    // TODO: See if this can be moved into hotReloader or removed.\n    await this.bundler.hotReloader.ensurePage({\n      page: '/_error',\n      clientOnly: false,\n      definition: undefined,\n      url,\n    })\n  }\n\n  public async getCompilationError(page: string) {\n    const errors = await this.bundler.hotReloader.getCompilationErrors(page)\n    if (!errors) return\n\n    // Return the very first error we found.\n    return errors[0]\n  }\n\n  public async revalidate({\n    urlPath,\n    revalidateHeaders,\n    opts: revalidateOpts,\n  }: {\n    urlPath: string\n    revalidateHeaders: IncomingMessage['headers']\n    opts: any\n  }) {\n    const mocked = createRequestResponseMocks({\n      url: urlPath,\n      headers: revalidateHeaders,\n    })\n\n    await this.handler(mocked.req, mocked.res)\n    await mocked.res.hasStreamed\n\n    if (\n      mocked.res.getHeader('x-nextjs-cache') !== 'REVALIDATED' &&\n      mocked.res.statusCode !== 200 &&\n      !(mocked.res.statusCode === 404 && revalidateOpts.unstable_onlyGenerated)\n    ) {\n      throw new Error(`Invalid response ${mocked.res.statusCode}`)\n    }\n\n    return {}\n  }\n\n  public get appIsrManifest() {\n    const serializableManifest: Record<string, boolean> = {}\n\n    for (const [key, value] of this.appIsrManifestInner) {\n      serializableManifest[key] = value\n    }\n\n    return serializableManifest\n  }\n\n  public setIsrStatus(key: string, value: boolean | undefined) {\n    if (value === undefined) {\n      this.appIsrManifestInner.remove(key)\n    } else {\n      this.appIsrManifestInner.set(key, value)\n    }\n\n    // Only send the ISR manifest to legacy clients, i.e. Pages Router clients,\n    // or App Router clients that have Cache Components disabled. The ISR\n    // manifest is only used to inform the static indicator, which currently\n    // does not provide useful information if Cache Components is enabled due to\n    // its binary nature (i.e. it does not support showing info for partially\n    // static pages).\n    this.bundler?.hotReloader?.sendToLegacyClients({\n      type: HMR_MESSAGE_SENT_TO_BROWSER.ISR_MANIFEST,\n      data: this.appIsrManifest,\n    })\n  }\n\n  public sendHmrMessage(message: HmrMessageSentToBrowser) {\n    this.bundler.hotReloader.send(message)\n  }\n}\n"],"names":["LRUCache","createRequestResponseMocks","HMR_MESSAGE_SENT_TO_BROWSER","DevBundlerService","constructor","bundler","handler","ensurePage","definition","hotReloader","logErrorWithOriginalStack","bind","appIsrManifestInner","length","close","setCacheStatus","setReactDebugChannel","sendErrorsToBrowser","getFallbackErrorComponents","url","buildFallbackError","page","clientOnly","undefined","getCompilationError","errors","getCompilationErrors","revalidate","urlPath","revalidateHeaders","opts","revalidateOpts","mocked","headers","req","res","hasStreamed","getHeader","statusCode","unstable_onlyGenerated","Error","appIsrManifest","serializableManifest","key","value","setIsrStatus","remove","set","sendToLegacyClients","type","ISR_MANIFEST","data","sendHmrMessage","message","send"],"mappings":"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","ignoreList":[0]}