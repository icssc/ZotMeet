{"version":3,"sources":["../../src/server/load-components.ts"],"sourcesContent":["import type { IncomingMessage, ServerResponse } from 'node:http'\nimport type {\n  AppType,\n  DocumentType,\n  NextComponentType,\n} from '../shared/lib/utils'\nimport type { ClientReferenceManifest } from '../build/webpack/plugins/flight-manifest-plugin'\nimport type {\n  PageConfig,\n  GetStaticPaths,\n  GetServerSideProps,\n  GetStaticProps,\n} from '../types'\nimport type { RouteModule } from './route-modules/route-module'\nimport type { BuildManifest } from './get-page-files'\nimport type { ActionManifest } from '../build/webpack/plugins/flight-client-entry-plugin'\n\nimport {\n  BUILD_MANIFEST,\n  REACT_LOADABLE_MANIFEST,\n  CLIENT_REFERENCE_MANIFEST,\n  SERVER_REFERENCE_MANIFEST,\n  DYNAMIC_CSS_MANIFEST,\n  SUBRESOURCE_INTEGRITY_MANIFEST,\n} from '../shared/lib/constants'\nimport { join } from 'path'\nimport { requirePage } from './require'\nimport { interopDefault } from '../lib/interop-default'\nimport { getTracer } from './lib/trace/tracer'\nimport { LoadComponentsSpan } from './lib/trace/constants'\nimport { evalManifest, loadManifest } from './load-manifest.external'\nimport { wait } from '../lib/wait'\nimport { setManifestsSingleton } from './app-render/manifests-singleton'\nimport type { DeepReadonly } from '../shared/lib/deep-readonly'\nimport { normalizePagePath } from '../shared/lib/page-path/normalize-page-path'\nimport { isStaticMetadataRoute } from '../lib/metadata/is-metadata-route'\n\nexport type ManifestItem = {\n  id: number | string\n  files: string[]\n}\n\nexport type ReactLoadableManifest = { [moduleId: string]: ManifestItem }\n/**\n * This manifest prevents removing server rendered <link> tags after client\n * navigation. This is only needed under `Pages dir && Production && Webpack`.\n * @see https://github.com/vercel/next.js/pull/72959\n */\nexport type DynamicCssManifest = string[]\n\n/**\n * A manifest entry type for the react-loadable-manifest.json.\n *\n * The whole manifest.json is a type of `Record<pathname, LoadableManifest>`\n * where pathname is a string-based key points to the path of the page contains\n * each dynamic imports.\n */\nexport interface LoadableManifest {\n  [k: string]: { id: string | number; files: string[] }\n}\n\nexport type GenericComponentMod = {\n  handler(\n    req: IncomingMessage,\n    res: ServerResponse,\n    ctx: {\n      waitUntil?: (prom: Promise<void>) => void\n    }\n  ): Promise<void | null>\n}\n\nexport type LoadComponentsReturnType<\n  NextModule extends GenericComponentMod = GenericComponentMod,\n> = {\n  Component: NextComponentType\n  pageConfig: PageConfig\n  buildManifest: DeepReadonly<BuildManifest>\n  subresourceIntegrityManifest?: DeepReadonly<Record<string, string>>\n  reactLoadableManifest: DeepReadonly<ReactLoadableManifest>\n  dynamicCssManifest?: DeepReadonly<DynamicCssManifest>\n  Document: DocumentType\n  App: AppType\n  getStaticProps?: GetStaticProps\n  getStaticPaths?: GetStaticPaths\n  getServerSideProps?: GetServerSideProps\n  ComponentMod: NextModule\n  routeModule: RouteModule\n  isAppPath?: boolean\n  page: string\n  multiZoneDraftMode?: boolean\n}\n\n/**\n * Load manifest file with retries, defaults to 3 attempts.\n */\nexport async function loadManifestWithRetries<T extends object>(\n  manifestPath: string,\n  attempts = 3\n) {\n  while (true) {\n    try {\n      return loadManifest<T>(manifestPath)\n    } catch (err) {\n      attempts--\n      if (attempts <= 0) throw err\n\n      await wait(100)\n    }\n  }\n}\n\n/**\n * Load manifest file with retries, defaults to 3 attempts, or return undefined.\n */\nexport async function tryLoadManifestWithRetries<T extends object>(\n  manifestPath: string,\n  attempts = 3\n) {\n  try {\n    return await loadManifestWithRetries<T>(manifestPath, attempts)\n  } catch (err) {\n    return undefined\n  }\n}\n\n/**\n * Load manifest file with retries, defaults to 3 attempts.\n */\nexport async function evalManifestWithRetries<T extends object>(\n  manifestPath: string,\n  attempts = 3\n) {\n  while (true) {\n    try {\n      return evalManifest<T>(manifestPath)\n    } catch (err) {\n      attempts--\n      if (attempts <= 0) throw err\n\n      await wait(100)\n    }\n  }\n}\n\nasync function tryLoadClientReferenceManifest(\n  manifestPath: string,\n  entryName: string,\n  attempts?: number\n) {\n  try {\n    const context = await evalManifestWithRetries<{\n      __RSC_MANIFEST: { [key: string]: ClientReferenceManifest }\n    }>(manifestPath, attempts)\n    return context.__RSC_MANIFEST[entryName]\n  } catch (err) {\n    return undefined\n  }\n}\n\nasync function loadComponentsImpl<\n  N extends GenericComponentMod = GenericComponentMod,\n>({\n  distDir,\n  page,\n  isAppPath,\n  isDev,\n  sriEnabled,\n  // When route modules are used, which is the case for the server calls to loadComponents, it no longer needs manifest to be loaded here.\n  // Static generation still needs the manifests to be loaded here.\n  // In the future static generation will also use route modules, and we will remove this flag.\n  needsManifestsForLegacyReasons,\n}: {\n  distDir: string\n  page: string\n  isAppPath: boolean\n  isDev: boolean\n  sriEnabled: boolean\n  needsManifestsForLegacyReasons: boolean\n}): Promise<LoadComponentsReturnType<N>> {\n  let DocumentMod = {}\n  let AppMod = {}\n  if (!isAppPath) {\n    ;[DocumentMod, AppMod] = await Promise.all([\n      requirePage('/_document', distDir, false),\n      requirePage('/_app', distDir, false),\n    ])\n  }\n\n  if (needsManifestsForLegacyReasons) {\n    // In dev mode we retry loading a manifest file to handle a race condition\n    // that can occur while app and pages are compiling at the same time, and the\n    // build-manifest is still being written to disk while an app path is\n    // attempting to load.\n    const manifestLoadAttempts = isDev ? 3 : 1\n\n    let reactLoadableManifestPath: string\n    if (!process.env.TURBOPACK) {\n      reactLoadableManifestPath = join(\n        /* turbopackIgnore: true */ distDir,\n        REACT_LOADABLE_MANIFEST\n      )\n    } else if (isAppPath) {\n      reactLoadableManifestPath = join(\n        /* turbopackIgnore: true */ distDir,\n        'server',\n        'app',\n        page,\n        REACT_LOADABLE_MANIFEST\n      )\n    } else {\n      reactLoadableManifestPath = join(\n        /* turbopackIgnore: true */ distDir,\n        'server',\n        'pages',\n        normalizePagePath(page),\n        REACT_LOADABLE_MANIFEST\n      )\n    }\n\n    // Make sure to avoid loading the manifest for static metadata routes for better performance.\n    const hasClientManifest = !isStaticMetadataRoute(page)\n\n    // Load the manifest files first\n    //\n    // Loading page-specific manifests shouldn't throw an error if the manifest couldn't be found, so\n    // that the `requirePage` call below will throw the correct error in that case\n    // (a `PageNotFoundError`).\n    const [\n      buildManifest,\n      reactLoadableManifest,\n      dynamicCssManifest,\n      clientReferenceManifest,\n      serverActionsManifest,\n      subresourceIntegrityManifest,\n    ] = await Promise.all([\n      loadManifestWithRetries<BuildManifest>(\n        join(/* turbopackIgnore: true */ distDir, BUILD_MANIFEST),\n        manifestLoadAttempts\n      ),\n      tryLoadManifestWithRetries<ReactLoadableManifest>(\n        reactLoadableManifestPath,\n        manifestLoadAttempts\n      ),\n      // This manifest will only exist in Pages dir && Production && Webpack.\n      isAppPath || process.env.TURBOPACK\n        ? undefined\n        : loadManifestWithRetries<DynamicCssManifest>(\n            join(\n              /* turbopackIgnore: true */ distDir,\n              `${DYNAMIC_CSS_MANIFEST}.json`\n            ),\n            manifestLoadAttempts\n          ).catch(() => undefined),\n      isAppPath && hasClientManifest\n        ? tryLoadClientReferenceManifest(\n            join(\n              /* turbopackIgnore: true */ distDir,\n              'server',\n              'app',\n              page.replace(/%5F/g, '_') +\n                '_' +\n                CLIENT_REFERENCE_MANIFEST +\n                '.js'\n            ),\n            page.replace(/%5F/g, '_'),\n            manifestLoadAttempts\n          )\n        : undefined,\n      isAppPath\n        ? loadManifestWithRetries<ActionManifest>(\n            join(\n              /* turbopackIgnore: true */ distDir,\n              'server',\n              SERVER_REFERENCE_MANIFEST + '.json'\n            ),\n            manifestLoadAttempts\n          ).catch(() => null)\n        : null,\n      sriEnabled\n        ? loadManifestWithRetries<DeepReadonly<Record<string, string>>>(\n            join(\n              /* turbopackIgnore: true */ distDir,\n              'server',\n              SUBRESOURCE_INTEGRITY_MANIFEST + '.json'\n            )\n          ).catch(() => undefined)\n        : undefined,\n    ])\n\n    // Before requiring the actual page module, we have to set the reference\n    // manifests to our global store so Server Action's encryption util can access\n    // to them at the top level of the page module.\n    if (serverActionsManifest && clientReferenceManifest) {\n      setManifestsSingleton({\n        page,\n        clientReferenceManifest,\n        serverActionsManifest,\n      })\n    }\n\n    const ComponentMod = await requirePage(page, distDir, isAppPath)\n\n    const Component = interopDefault(ComponentMod)\n    const Document = interopDefault(DocumentMod)\n    const App = interopDefault(AppMod)\n\n    const { getServerSideProps, getStaticProps, getStaticPaths, routeModule } =\n      ComponentMod\n\n    return {\n      App,\n      Document,\n      Component,\n      buildManifest,\n      subresourceIntegrityManifest,\n      reactLoadableManifest: reactLoadableManifest || {},\n      dynamicCssManifest,\n      pageConfig: ComponentMod.config || {},\n      ComponentMod,\n      getServerSideProps,\n      getStaticProps,\n      getStaticPaths,\n      isAppPath,\n      page,\n      routeModule,\n    }\n  } else {\n    const ComponentMod = await requirePage(page, distDir, isAppPath)\n\n    const Component = interopDefault(ComponentMod)\n    const Document = interopDefault(DocumentMod)\n    const App = interopDefault(AppMod)\n\n    const { getServerSideProps, getStaticProps, getStaticPaths, routeModule } =\n      ComponentMod\n\n    return {\n      App,\n      Document,\n      Component,\n      pageConfig: ComponentMod.config || {},\n      ComponentMod,\n      getServerSideProps,\n      getStaticProps,\n      getStaticPaths,\n      isAppPath,\n      page,\n      routeModule,\n    } as any // temporary `as any` to make TypeScript not fail so that the tests will run on the PR.\n  }\n}\n\nexport const loadComponents = getTracer().wrap(\n  LoadComponentsSpan.loadComponents,\n  loadComponentsImpl\n)\n"],"names":["evalManifestWithRetries","loadComponents","loadManifestWithRetries","tryLoadManifestWithRetries","manifestPath","attempts","loadManifest","err","wait","undefined","evalManifest","tryLoadClientReferenceManifest","entryName","context","__RSC_MANIFEST","loadComponentsImpl","distDir","page","isAppPath","isDev","sriEnabled","needsManifestsForLegacyReasons","DocumentMod","AppMod","Promise","all","requirePage","manifestLoadAttempts","reactLoadableManifestPath","process","env","TURBOPACK","join","REACT_LOADABLE_MANIFEST","normalizePagePath","hasClientManifest","isStaticMetadataRoute","buildManifest","reactLoadableManifest","dynamicCssManifest","clientReferenceManifest","serverActionsManifest","subresourceIntegrityManifest","BUILD_MANIFEST","DYNAMIC_CSS_MANIFEST","catch","replace","CLIENT_REFERENCE_MANIFEST","SERVER_REFERENCE_MANIFEST","SUBRESOURCE_INTEGRITY_MANIFEST","setManifestsSingleton","ComponentMod","Component","interopDefault","Document","App","getServerSideProps","getStaticProps","getStaticPaths","routeModule","pageConfig","config","getTracer","wrap","LoadComponentsSpan"],"mappings":"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","ignoreList":[0]}