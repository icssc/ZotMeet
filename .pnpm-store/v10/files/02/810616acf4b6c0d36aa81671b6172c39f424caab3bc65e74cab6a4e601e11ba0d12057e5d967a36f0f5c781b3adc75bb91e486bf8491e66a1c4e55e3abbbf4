{"version":3,"sources":["../../../../../../src/client/dev/hot-reloader/pages/websocket.ts"],"sourcesContent":["import { logQueue } from '../../../../next-devtools/userspace/app/forward-logs'\nimport {\n  HMR_MESSAGE_SENT_TO_BROWSER,\n  type HmrMessageSentToBrowser,\n} from '../../../../server/dev/hot-reloader-types'\nimport { getSocketUrl } from '../get-socket-url'\nimport { WEB_SOCKET_MAX_RECONNECTIONS } from '../../../../lib/constants'\n\nlet source: WebSocket\n\ntype MessageCallback = (message: HmrMessageSentToBrowser) => void\n\nconst messageCallbacks: Array<MessageCallback> = []\n\nexport function addMessageListener(callback: MessageCallback) {\n  messageCallbacks.push(callback)\n}\n\nexport function sendMessage(data: string) {\n  if (!source || source.readyState !== source.OPEN) return\n  return source.send(data)\n}\n\nlet reconnections = 0\nlet reloading = false\nlet serverSessionId: number | null = null\n\nexport function connectHMR(options: { path: string; assetPrefix: string }) {\n  let timer: ReturnType<typeof setTimeout>\n\n  function init() {\n    if (source) source.close()\n\n    function handleOnline() {\n      logQueue.onSocketReady(source)\n      reconnections = 0\n      window.console.log('[HMR] connected')\n    }\n\n    function handleMessage(event: MessageEvent<string>) {\n      // While the page is reloading, don't respond to any more messages.\n      // On reconnect, the server may send an empty list of changes if it was restarted.\n      if (reloading) {\n        return\n      }\n\n      const message: HmrMessageSentToBrowser = JSON.parse(event.data)\n\n      if (message.type === HMR_MESSAGE_SENT_TO_BROWSER.TURBOPACK_CONNECTED) {\n        if (\n          serverSessionId !== null &&\n          serverSessionId !== message.data.sessionId\n        ) {\n          // Either the server's session id has changed and it's a new server, or\n          // it's been too long since we disconnected and we should reload the page.\n          // There could be 1) unhandled server errors and/or 2) stale content.\n          // Perform a hard reload of the page.\n          window.location.reload()\n\n          reloading = true\n          return\n        }\n\n        serverSessionId = message.data.sessionId\n      }\n\n      for (const messageCallback of messageCallbacks) {\n        messageCallback(message)\n      }\n    }\n\n    function handleDisconnect() {\n      source.onerror = null\n      source.onclose = null\n      source.close()\n      reconnections++\n      // After 25 reconnects we'll want to reload the page as it indicates the dev server is no longer running.\n      if (reconnections > WEB_SOCKET_MAX_RECONNECTIONS) {\n        reloading = true\n        window.location.reload()\n        return\n      }\n\n      clearTimeout(timer)\n      // Try again after 5 seconds\n      timer = setTimeout(init, reconnections > 5 ? 5000 : 1000)\n    }\n\n    const url = getSocketUrl(options.assetPrefix)\n\n    source = new window.WebSocket(`${url}${options.path}`)\n    source.onopen = handleOnline\n    source.onerror = handleDisconnect\n    source.onclose = handleDisconnect\n    source.onmessage = handleMessage\n  }\n\n  init()\n}\n"],"names":["logQueue","HMR_MESSAGE_SENT_TO_BROWSER","getSocketUrl","WEB_SOCKET_MAX_RECONNECTIONS","source","messageCallbacks","addMessageListener","callback","push","sendMessage","data","readyState","OPEN","send","reconnections","reloading","serverSessionId","connectHMR","options","timer","init","close","handleOnline","onSocketReady","window","console","log","handleMessage","event","message","JSON","parse","type","TURBOPACK_CONNECTED","sessionId","location","reload","messageCallback","handleDisconnect","onerror","onclose","clearTimeout","setTimeout","url","assetPrefix","WebSocket","path","onopen","onmessage"],"mappings":"AAAA,SAASA,QAAQ,QAAQ,uDAAsD;AAC/E,SACEC,2BAA2B,QAEtB,4CAA2C;AAClD,SAASC,YAAY,QAAQ,oBAAmB;AAChD,SAASC,4BAA4B,QAAQ,4BAA2B;AAExE,IAAIC;AAIJ,MAAMC,mBAA2C,EAAE;AAEnD,OAAO,SAASC,mBAAmBC,QAAyB;IAC1DF,iBAAiBG,IAAI,CAACD;AACxB;AAEA,OAAO,SAASE,YAAYC,IAAY;IACtC,IAAI,CAACN,UAAUA,OAAOO,UAAU,KAAKP,OAAOQ,IAAI,EAAE;IAClD,OAAOR,OAAOS,IAAI,CAACH;AACrB;AAEA,IAAII,gBAAgB;AACpB,IAAIC,YAAY;AAChB,IAAIC,kBAAiC;AAErC,OAAO,SAASC,WAAWC,OAA8C;IACvE,IAAIC;IAEJ,SAASC;QACP,IAAIhB,QAAQA,OAAOiB,KAAK;QAExB,SAASC;YACPtB,SAASuB,aAAa,CAACnB;YACvBU,gBAAgB;YAChBU,OAAOC,OAAO,CAACC,GAAG,CAAC;QACrB;QAEA,SAASC,cAAcC,KAA2B;YAChD,mEAAmE;YACnE,kFAAkF;YAClF,IAAIb,WAAW;gBACb;YACF;YAEA,MAAMc,UAAmCC,KAAKC,KAAK,CAACH,MAAMlB,IAAI;YAE9D,IAAImB,QAAQG,IAAI,KAAK/B,4BAA4BgC,mBAAmB,EAAE;gBACpE,IACEjB,oBAAoB,QACpBA,oBAAoBa,QAAQnB,IAAI,CAACwB,SAAS,EAC1C;oBACA,uEAAuE;oBACvE,0EAA0E;oBAC1E,qEAAqE;oBACrE,qCAAqC;oBACrCV,OAAOW,QAAQ,CAACC,MAAM;oBAEtBrB,YAAY;oBACZ;gBACF;gBAEAC,kBAAkBa,QAAQnB,IAAI,CAACwB,SAAS;YAC1C;YAEA,KAAK,MAAMG,mBAAmBhC,iBAAkB;gBAC9CgC,gBAAgBR;YAClB;QACF;QAEA,SAASS;YACPlC,OAAOmC,OAAO,GAAG;YACjBnC,OAAOoC,OAAO,GAAG;YACjBpC,OAAOiB,KAAK;YACZP;YACA,yGAAyG;YACzG,IAAIA,gBAAgBX,8BAA8B;gBAChDY,YAAY;gBACZS,OAAOW,QAAQ,CAACC,MAAM;gBACtB;YACF;YAEAK,aAAatB;YACb,4BAA4B;YAC5BA,QAAQuB,WAAWtB,MAAMN,gBAAgB,IAAI,OAAO;QACtD;QAEA,MAAM6B,MAAMzC,aAAagB,QAAQ0B,WAAW;QAE5CxC,SAAS,IAAIoB,OAAOqB,SAAS,CAAC,GAAGF,MAAMzB,QAAQ4B,IAAI,EAAE;QACrD1C,OAAO2C,MAAM,GAAGzB;QAChBlB,OAAOmC,OAAO,GAAGD;QACjBlC,OAAOoC,OAAO,GAAGF;QACjBlC,OAAO4C,SAAS,GAAGrB;IACrB;IAEAP;AACF","ignoreList":[0]}