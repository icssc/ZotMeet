{"version":3,"sources":["../../../../src/server/dev/serialized-errors.ts"],"sourcesContent":["import { streamToUint8Array } from '../stream-utils/node-web-streams-helper'\nimport {\n  HMR_MESSAGE_SENT_TO_BROWSER,\n  type HmrMessageSentToBrowser,\n} from './hot-reloader-types'\n\nconst errorsRscStreamsByHtmlRequestId = new Map<\n  string,\n  ReadableStream<Uint8Array>\n>()\n\nexport function sendSerializedErrorsToClient(\n  errorsRscStream: ReadableStream<Uint8Array>,\n  sendToClient: (message: HmrMessageSentToBrowser) => void\n) {\n  streamToUint8Array(errorsRscStream).then(\n    (serializedErrors) => {\n      sendToClient({\n        type: HMR_MESSAGE_SENT_TO_BROWSER.ERRORS_TO_SHOW_IN_BROWSER,\n        serializedErrors,\n      })\n    },\n    (err) => {\n      console.error(new Error('Failed to serialize errors.', { cause: err }))\n    }\n  )\n}\n\nexport function sendSerializedErrorsToClientForHtmlRequest(\n  htmlRequestId: string,\n  sendToClient: (message: HmrMessageSentToBrowser) => void\n) {\n  const errorsRscStream = errorsRscStreamsByHtmlRequestId.get(htmlRequestId)\n\n  if (!errorsRscStream) {\n    return\n  }\n\n  errorsRscStreamsByHtmlRequestId.delete(htmlRequestId)\n\n  sendSerializedErrorsToClient(errorsRscStream, sendToClient)\n}\n\nexport function setErrorsRscStreamForHtmlRequest(\n  htmlRequestId: string,\n  errorsRscStream: ReadableStream<Uint8Array>\n) {\n  // TODO: Clean up after a timeout, in case the client never connects, e.g.\n  // when CURL'ing the page, or loading the page with JavaScript disabled etc.\n  errorsRscStreamsByHtmlRequestId.set(htmlRequestId, errorsRscStream)\n}\n\nexport function deleteErrorsRscStreamForHtmlRequest(htmlRequestId: string) {\n  errorsRscStreamsByHtmlRequestId.delete(htmlRequestId)\n}\n"],"names":["streamToUint8Array","HMR_MESSAGE_SENT_TO_BROWSER","errorsRscStreamsByHtmlRequestId","Map","sendSerializedErrorsToClient","errorsRscStream","sendToClient","then","serializedErrors","type","ERRORS_TO_SHOW_IN_BROWSER","err","console","error","Error","cause","sendSerializedErrorsToClientForHtmlRequest","htmlRequestId","get","delete","setErrorsRscStreamForHtmlRequest","set","deleteErrorsRscStreamForHtmlRequest"],"mappings":"AAAA,SAASA,kBAAkB,QAAQ,0CAAyC;AAC5E,SACEC,2BAA2B,QAEtB,uBAAsB;AAE7B,MAAMC,kCAAkC,IAAIC;AAK5C,OAAO,SAASC,6BACdC,eAA2C,EAC3CC,YAAwD;IAExDN,mBAAmBK,iBAAiBE,IAAI,CACtC,CAACC;QACCF,aAAa;YACXG,MAAMR,4BAA4BS,yBAAyB;YAC3DF;QACF;IACF,GACA,CAACG;QACCC,QAAQC,KAAK,CAAC,qBAAwD,CAAxD,IAAIC,MAAM,+BAA+B;YAAEC,OAAOJ;QAAI,IAAtD,qBAAA;mBAAA;wBAAA;0BAAA;QAAuD;IACvE;AAEJ;AAEA,OAAO,SAASK,2CACdC,aAAqB,EACrBX,YAAwD;IAExD,MAAMD,kBAAkBH,gCAAgCgB,GAAG,CAACD;IAE5D,IAAI,CAACZ,iBAAiB;QACpB;IACF;IAEAH,gCAAgCiB,MAAM,CAACF;IAEvCb,6BAA6BC,iBAAiBC;AAChD;AAEA,OAAO,SAASc,iCACdH,aAAqB,EACrBZ,eAA2C;IAE3C,0EAA0E;IAC1E,4EAA4E;IAC5EH,gCAAgCmB,GAAG,CAACJ,eAAeZ;AACrD;AAEA,OAAO,SAASiB,oCAAoCL,aAAqB;IACvEf,gCAAgCiB,MAAM,CAACF;AACzC","ignoreList":[0]}