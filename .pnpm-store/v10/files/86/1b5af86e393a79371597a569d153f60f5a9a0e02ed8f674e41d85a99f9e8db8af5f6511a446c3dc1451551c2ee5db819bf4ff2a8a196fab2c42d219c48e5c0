{"version":3,"sources":["../../src/telemetry/detached-flush.ts"],"sourcesContent":["import fs from 'fs'\nimport path from 'path'\nimport type { TelemetryEvent } from './storage'\nimport { Telemetry } from './storage'\nimport loadConfig from '../server/config'\nimport { getProjectDir } from '../lib/get-project-dir'\nimport { PHASE_DEVELOPMENT_SERVER } from '../shared/lib/constants'\n\n// this process should be started with following arg order\n// 1. mode e.g. dev, export, start\n// 2. project dir\n// 3. events filename (optional, defaults to _events.json)\n;(async () => {\n  const args = [...process.argv]\n  const eventsFile = args.pop()\n  let dir = args.pop()\n  const mode = args.pop()\n\n  if (!dir || mode !== 'dev') {\n    throw new Error(\n      `Invalid flags should be run as node detached-flush dev ./path-to/project [eventsFile]`\n    )\n  }\n  dir = getProjectDir(dir)\n\n  const config = await loadConfig(PHASE_DEVELOPMENT_SERVER, dir)\n  const distDir = path.join(dir, config.distDir || '.next')\n  // Support both old format (no eventsFile arg) and new format (with eventsFile arg)\n  const eventsPath = path.join(\n    distDir,\n    eventsFile && !eventsFile.includes('/') ? eventsFile : '_events.json'\n  )\n\n  let events: TelemetryEvent[]\n  try {\n    events = JSON.parse(fs.readFileSync(eventsPath, 'utf8'))\n  } catch (err: any) {\n    if (err.code === 'ENOENT') {\n      // no events to process we can exit now\n      process.exit(0)\n    }\n    throw err\n  }\n\n  const telemetry = new Telemetry({ distDir })\n  await telemetry.record(events)\n  await telemetry.flush()\n\n  // finished flushing events clean-up\n  fs.unlinkSync(eventsPath)\n  // Don't call process.exit() here - let Node.js exit naturally after\n  // all pending work completes (e.g., setTimeout in debug telemetry)\n})()\n"],"names":["args","process","argv","eventsFile","pop","dir","mode","Error","getProjectDir","config","loadConfig","PHASE_DEVELOPMENT_SERVER","distDir","path","join","eventsPath","includes","events","JSON","parse","fs","readFileSync","err","code","exit","telemetry","Telemetry","record","flush","unlinkSync"],"mappings":";;;;2DAAe;6DACE;yBAES;+DACH;+BACO;2BACW;;;;;;AAMvC,CAAA;IACA,MAAMA,OAAO;WAAIC,QAAQC,IAAI;KAAC;IAC9B,MAAMC,aAAaH,KAAKI,GAAG;IAC3B,IAAIC,MAAML,KAAKI,GAAG;IAClB,MAAME,OAAON,KAAKI,GAAG;IAErB,IAAI,CAACC,OAAOC,SAAS,OAAO;QAC1B,MAAM,qBAEL,CAFK,IAAIC,MACR,CAAC,qFAAqF,CAAC,GADnF,qBAAA;mBAAA;wBAAA;0BAAA;QAEN;IACF;IACAF,MAAMG,IAAAA,4BAAa,EAACH;IAEpB,MAAMI,SAAS,MAAMC,IAAAA,eAAU,EAACC,mCAAwB,EAAEN;IAC1D,MAAMO,UAAUC,aAAI,CAACC,IAAI,CAACT,KAAKI,OAAOG,OAAO,IAAI;IACjD,mFAAmF;IACnF,MAAMG,aAAaF,aAAI,CAACC,IAAI,CAC1BF,SACAT,cAAc,CAACA,WAAWa,QAAQ,CAAC,OAAOb,aAAa;IAGzD,IAAIc;IACJ,IAAI;QACFA,SAASC,KAAKC,KAAK,CAACC,WAAE,CAACC,YAAY,CAACN,YAAY;IAClD,EAAE,OAAOO,KAAU;QACjB,IAAIA,IAAIC,IAAI,KAAK,UAAU;YACzB,uCAAuC;YACvCtB,QAAQuB,IAAI,CAAC;QACf;QACA,MAAMF;IACR;IAEA,MAAMG,YAAY,IAAIC,kBAAS,CAAC;QAAEd;IAAQ;IAC1C,MAAMa,UAAUE,MAAM,CAACV;IACvB,MAAMQ,UAAUG,KAAK;IAErB,oCAAoC;IACpCR,WAAE,CAACS,UAAU,CAACd;AACd,oEAAoE;AACpE,mEAAmE;AACrE,CAAA","ignoreList":[0]}