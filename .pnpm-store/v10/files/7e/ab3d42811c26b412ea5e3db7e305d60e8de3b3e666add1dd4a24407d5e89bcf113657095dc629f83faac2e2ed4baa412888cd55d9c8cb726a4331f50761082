{"version":3,"sources":["../../../../src/server/lib/router-utils/cache-life-type-utils.ts"],"sourcesContent":["import type { CacheLife } from '../../use-cache/cache-life'\nimport fs from 'fs'\nimport path from 'path'\n\nconst MINUTE_IN_SECONDS = 60\nconst HOUR_IN_SECONDS = MINUTE_IN_SECONDS * 60 // nevermind leap seconds\nconst DAY_IN_SECONDS = HOUR_IN_SECONDS * 24\nconst WEEK_IN_SECONDS = DAY_IN_SECONDS * 7\n// Nevermind leap years, or you know, July\nconst MONTH_30_DAYS_IN_SECONDS = DAY_IN_SECONDS * 30\n\nfunction formatTimespan(seconds: number): string {\n  if (seconds > 0) {\n    if (seconds === MONTH_30_DAYS_IN_SECONDS) {\n      return '1 month'\n    }\n    if (seconds === WEEK_IN_SECONDS) {\n      return '1 week'\n    }\n    if (seconds === DAY_IN_SECONDS) {\n      return '1 day'\n    }\n    if (seconds === HOUR_IN_SECONDS) {\n      return '1 hour'\n    }\n    if (seconds === MINUTE_IN_SECONDS) {\n      return '1 minute'\n    }\n    if (seconds % MONTH_30_DAYS_IN_SECONDS === 0) {\n      return seconds / MONTH_30_DAYS_IN_SECONDS + ' months'\n    }\n    if (seconds % 18144000 === 0) {\n      return seconds / 18144000 + ' months'\n    }\n    if (seconds % WEEK_IN_SECONDS === 0) {\n      return seconds / WEEK_IN_SECONDS + ' weeks'\n    }\n    if (seconds % DAY_IN_SECONDS === 0) {\n      return seconds / DAY_IN_SECONDS + ' days'\n    }\n    if (seconds % HOUR_IN_SECONDS === 0) {\n      return seconds / HOUR_IN_SECONDS + ' hours'\n    }\n    if (seconds % MINUTE_IN_SECONDS === 0) {\n      return seconds / MINUTE_IN_SECONDS + ' minutes'\n    }\n  }\n  return seconds + ' seconds'\n}\n\nfunction formatTimespanWithSeconds(seconds: undefined | number): string {\n  if (seconds === undefined) {\n    return 'default'\n  }\n  if (seconds >= 0xfffffffe) {\n    return 'never'\n  }\n  const text = seconds + ' seconds'\n  const descriptive = formatTimespan(seconds)\n  if (descriptive === text) {\n    return text\n  }\n  return text + ' (' + descriptive + ')'\n}\n\n/**\n * Generates TypeScript type definitions for custom cacheLife profiles.\n * This creates overloaded function signatures for the cacheLife() function\n * that provide autocomplete and documentation for each profile.\n */\nexport function generateCacheLifeTypes(cacheLife: {\n  [profile: string]: CacheLife\n}): string {\n  let overloads = ''\n\n  const profileNames = Object.keys(cacheLife)\n  for (let i = 0; i < profileNames.length; i++) {\n    const profileName = profileNames[i]\n    const profile = cacheLife[profileName]\n    if (typeof profile !== 'object' || profile === null) {\n      continue\n    }\n\n    let description = ''\n\n    if (profile.stale === undefined) {\n      description += `\n     * This cache may be stale on clients for the default stale time of the scope before checking with the server.`\n    } else if (profile.stale >= 0xfffffffe) {\n      description += `\n     * This cache may be stale on clients indefinitely before checking with the server.`\n    } else {\n      description += `\n     * This cache may be stale on clients for ${formatTimespan(profile.stale)} before checking with the server.`\n    }\n    if (\n      profile.revalidate !== undefined &&\n      profile.expire !== undefined &&\n      profile.revalidate >= profile.expire\n    ) {\n      description += `\n     * This cache will expire after ${formatTimespan(profile.expire)}. The next request will recompute it.`\n    } else {\n      if (profile.revalidate === undefined) {\n        description += `\n     * It will inherit the default revalidate time of its scope since it does not define its own.`\n      } else if (profile.revalidate >= 0xfffffffe) {\n        // Nothing to mention.\n      } else {\n        description += `\n     * If the server receives a new request after ${formatTimespan(profile.revalidate)}, start revalidating new values in the background.`\n      }\n      if (profile.expire === undefined) {\n        description += `\n     * It will inherit the default expiration time of its scope since it does not define its own.`\n      } else if (profile.expire >= 0xfffffffe) {\n        description += `\n     * It lives for the maximum age of the server cache. If this entry has no traffic for a while, it may serve an old value the next request.`\n      } else {\n        description += `\n     * If this entry has no traffic for ${formatTimespan(profile.expire)} it will expire. The next request will recompute it.`\n      }\n    }\n\n    overloads += `\n    /**\n     * Cache this \\`\"use cache\"\\` for a timespan defined by the \\`${JSON.stringify(profileName)}\\` profile.\n     * \\`\\`\\`\n     *   stale:      ${formatTimespanWithSeconds(profile.stale)}\n     *   revalidate: ${formatTimespanWithSeconds(profile.revalidate)}\n     *   expire:     ${formatTimespanWithSeconds(profile.expire)}\n     * \\`\\`\\`\n     * ${description}\n     */\n    export function cacheLife(profile: ${JSON.stringify(profileName)}): void\n    `\n  }\n\n  overloads += `\n    /**\n     * Cache this \\`\"use cache\"\\` using a custom timespan.\n     * \\`\\`\\`\n     *   stale: ... // seconds\n     *   revalidate: ... // seconds\n     *   expire: ... // seconds\n     * \\`\\`\\`\n     *\n     * This is similar to Cache-Control: max-age=\\`stale\\`,s-max-age=\\`revalidate\\`,stale-while-revalidate=\\`expire-revalidate\\`\n     *\n     * If a value is left out, the lowest of other cacheLife() calls or the default, is used instead.\n     */\n    export function cacheLife(profile: {\n      /**\n       * This cache may be stale on clients for ... seconds before checking with the server.\n       */\n      stale?: number,\n      /**\n       * If the server receives a new request after ... seconds, start revalidating new values in the background.\n       */\n      revalidate?: number,\n      /**\n       * If this entry has no traffic for ... seconds it will expire. The next request will recompute it.\n       */\n      expire?: number\n    }): void\n  `\n\n  // Redefine the cacheLife() accepted arguments.\n  return `// Type definitions for Next.js cacheLife configs\n\ndeclare module 'next/cache' {\n  export { unstable_cache } from 'next/dist/server/web/spec-extension/unstable-cache'\n  export {\n    updateTag,\n    revalidateTag,\n    revalidatePath,\n    refresh,\n  } from 'next/dist/server/web/spec-extension/revalidate'\n  export { unstable_noStore } from 'next/dist/server/web/spec-extension/unstable-no-store'\n\n  ${overloads}\n\n  import { cacheTag } from 'next/dist/server/use-cache/cache-tag'\n  export { cacheTag }\n\n  export const unstable_cacheTag: typeof cacheTag\n  export const unstable_cacheLife: typeof cacheLife\n}\n`\n}\n\n/**\n * Writes cache-life type definitions to a file if cacheLifeConfig exists.\n * This is used by both the CLI (next type-gen) and dev server to generate\n * cache-life.d.ts in the types directory.\n */\nexport function writeCacheLifeTypes(\n  cacheLifeConfig: undefined | { [profile: string]: CacheLife },\n  filePath: string\n) {\n  if (!cacheLifeConfig || Object.keys(cacheLifeConfig).length === 0) {\n    return\n  }\n\n  const dirname = path.dirname(filePath)\n\n  if (!fs.existsSync(dirname)) {\n    fs.mkdirSync(dirname, { recursive: true })\n  }\n\n  const content = generateCacheLifeTypes(cacheLifeConfig)\n  fs.writeFileSync(filePath, content)\n}\n"],"names":["generateCacheLifeTypes","writeCacheLifeTypes","MINUTE_IN_SECONDS","HOUR_IN_SECONDS","DAY_IN_SECONDS","WEEK_IN_SECONDS","MONTH_30_DAYS_IN_SECONDS","formatTimespan","seconds","formatTimespanWithSeconds","undefined","text","descriptive","cacheLife","overloads","profileNames","Object","keys","i","length","profileName","profile","description","stale","revalidate","expire","JSON","stringify","cacheLifeConfig","filePath","dirname","path","fs","existsSync","mkdirSync","recursive","content","writeFileSync"],"mappings":"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","ignoreList":[0]}