{"version":3,"file":"session.cjs","names":["SQLiteSession","entityKind","client: TSQL","relations: TRelations","schema: V1.RelationalSchemaConfig<TSchema> | undefined","options: BunSQLiteSessionOptions","NoopLogger","NoopCache","DrizzleError","SQLiteTransaction","SQLitePreparedQuery","client: BunSQL","logger: Logger","fields: SelectedFieldsOrdered | undefined","_isResponseInArrayMode: boolean","customResultMapper?: (\n\t\t\trows: TIsRqbV2 extends true ? Record<string, unknown>[] : unknown[][],\n\t\t\tmapColumnValue?: (value: unknown) => unknown,\n\t\t) => unknown","isRqbV2Query?: TIsRqbV2"],"sources":["../../../src/bun-sql/sqlite/session.ts"],"sourcesContent":["/// <reference types=\"bun-types\" />\n\nimport type { SavepointSQL, SQL as BunSQL, TransactionSQL } from 'bun';\nimport type * as V1 from '~/_relations.ts';\nimport { type Cache, NoopCache } from '~/cache/core/index.ts';\nimport type { WithCacheConfig } from '~/cache/core/types.ts';\nimport { entityKind } from '~/entity.ts';\nimport { DrizzleError } from '~/errors.ts';\nimport type { Logger } from '~/logger.ts';\nimport { NoopLogger } from '~/logger.ts';\nimport type { AnyRelations } from '~/relations.ts';\nimport { fillPlaceholders, type Query, type SQL } from '~/sql/sql.ts';\nimport type { SQLiteAsyncDialect } from '~/sqlite-core/dialect.ts';\nimport { SQLiteTransaction } from '~/sqlite-core/index.ts';\nimport type { SelectedFieldsOrdered } from '~/sqlite-core/query-builders/select.types.ts';\nimport type {\n\tPreparedQueryConfig as PreparedQueryConfigBase,\n\tResult,\n\tSQLiteExecuteMethod,\n\tSQLiteTransactionConfig,\n} from '~/sqlite-core/session.ts';\nimport { SQLitePreparedQuery, SQLiteSession } from '~/sqlite-core/session.ts';\nimport { mapResultRow } from '~/utils.ts';\n\nexport interface BunSQLiteSessionOptions {\n\tlogger?: Logger;\n\tcache?: Cache;\n}\n\nexport type BunSQLiteRunResult = Record<string, unknown>[] & Record<string, unknown>;\n\ntype PreparedQueryConfig = Omit<PreparedQueryConfigBase, 'statement' | 'run'>;\n\nexport class BunSQLiteSession<\n\tTSQL extends BunSQL,\n\tTFullSchema extends Record<string, unknown>,\n\tTRelations extends AnyRelations,\n\tTSchema extends V1.TablesRelationalConfig,\n> extends SQLiteSession<'async', BunSQLiteRunResult, TFullSchema, TRelations, TSchema> {\n\tstatic override readonly [entityKind]: string = 'BunSQLiteSession';\n\n\tprivate logger: Logger;\n\tprivate cache: Cache;\n\n\tconstructor(\n\t\treadonly client: TSQL,\n\t\tdialect: SQLiteAsyncDialect,\n\t\tprivate relations: TRelations,\n\t\tprivate schema: V1.RelationalSchemaConfig<TSchema> | undefined,\n\t\treadonly options: BunSQLiteSessionOptions,\n\t) {\n\t\tsuper(dialect);\n\t\tthis.logger = options.logger ?? new NoopLogger();\n\t\tthis.cache = options.cache ?? new NoopCache();\n\t}\n\n\tprepareQuery<T extends Omit<PreparedQueryConfig, 'run'>>(\n\t\tquery: Query,\n\t\tfields: SelectedFieldsOrdered | undefined,\n\t\texecuteMethod: SQLiteExecuteMethod,\n\t\tisResponseInArrayMode: boolean,\n\t\tcustomResultMapper?: (rows: unknown[][]) => unknown,\n\t\tqueryMetadata?: {\n\t\t\ttype: 'select' | 'update' | 'delete' | 'insert';\n\t\t\ttables: string[];\n\t\t},\n\t\tcacheConfig?: WithCacheConfig,\n\t): BunSQLitePreparedQuery<T> {\n\t\treturn new BunSQLitePreparedQuery(\n\t\t\tthis.client,\n\t\t\tquery,\n\t\t\tthis.logger,\n\t\t\tthis.cache,\n\t\t\tqueryMetadata,\n\t\t\tcacheConfig,\n\t\t\tfields,\n\t\t\texecuteMethod,\n\t\t\tisResponseInArrayMode,\n\t\t\tcustomResultMapper,\n\t\t);\n\t}\n\n\tprepareRelationalQuery<T extends Omit<PreparedQueryConfig, 'run'>>(\n\t\tquery: Query,\n\t\tfields: SelectedFieldsOrdered | undefined,\n\t\texecuteMethod: SQLiteExecuteMethod,\n\t\tcustomResultMapper: (rows: Record<string, unknown>[]) => unknown,\n\t): BunSQLitePreparedQuery<T, true> {\n\t\treturn new BunSQLitePreparedQuery(\n\t\t\tthis.client,\n\t\t\tquery,\n\t\t\tthis.logger,\n\t\t\tthis.cache,\n\t\t\tundefined,\n\t\t\tundefined,\n\t\t\tfields,\n\t\t\texecuteMethod,\n\t\t\tfalse,\n\t\t\tcustomResultMapper,\n\t\t\ttrue,\n\t\t);\n\t}\n\n\toverride async run(query: SQL): Result<'async', BunSQLiteRunResult> {\n\t\tconst staticQuery = this.dialect.sqlToQuery(query);\n\t\ttry {\n\t\t\treturn await this.prepareOneTimeQuery(staticQuery, undefined, 'run', false).run() as Result<\n\t\t\t\t'async',\n\t\t\t\tBunSQLiteRunResult\n\t\t\t>;\n\t\t} catch (err) {\n\t\t\tthrow new DrizzleError({ cause: err, message: `Failed to run the query '${staticQuery.sql}'` });\n\t\t}\n\t}\n\n\toverride async transaction<T>(\n\t\ttransaction: (db: BunSQLiteTransaction<TFullSchema, TRelations, TSchema>) => T | Promise<T>,\n\t\tconfig?: SQLiteTransactionConfig,\n\t): Promise<T> {\n\t\treturn this.client.begin(config?.behavior ?? '', async (client) => {\n\t\t\tconst session = new BunSQLiteSession<SavepointSQL, TFullSchema, TRelations, TSchema>(\n\t\t\t\tclient,\n\t\t\t\tthis.dialect,\n\t\t\t\tthis.relations,\n\t\t\t\tthis.schema,\n\t\t\t\tthis.options,\n\t\t\t);\n\t\t\tconst tx = new BunSQLiteTransaction<TFullSchema, TRelations, TSchema>(\n\t\t\t\t'async',\n\t\t\t\tthis.dialect,\n\t\t\t\tsession,\n\t\t\t\tthis.relations,\n\t\t\t\tthis.schema,\n\t\t\t);\n\n\t\t\treturn await transaction(tx);\n\t\t}) as Promise<T>;\n\t}\n}\n\nexport class BunSQLiteTransaction<\n\tTFullSchema extends Record<string, unknown>,\n\tTRelations extends AnyRelations,\n\tTSchema extends V1.TablesRelationalConfig,\n> extends SQLiteTransaction<'async', BunSQLiteRunResult, TFullSchema, TRelations, TSchema> {\n\tstatic override readonly [entityKind]: string = 'BunSQLiteTransaction';\n\n\toverride async transaction<T>(\n\t\ttransaction: (tx: BunSQLiteTransaction<TFullSchema, TRelations, TSchema>) => Promise<T>,\n\t): Promise<T> {\n\t\treturn (<BunSQLiteSession<TransactionSQL, any, any, any>> <unknown> this.session).client.savepoint(\n\t\t\tasync (client) => {\n\t\t\t\tconst session = new BunSQLiteSession<SavepointSQL, TFullSchema, TRelations, TSchema>(\n\t\t\t\t\tclient,\n\t\t\t\t\tthis.session.dialect,\n\t\t\t\t\tthis.relations,\n\t\t\t\t\tthis.schema,\n\t\t\t\t\t(<BunSQLiteSession<TransactionSQL, any, any, any>> <unknown> this.session).options,\n\t\t\t\t);\n\t\t\t\tconst tx = new BunSQLiteTransaction(\n\t\t\t\t\t'async',\n\t\t\t\t\tthis.dialect,\n\t\t\t\t\tsession,\n\t\t\t\t\tthis.relations,\n\t\t\t\t\tthis.schema,\n\t\t\t\t\tthis.nestedIndex + 1,\n\t\t\t\t);\n\t\t\t\treturn await transaction(tx);\n\t\t\t},\n\t\t);\n\t}\n}\n\nexport class BunSQLitePreparedQuery<\n\tT extends PreparedQueryConfig = PreparedQueryConfig,\n\tTIsRqbV2 extends boolean = false,\n> extends SQLitePreparedQuery<\n\t{\n\t\ttype: 'async';\n\t\trun: BunSQLiteRunResult;\n\t\tall: T['all'];\n\t\tget: T['get'];\n\t\tvalues: T['values'];\n\t\texecute: T['execute'];\n\t}\n> {\n\tstatic override readonly [entityKind]: string = 'BunSQLitePreparedQuery';\n\n\tconstructor(\n\t\tprivate client: BunSQL,\n\t\tquery: Query,\n\t\tprivate logger: Logger,\n\t\tcache: Cache,\n\t\tqueryMetadata: {\n\t\t\ttype: 'select' | 'update' | 'delete' | 'insert';\n\t\t\ttables: string[];\n\t\t} | undefined,\n\t\tcacheConfig: WithCacheConfig | undefined,\n\t\t/** @internal */ public fields: SelectedFieldsOrdered | undefined,\n\t\texecuteMethod: SQLiteExecuteMethod,\n\t\tprivate _isResponseInArrayMode: boolean,\n\t\tprivate customResultMapper?: (\n\t\t\trows: TIsRqbV2 extends true ? Record<string, unknown>[] : unknown[][],\n\t\t\tmapColumnValue?: (value: unknown) => unknown,\n\t\t) => unknown,\n\t\tprivate isRqbV2Query?: TIsRqbV2,\n\t) {\n\t\tsuper('async', executeMethod, query, cache, queryMetadata, cacheConfig);\n\t}\n\n\tasync run(placeholderValues: Record<string, unknown> = {}): Promise<BunSQLiteRunResult> {\n\t\tconst { logger, query, client } = this;\n\t\tconst params = fillPlaceholders(query.params, placeholderValues);\n\t\tlogger.logQuery(query.sql, params);\n\n\t\treturn await this.queryWithCache(query.sql, params, async () => {\n\t\t\treturn await client.unsafe(query.sql, params);\n\t\t});\n\t}\n\n\tasync all(placeholderValues: Record<string, unknown> = {}): Promise<T['all']> {\n\t\tif (this.isRqbV2Query) return this.allRqbV2(placeholderValues);\n\t\tconst { logger, query, fields, joinsNotNullableMap, customResultMapper, client } = this;\n\n\t\tif (!fields && !customResultMapper) {\n\t\t\tconst params = fillPlaceholders(query.params, placeholderValues);\n\t\t\tlogger.logQuery(query.sql, params);\n\t\t\treturn await this.queryWithCache(query.sql, params, async () => {\n\t\t\t\tconst res = await client.unsafe(query.sql, params);\n\t\t\t\treturn res;\n\t\t\t});\n\t\t}\n\n\t\tconst rows = await this.values(placeholderValues) as unknown[][];\n\n\t\tif (customResultMapper) {\n\t\t\treturn (customResultMapper as (\n\t\t\t\trows: unknown[][],\n\t\t\t\tmapColumnValue?: (value: unknown) => unknown,\n\t\t\t) => unknown)(rows);\n\t\t}\n\n\t\treturn rows.map((row) => mapResultRow(fields!, row, joinsNotNullableMap));\n\t}\n\n\tprivate async allRqbV2(placeholderValues: Record<string, unknown> = {}): Promise<T['all']> {\n\t\tconst { logger, query, customResultMapper, client } = this;\n\t\tconst params = fillPlaceholders(query.params, placeholderValues);\n\t\tlogger.logQuery(query.sql, params);\n\n\t\tconst rows = await client.unsafe(query.sql, params);\n\n\t\treturn (customResultMapper as (\n\t\t\trows: unknown[][],\n\t\t\tmapColumnValue?: (value: unknown) => unknown,\n\t\t) => unknown)(rows);\n\t}\n\n\tasync get(placeholderValues: Record<string, unknown> = {}): Promise<T['get']> {\n\t\tif (this.isRqbV2Query) return this.getRqbV2(placeholderValues);\n\n\t\tconst { logger, query, fields, joinsNotNullableMap, customResultMapper, client } = this;\n\n\t\tif (!fields && !customResultMapper) {\n\t\t\tconst params = fillPlaceholders(query.params, placeholderValues);\n\t\t\tlogger.logQuery(query.sql, params);\n\t\t\treturn await this.queryWithCache(query.sql, params, async () => {\n\t\t\t\tconst rows = await client.unsafe(query.sql, params);\n\t\t\t\treturn rows[0];\n\t\t\t});\n\t\t}\n\n\t\tconst rows = await this.values(placeholderValues) as unknown[][];\n\t\tconst row = rows[0];\n\n\t\tif (customResultMapper) {\n\t\t\treturn (customResultMapper as (\n\t\t\t\trows: unknown[][],\n\t\t\t\tmapColumnValue?: (value: unknown) => unknown,\n\t\t\t) => unknown)(rows);\n\t\t}\n\n\t\tif (row === undefined) return row;\n\t\treturn mapResultRow(fields!, row, joinsNotNullableMap);\n\t}\n\n\tprivate async getRqbV2(placeholderValues: Record<string, unknown> = {}) {\n\t\tconst { logger, query, customResultMapper, client } = this;\n\t\tconst params = fillPlaceholders(query.params, placeholderValues);\n\n\t\tlogger.logQuery(query.sql, params);\n\t\tconst rows = await client.unsafe(query.sql, params);\n\t\tconst row = rows[0];\n\n\t\tif (row === undefined) return row;\n\n\t\treturn (customResultMapper as (\n\t\t\trows: unknown[][],\n\t\t\tmapColumnValue?: (value: unknown) => unknown,\n\t\t) => unknown)([row]);\n\t}\n\n\tasync values(placeholderValues: Record<string, unknown> = {}): Promise<T['values']> {\n\t\tconst {\n\t\t\tclient,\n\t\t\tlogger,\n\t\t\tquery,\n\t\t} = this;\n\t\tconst params = fillPlaceholders(query.params, placeholderValues);\n\n\t\tlogger.logQuery(query.sql, params);\n\t\treturn await this.queryWithCache(query.sql, params, async () => {\n\t\t\treturn await client.unsafe(query.sql, params).values();\n\t\t});\n\t}\n\n\t/** @internal */\n\tisResponseInArrayMode(): boolean {\n\t\treturn this._isResponseInArrayMode;\n\t}\n}\n"],"mappings":"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"}