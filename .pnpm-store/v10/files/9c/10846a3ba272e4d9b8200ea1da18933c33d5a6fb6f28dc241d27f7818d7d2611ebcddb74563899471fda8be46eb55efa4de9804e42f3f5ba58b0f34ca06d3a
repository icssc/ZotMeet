{"version":3,"file":"query.js","names":["listener: ReturnType<typeof addDatabaseChangeListener> | undefined","data"],"sources":["../../src/expo-sqlite/query.ts"],"sourcesContent":["import { addDatabaseChangeListener } from 'expo-sqlite';\nimport { useEffect, useState } from 'react';\nimport { is } from '~/entity.ts';\nimport { SQL } from '~/sql/sql.ts';\nimport type { AnySQLiteSelect } from '~/sqlite-core/index.ts';\nimport { getTableConfig, getViewConfig, SQLiteTable, SQLiteView } from '~/sqlite-core/index.ts';\nimport * as V1 from '~/sqlite-core/query-builders/_query.ts';\nimport { SQLiteRelationalQuery } from '~/sqlite-core/query-builders/query.ts';\nimport { Subquery } from '~/subquery.ts';\n\nexport const useLiveQuery = <\n\tT extends\n\t\t| Pick<AnySQLiteSelect, '_' | 'then'>\n\t\t| SQLiteRelationalQuery<'sync', unknown>\n\t\t| V1.SQLiteRelationalQuery<'sync', unknown>,\n>(\n\tquery: T,\n\tdeps: unknown[] = [],\n) => {\n\tconst [data, setData] = useState<Awaited<T>>(\n\t\t(is(query, V1.SQLiteRelationalQuery) || is(query, SQLiteRelationalQuery) && query.mode === 'first'\n\t\t\t? undefined\n\t\t\t: []) as Awaited<T>,\n\t);\n\tconst [error, setError] = useState<Error>();\n\tconst [updatedAt, setUpdatedAt] = useState<Date>();\n\n\tuseEffect(() => {\n\t\tconst entity = is(query, V1.SQLiteRelationalQuery) || is(query, SQLiteRelationalQuery)\n\t\t\t? query.table\n\t\t\t: (query as AnySQLiteSelect).config.table;\n\n\t\tif (is(entity, Subquery) || is(entity, SQL)) {\n\t\t\tsetError(new Error('Selecting from subqueries and SQL are not supported in useLiveQuery'));\n\t\t\treturn;\n\t\t}\n\n\t\tlet listener: ReturnType<typeof addDatabaseChangeListener> | undefined;\n\n\t\tconst handleData = (data: any) => {\n\t\t\tsetData(data);\n\t\t\tsetUpdatedAt(new Date());\n\t\t};\n\n\t\tquery.then(handleData).catch(setError);\n\n\t\tif (is(entity, SQLiteTable) || is(entity, SQLiteView)) {\n\t\t\tconst config = is(entity, SQLiteTable) ? getTableConfig(entity) : getViewConfig(entity);\n\t\t\tlistener = addDatabaseChangeListener(({ tableName }) => {\n\t\t\t\tif (config.name === tableName) {\n\t\t\t\t\tquery.then(handleData).catch(setError);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn () => {\n\t\t\tlistener?.remove();\n\t\t};\n\t}, deps);\n\n\treturn {\n\t\tdata,\n\t\terror,\n\t\tupdatedAt,\n\t} as const;\n};\n"],"mappings":";;;;;;;;;;AAUA,MAAa,gBAMZ,OACA,OAAkB,EAAE,KAChB;CACJ,MAAM,CAAC,MAAM,WAAW,SACtB,GAAG,OAAO,GAAG,sBAAsB,IAAI,GAAG,OAAO,sBAAsB,IAAI,MAAM,SAAS,UACxF,SACA,EAAE,CACL;CACD,MAAM,CAAC,OAAO,YAAY,UAAiB;CAC3C,MAAM,CAAC,WAAW,gBAAgB,UAAgB;AAElD,iBAAgB;EACf,MAAM,SAAS,GAAG,OAAO,GAAG,sBAAsB,IAAI,GAAG,OAAO,sBAAsB,GACnF,MAAM,QACL,MAA0B,OAAO;AAErC,MAAI,GAAG,QAAQ,SAAS,IAAI,GAAG,QAAQ,IAAI,EAAE;AAC5C,4BAAS,IAAI,MAAM,sEAAsE,CAAC;AAC1F;;EAGD,IAAIA;EAEJ,MAAM,cAAc,WAAc;AACjC,WAAQC,OAAK;AACb,gCAAa,IAAI,MAAM,CAAC;;AAGzB,QAAM,KAAK,WAAW,CAAC,MAAM,SAAS;AAEtC,MAAI,GAAG,QAAQ,YAAY,IAAI,GAAG,QAAQ,WAAW,EAAE;GACtD,MAAM,SAAS,GAAG,QAAQ,YAAY,GAAG,eAAe,OAAO,GAAG,cAAc,OAAO;AACvF,cAAW,2BAA2B,EAAE,gBAAgB;AACvD,QAAI,OAAO,SAAS,UACnB,OAAM,KAAK,WAAW,CAAC,MAAM,SAAS;KAEtC;;AAGH,eAAa;AACZ,aAAU,QAAQ;;IAEjB,KAAK;AAER,QAAO;EACN;EACA;EACA;EACA"}