{"version":3,"file":"migrator.cjs","names":["sql"],"sources":["../../src/sqlite-cloud/migrator.ts"],"sourcesContent":["import type { MigrationConfig, MigratorInitFailResponse } from '~/migrator.ts';\nimport { readMigrationFiles } from '~/migrator.ts';\nimport type { AnyRelations } from '~/relations.ts';\nimport { type SQL, sql } from '~/sql/sql.ts';\nimport type { SQLiteCloudDatabase } from './driver.ts';\n\nexport async function migrate<TSchema extends Record<string, unknown>, TRelations extends AnyRelations>(\n\tdb: SQLiteCloudDatabase<TSchema, TRelations>,\n\tconfig: MigrationConfig,\n): Promise<void | MigratorInitFailResponse> {\n\tconst migrations = readMigrationFiles(config);\n\tconst { session } = db;\n\n\tconst migrationsTable = config === undefined\n\t\t? '__drizzle_migrations'\n\t\t: typeof config === 'string'\n\t\t? '__drizzle_migrations'\n\t\t: config.migrationsTable ?? '__drizzle_migrations';\n\n\tconst migrationTableCreate = sql`\n\t\tCREATE TABLE IF NOT EXISTS ${sql.identifier(migrationsTable)} (\n\t\t\tid INTEGER PRIMARY KEY,\n\t\t\thash text NOT NULL,\n\t\t\tcreated_at numeric\n\t\t)\n\t`;\n\tawait session.run(migrationTableCreate);\n\n\tconst dbMigrations = await session.values<[number, string, string]>(\n\t\tsql`SELECT id, hash, created_at FROM ${sql.identifier(migrationsTable)} ORDER BY created_at DESC LIMIT 1`,\n\t);\n\n\tif (typeof config === 'object' && config.init) {\n\t\tif (dbMigrations.length) {\n\t\t\treturn { exitCode: 'databaseMigrations' as const };\n\t\t}\n\n\t\tif (migrations.length > 1) {\n\t\t\treturn { exitCode: 'localMigrations' as const };\n\t\t}\n\n\t\tconst [migration] = migrations;\n\n\t\tif (!migration) return;\n\n\t\tawait session.run(\n\t\t\tsql`insert into ${\n\t\t\t\tsql.identifier(migrationsTable)\n\t\t\t} (\"hash\", \"created_at\") values(${migration.hash}, ${migration.folderMillis})`,\n\t\t);\n\n\t\treturn;\n\t}\n\n\tconst lastDbMigration = dbMigrations[0] ?? undefined;\n\tawait session.run(sql`BEGIN TRANSACTION`);\n\ttry {\n\t\tconst stmts = sql.join(\n\t\t\tmigrations.reduce(\n\t\t\t\t(statements, migration) => {\n\t\t\t\t\tif (!lastDbMigration || Number(lastDbMigration[2])! < migration.folderMillis) {\n\t\t\t\t\t\tstatements.push(\n\t\t\t\t\t\t\tsql.raw(migration.sql.join('')),\n\t\t\t\t\t\t\tsql`INSERT INTO ${\n\t\t\t\t\t\t\t\tsql.identifier(migrationsTable)\n\t\t\t\t\t\t\t} (\"hash\", \"created_at\") VALUES(${migration.hash}, ${migration.folderMillis});\\n`,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn statements;\n\t\t\t\t},\n\t\t\t\t[] as SQL[],\n\t\t\t),\n\t\t);\n\n\t\tawait session.run(stmts);\n\n\t\tawait session.run(sql`COMMIT`);\n\t} catch (error) {\n\t\tawait session.run(sql`ROLLBACK`);\n\t\tthrow error;\n\t}\n}\n"],"mappings":";;;;;AAMA,eAAsB,QACrB,IACA,QAC2C;CAC3C,MAAM,mDAAgC,OAAO;CAC7C,MAAM,EAAE,YAAY;CAEpB,MAAM,kBAAkB,WAAW,SAChC,yBACA,OAAO,WAAW,WAClB,yBACA,OAAO,mBAAmB;CAE7B,MAAM,uBAAuB,gBAAG;+BACFA,iBAAI,WAAW,gBAAgB,CAAC;;;;;;AAM9D,OAAM,QAAQ,IAAI,qBAAqB;CAEvC,MAAM,eAAe,MAAM,QAAQ,OAClC,gBAAG,oCAAoCA,iBAAI,WAAW,gBAAgB,CAAC,mCACvE;AAED,KAAI,OAAO,WAAW,YAAY,OAAO,MAAM;AAC9C,MAAI,aAAa,OAChB,QAAO,EAAE,UAAU,sBAA+B;AAGnD,MAAI,WAAW,SAAS,EACvB,QAAO,EAAE,UAAU,mBAA4B;EAGhD,MAAM,CAAC,aAAa;AAEpB,MAAI,CAAC,UAAW;AAEhB,QAAM,QAAQ,IACb,gBAAG,eACFA,iBAAI,WAAW,gBAAgB,CAC/B,iCAAiC,UAAU,KAAK,IAAI,UAAU,aAAa,GAC5E;AAED;;CAGD,MAAM,kBAAkB,aAAa,MAAM;AAC3C,OAAM,QAAQ,IAAI,gBAAG,oBAAoB;AACzC,KAAI;EACH,MAAM,QAAQA,iBAAI,KACjB,WAAW,QACT,YAAY,cAAc;AAC1B,OAAI,CAAC,mBAAmB,OAAO,gBAAgB,GAAG,GAAI,UAAU,aAC/D,YAAW,KACVA,iBAAI,IAAI,UAAU,IAAI,KAAK,GAAG,CAAC,EAC/B,gBAAG,eACFA,iBAAI,WAAW,gBAAgB,CAC/B,iCAAiC,UAAU,KAAK,IAAI,UAAU,aAAa,MAC5E;AAGF,UAAO;KAER,EAAE,CACF,CACD;AAED,QAAM,QAAQ,IAAI,MAAM;AAExB,QAAM,QAAQ,IAAI,gBAAG,SAAS;UACtB,OAAO;AACf,QAAM,QAAQ,IAAI,gBAAG,WAAW;AAChC,QAAM"}