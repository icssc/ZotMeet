{"version":3,"sources":["../../../src/build/turbopack-analyze/index.ts"],"sourcesContent":["import type { NextConfigComplete } from '../../server/config-shared'\nimport type { __ApiPreviewProps } from '../../server/api-utils'\n\nimport path from 'path'\nimport { validateTurboNextConfig } from '../../lib/turbopack-warning'\nimport { isFileSystemCacheEnabledForBuild } from '../../shared/lib/turbopack/utils'\nimport { createDefineEnv, loadBindings } from '../swc'\nimport { isCI } from '../../server/ci-info'\nimport { backgroundLogCompilationEvents } from '../../shared/lib/turbopack/compilation-events'\nimport { getSupportedBrowsers } from '../utils'\nimport { normalizePath } from '../../lib/normalize-path'\nimport { PHASE_PRODUCTION_BUILD } from '../../shared/lib/constants'\n\nexport type AnalyzeContext = {\n  config: NextConfigComplete\n  distDir: string\n  dir: string\n  noMangling: boolean\n  appDirOnly: boolean\n}\n\nexport async function turbopackAnalyze(\n  analyzeContext: AnalyzeContext\n): Promise<{\n  duration: number\n  shutdownPromise: Promise<void>\n}> {\n  await validateTurboNextConfig({\n    dir: analyzeContext.dir,\n    configPhase: PHASE_PRODUCTION_BUILD,\n  })\n\n  const { config, dir, distDir, noMangling } = analyzeContext\n  const currentNodeJsVersion = process.versions.node\n\n  const startTime = process.hrtime()\n  const bindings = await loadBindings(config?.experimental?.useWasmBinary)\n  const dev = false\n\n  const supportedBrowsers = getSupportedBrowsers(dir, dev)\n\n  const persistentCaching = isFileSystemCacheEnabledForBuild(config)\n  const rootPath = config.turbopack?.root || config.outputFileTracingRoot || dir\n  const project = await bindings.turbo.createProject(\n    {\n      rootPath: config.turbopack?.root || config.outputFileTracingRoot || dir,\n      projectPath: normalizePath(path.relative(rootPath, dir) || '.'),\n      distDir,\n      nextConfig: config,\n      watch: {\n        enable: false,\n      },\n      dev,\n      env: process.env as Record<string, string>,\n      defineEnv: createDefineEnv({\n        isTurbopack: true,\n        config,\n        dev,\n        distDir,\n        projectPath: dir,\n        fetchCacheKeyPrefix: config.experimental.fetchCacheKeyPrefix,\n        hasRewrites: false,\n        // Implemented separately in Turbopack, doesn't have to be passed here.\n        middlewareMatchers: undefined,\n        rewrites: {\n          beforeFiles: [],\n          afterFiles: [],\n          fallback: [],\n        },\n      }),\n      buildId: 'analyze-build',\n      encryptionKey: '',\n      previewProps: {\n        previewModeId: '',\n        previewModeEncryptionKey: '',\n        previewModeSigningKey: '',\n      },\n      browserslistQuery: supportedBrowsers.join(', '),\n      noMangling,\n      writeRoutesHashesManifest: false,\n      currentNodeJsVersion,\n    },\n    {\n      persistentCaching,\n      memoryLimit: config.experimental?.turbopackMemoryLimit,\n      dependencyTracking: persistentCaching,\n      isCi: isCI,\n      isShortSession: true,\n    }\n  )\n\n  try {\n    backgroundLogCompilationEvents(project)\n\n    await project.writeAnalyzeData(analyzeContext.appDirOnly)\n\n    const shutdownPromise = project.shutdown()\n\n    const time = process.hrtime(startTime)\n    return {\n      duration: time[0] + time[1] / 1e9,\n      shutdownPromise,\n    }\n  } catch (err) {\n    await project.shutdown()\n    throw err\n  }\n}\n\nlet shutdownPromise: Promise<void> | undefined\nexport async function waitForShutdown(): Promise<void> {\n  if (shutdownPromise) {\n    await shutdownPromise\n  }\n}\n"],"names":["turbopackAnalyze","waitForShutdown","analyzeContext","config","validateTurboNextConfig","dir","configPhase","PHASE_PRODUCTION_BUILD","distDir","noMangling","currentNodeJsVersion","process","versions","node","startTime","hrtime","bindings","loadBindings","experimental","useWasmBinary","dev","supportedBrowsers","getSupportedBrowsers","persistentCaching","isFileSystemCacheEnabledForBuild","rootPath","turbopack","root","outputFileTracingRoot","project","turbo","createProject","projectPath","normalizePath","path","relative","nextConfig","watch","enable","env","defineEnv","createDefineEnv","isTurbopack","fetchCacheKeyPrefix","hasRewrites","middlewareMatchers","undefined","rewrites","beforeFiles","afterFiles","fallback","buildId","encryptionKey","previewProps","previewModeId","previewModeEncryptionKey","previewModeSigningKey","browserslistQuery","join","writeRoutesHashesManifest","memoryLimit","turbopackMemoryLimit","dependencyTracking","isCi","isCI","isShortSession","backgroundLogCompilationEvents","writeAnalyzeData","appDirOnly","shutdownPromise","shutdown","time","duration","err"],"mappings":";;;;;;;;;;;;;;;IAqBsBA,gBAAgB;eAAhBA;;IAyFAC,eAAe;eAAfA;;;6DA3GL;kCACuB;uBACS;qBACH;wBACzB;mCAC0B;wBACV;+BACP;2BACS;;;;;;AAUhC,eAAeD,iBACpBE,cAA8B;QAcMC,sBAMnBA,mBAGHA,oBAuCGA;IAzDjB,MAAMC,IAAAA,yCAAuB,EAAC;QAC5BC,KAAKH,eAAeG,GAAG;QACvBC,aAAaC,iCAAsB;IACrC;IAEA,MAAM,EAAEJ,MAAM,EAAEE,GAAG,EAAEG,OAAO,EAAEC,UAAU,EAAE,GAAGP;IAC7C,MAAMQ,uBAAuBC,QAAQC,QAAQ,CAACC,IAAI;IAElD,MAAMC,YAAYH,QAAQI,MAAM;IAChC,MAAMC,WAAW,MAAMC,IAAAA,iBAAY,EAACd,2BAAAA,uBAAAA,OAAQe,YAAY,qBAApBf,qBAAsBgB,aAAa;IACvE,MAAMC,MAAM;IAEZ,MAAMC,oBAAoBC,IAAAA,4BAAoB,EAACjB,KAAKe;IAEpD,MAAMG,oBAAoBC,IAAAA,uCAAgC,EAACrB;IAC3D,MAAMsB,WAAWtB,EAAAA,oBAAAA,OAAOuB,SAAS,qBAAhBvB,kBAAkBwB,IAAI,KAAIxB,OAAOyB,qBAAqB,IAAIvB;IAC3E,MAAMwB,UAAU,MAAMb,SAASc,KAAK,CAACC,aAAa,CAChD;QACEN,UAAUtB,EAAAA,qBAAAA,OAAOuB,SAAS,qBAAhBvB,mBAAkBwB,IAAI,KAAIxB,OAAOyB,qBAAqB,IAAIvB;QACpE2B,aAAaC,IAAAA,4BAAa,EAACC,aAAI,CAACC,QAAQ,CAACV,UAAUpB,QAAQ;QAC3DG;QACA4B,YAAYjC;QACZkC,OAAO;YACLC,QAAQ;QACV;QACAlB;QACAmB,KAAK5B,QAAQ4B,GAAG;QAChBC,WAAWC,IAAAA,oBAAe,EAAC;YACzBC,aAAa;YACbvC;YACAiB;YACAZ;YACAwB,aAAa3B;YACbsC,qBAAqBxC,OAAOe,YAAY,CAACyB,mBAAmB;YAC5DC,aAAa;YACb,uEAAuE;YACvEC,oBAAoBC;YACpBC,UAAU;gBACRC,aAAa,EAAE;gBACfC,YAAY,EAAE;gBACdC,UAAU,EAAE;YACd;QACF;QACAC,SAAS;QACTC,eAAe;QACfC,cAAc;YACZC,eAAe;YACfC,0BAA0B;YAC1BC,uBAAuB;QACzB;QACAC,mBAAmBpC,kBAAkBqC,IAAI,CAAC;QAC1CjD;QACAkD,2BAA2B;QAC3BjD;IACF,GACA;QACEa;QACAqC,WAAW,GAAEzD,wBAAAA,OAAOe,YAAY,qBAAnBf,sBAAqB0D,oBAAoB;QACtDC,oBAAoBvC;QACpBwC,MAAMC,YAAI;QACVC,gBAAgB;IAClB;IAGF,IAAI;QACFC,IAAAA,iDAA8B,EAACrC;QAE/B,MAAMA,QAAQsC,gBAAgB,CAACjE,eAAekE,UAAU;QAExD,MAAMC,kBAAkBxC,QAAQyC,QAAQ;QAExC,MAAMC,OAAO5D,QAAQI,MAAM,CAACD;QAC5B,OAAO;YACL0D,UAAUD,IAAI,CAAC,EAAE,GAAGA,IAAI,CAAC,EAAE,GAAG;YAC9BF;QACF;IACF,EAAE,OAAOI,KAAK;QACZ,MAAM5C,QAAQyC,QAAQ;QACtB,MAAMG;IACR;AACF;AAEA,IAAIJ;AACG,eAAepE;IACpB,IAAIoE,iBAAiB;QACnB,MAAMA;IACR;AACF","ignoreList":[0]}