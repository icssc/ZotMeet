{"version":3,"file":"geometry.cjs","names":["CockroachColumnWithArrayBuilder","entityKind","CockroachColumn","parseEWKB"],"sources":["../../../src/cockroach-core/columns/geometry.ts"],"sourcesContent":["import type { CockroachTable } from '~/cockroach-core/table.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport { type Equal, getColumnNameAndConfig } from '~/utils.ts';\nimport { CockroachColumn, CockroachColumnWithArrayBuilder } from './common.ts';\nimport { parseEWKB } from './utils.ts';\n\nexport class CockroachGeometryBuilder extends CockroachColumnWithArrayBuilder<{\n\tdataType: 'array geometry';\n\tdata: [number, number];\n\tdriverParam: string;\n}, { srid: number | undefined }> {\n\tstatic override readonly [entityKind]: string = 'CockroachGeometryBuilder';\n\n\tconstructor(name: string, srid?: number) {\n\t\tsuper(name, 'array geometry', 'CockroachGeometry');\n\t\tthis.config.srid = srid;\n\t}\n\n\t/** @internal */\n\toverride build(table: CockroachTable<any>) {\n\t\treturn new CockroachGeometry(\n\t\t\ttable,\n\t\t\tthis.config as any,\n\t\t);\n\t}\n}\n\nexport class CockroachGeometry<T extends ColumnBaseConfig<'array geometry'>>\n\textends CockroachColumn<T, { srid: number | undefined }>\n{\n\tstatic override readonly [entityKind]: string = 'CockroachGeometry';\n\n\treadonly srid = this.config.srid;\n\treadonly mode = 'tuple';\n\n\tgetSQLType(): string {\n\t\treturn `geometry(point${this.srid === undefined ? '' : `,${this.srid}`})`;\n\t}\n\n\toverride mapFromDriverValue(value: string | [number, number]): [number, number] {\n\t\tif (typeof value !== 'string') return value as [number, number];\n\n\t\treturn parseEWKB(value).point;\n\t}\n\n\toverride mapToDriverValue(value: [number, number]): string {\n\t\treturn `point(${value[0]} ${value[1]})`;\n\t}\n}\n\nexport class CockroachGeometryObjectBuilder extends CockroachColumnWithArrayBuilder<{\n\tdataType: 'object geometry';\n\tdata: { x: number; y: number };\n\tdriverParam: string;\n}, { srid?: number }> {\n\tstatic override readonly [entityKind]: string = 'CockroachGeometryObjectBuilder';\n\n\tconstructor(name: string, srid: number | undefined) {\n\t\tsuper(name, 'object geometry', 'CockroachGeometryObject');\n\t\tthis.config.srid = srid;\n\t}\n\n\t/** @internal */\n\toverride build(table: CockroachTable<any>) {\n\t\treturn new CockroachGeometryObject(\n\t\t\ttable,\n\t\t\tthis.config as any,\n\t\t);\n\t}\n}\n\nexport class CockroachGeometryObject<T extends ColumnBaseConfig<'object geometry'>>\n\textends CockroachColumn<T, { srid: number | undefined }>\n{\n\tstatic override readonly [entityKind]: string = 'CockroachGeometryObject';\n\n\treadonly srid = this.config.srid;\n\treadonly mode = 'object';\n\n\tgetSQLType(): string {\n\t\treturn `geometry(point${this.srid === undefined ? '' : `,${this.srid}`})`;\n\t}\n\n\toverride mapFromDriverValue(value: string): { x: number; y: number } {\n\t\tconst parsed = parseEWKB(value);\n\t\treturn { x: parsed.point[0], y: parsed.point[1] };\n\t}\n\n\toverride mapToDriverValue(value: { x: number; y: number }): string {\n\t\treturn `point(${value.x} ${value.y})`;\n\t}\n}\n\nexport interface CockroachGeometryConfig<T extends 'tuple' | 'xy' = 'tuple' | 'xy'> {\n\tmode?: T;\n\ttype?: 'point' | (string & {});\n\tsrid?: number;\n}\n\nexport function geometry<TMode extends CockroachGeometryConfig['mode'] & {}>(\n\tconfig?: CockroachGeometryConfig<TMode>,\n): Equal<TMode, 'xy'> extends true ? CockroachGeometryObjectBuilder : CockroachGeometryBuilder;\nexport function geometry<TMode extends CockroachGeometryConfig['mode'] & {}>(\n\tname: string,\n\tconfig?: CockroachGeometryConfig<TMode>,\n): Equal<TMode, 'xy'> extends true ? CockroachGeometryObjectBuilder : CockroachGeometryBuilder;\nexport function geometry(a?: string | CockroachGeometryConfig, b?: CockroachGeometryConfig) {\n\tconst { name, config } = getColumnNameAndConfig<CockroachGeometryConfig>(a, b);\n\tif (!config?.mode || config.mode === 'tuple') {\n\t\treturn new CockroachGeometryBuilder(name, config?.srid);\n\t}\n\treturn new CockroachGeometryObjectBuilder(name, config?.srid);\n}\n"],"mappings":";;;;;;;AAOA,IAAa,2BAAb,cAA8CA,sEAIb;CAChC,QAA0BC,0BAAsB;CAEhD,YAAY,MAAc,MAAe;AACxC,QAAM,MAAM,kBAAkB,oBAAoB;AAClD,OAAK,OAAO,OAAO;;;CAIpB,AAAS,MAAM,OAA4B;AAC1C,SAAO,IAAI,kBACV,OACA,KAAK,OACL;;;AAIH,IAAa,oBAAb,cACSC,sDACT;CACC,QAA0BD,0BAAsB;CAEhD,AAAS,OAAO,KAAK,OAAO;CAC5B,AAAS,OAAO;CAEhB,aAAqB;AACpB,SAAO,iBAAiB,KAAK,SAAS,SAAY,KAAK,IAAI,KAAK,OAAO;;CAGxE,AAAS,mBAAmB,OAAoD;AAC/E,MAAI,OAAO,UAAU,SAAU,QAAO;AAEtC,SAAOE,+CAAU,MAAM,CAAC;;CAGzB,AAAS,iBAAiB,OAAiC;AAC1D,SAAO,SAAS,MAAM,GAAG,GAAG,MAAM,GAAG;;;AAIvC,IAAa,iCAAb,cAAoDH,sEAI9B;CACrB,QAA0BC,0BAAsB;CAEhD,YAAY,MAAc,MAA0B;AACnD,QAAM,MAAM,mBAAmB,0BAA0B;AACzD,OAAK,OAAO,OAAO;;;CAIpB,AAAS,MAAM,OAA4B;AAC1C,SAAO,IAAI,wBACV,OACA,KAAK,OACL;;;AAIH,IAAa,0BAAb,cACSC,sDACT;CACC,QAA0BD,0BAAsB;CAEhD,AAAS,OAAO,KAAK,OAAO;CAC5B,AAAS,OAAO;CAEhB,aAAqB;AACpB,SAAO,iBAAiB,KAAK,SAAS,SAAY,KAAK,IAAI,KAAK,OAAO;;CAGxE,AAAS,mBAAmB,OAAyC;EACpE,MAAM,SAASE,+CAAU,MAAM;AAC/B,SAAO;GAAE,GAAG,OAAO,MAAM;GAAI,GAAG,OAAO,MAAM;GAAI;;CAGlD,AAAS,iBAAiB,OAAyC;AAClE,SAAO,SAAS,MAAM,EAAE,GAAG,MAAM,EAAE;;;AAiBrC,SAAgB,SAAS,GAAsC,GAA6B;CAC3F,MAAM,EAAE,MAAM,kDAA2D,GAAG,EAAE;AAC9E,KAAI,CAAC,QAAQ,QAAQ,OAAO,SAAS,QACpC,QAAO,IAAI,yBAAyB,MAAM,QAAQ,KAAK;AAExD,QAAO,IAAI,+BAA+B,MAAM,QAAQ,KAAK"}