{"version":3,"sources":["../../../src/server/app-render/use-flight-response.tsx"],"sourcesContent":["import type { BinaryStreamOf } from './app-render'\nimport type { Readable } from 'node:stream'\n\nimport { htmlEscapeJsonString } from '../htmlescape'\nimport { workUnitAsyncStorage } from './work-unit-async-storage.external'\nimport { InvariantError } from '../../shared/lib/invariant-error'\nimport { getClientReferenceManifest } from './manifests-singleton'\n\nconst isEdgeRuntime = process.env.NEXT_RUNTIME === 'edge'\n\nconst INLINE_FLIGHT_PAYLOAD_BOOTSTRAP = 0\nconst INLINE_FLIGHT_PAYLOAD_DATA = 1\nconst INLINE_FLIGHT_PAYLOAD_FORM_STATE = 2\nconst INLINE_FLIGHT_PAYLOAD_BINARY = 3\n\nconst flightResponses = new WeakMap<\n  Readable | BinaryStreamOf<any>,\n  Promise<any>\n>()\nconst encoder = new TextEncoder()\n\nconst findSourceMapURL =\n  process.env.NODE_ENV !== 'production'\n    ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n        .findSourceMapURLDEV\n    : undefined\n\n/**\n * Render Flight stream.\n * This is only used for renderToHTML, the Flight response does not need additional wrappers.\n */\nexport function getFlightStream<T>(\n  flightStream: Readable | BinaryStreamOf<T>,\n  debugStream: Readable | ReadableStream<Uint8Array> | undefined,\n  debugEndTime: number | undefined,\n  nonce: string | undefined\n): Promise<T> {\n  const response = flightResponses.get(flightStream)\n\n  if (response) {\n    return response\n  }\n\n  const { moduleLoading, edgeSSRModuleMapping, ssrModuleMapping } =\n    getClientReferenceManifest()\n\n  let newResponse: Promise<T>\n  if (flightStream instanceof ReadableStream) {\n    // The types of flightStream and debugStream should match.\n    if (debugStream && !(debugStream instanceof ReadableStream)) {\n      throw new InvariantError('Expected debug stream to be a ReadableStream')\n    }\n\n    // react-server-dom-webpack/client.edge must not be hoisted for require cache clearing to work correctly\n    const { createFromReadableStream } =\n      // eslint-disable-next-line import/no-extraneous-dependencies\n      require('react-server-dom-webpack/client') as typeof import('react-server-dom-webpack/client')\n\n    newResponse = createFromReadableStream<T>(flightStream, {\n      findSourceMapURL,\n      serverConsumerManifest: {\n        moduleLoading,\n        moduleMap: isEdgeRuntime ? edgeSSRModuleMapping : ssrModuleMapping,\n        serverModuleMap: null,\n      },\n      nonce,\n      debugChannel: debugStream ? { readable: debugStream } : undefined,\n      endTime: debugEndTime,\n    })\n  } else {\n    if (process.env.NEXT_RUNTIME === 'edge') {\n      throw new InvariantError(\n        'getFlightStream should always receive a ReadableStream when using the edge runtime'\n      )\n    } else {\n      const { Readable } =\n        require('node:stream') as typeof import('node:stream')\n\n      // The types of flightStream and debugStream should match.\n      if (debugStream && !(debugStream instanceof Readable)) {\n        throw new InvariantError('Expected debug stream to be a Readable')\n      }\n\n      // react-server-dom-webpack/client.edge must not be hoisted for require cache clearing to work correctly\n      const { createFromNodeStream } =\n        // eslint-disable-next-line import/no-extraneous-dependencies\n        require('react-server-dom-webpack/client') as typeof import('react-server-dom-webpack/client')\n\n      newResponse = createFromNodeStream<T>(\n        flightStream,\n        {\n          moduleLoading,\n          moduleMap: isEdgeRuntime ? edgeSSRModuleMapping : ssrModuleMapping,\n          serverModuleMap: null,\n        },\n        {\n          findSourceMapURL,\n          nonce,\n          debugChannel: debugStream,\n          endTime: debugEndTime,\n        }\n      )\n    }\n  }\n\n  // Edge pages are never prerendered so they necessarily cannot have a workUnitStore type\n  // that requires the nextTick behavior. This is why it is safe to access a node only API here\n  if (process.env.NEXT_RUNTIME !== 'edge') {\n    const workUnitStore = workUnitAsyncStorage.getStore()\n\n    if (!workUnitStore) {\n      throw new InvariantError('Expected workUnitAsyncStorage to have a store.')\n    }\n\n    switch (workUnitStore.type) {\n      case 'prerender-client':\n        const responseOnNextTick = new Promise<T>((resolve) => {\n          process.nextTick(() => {\n            resolve(newResponse)\n          })\n        })\n        flightResponses.set(flightStream, responseOnNextTick)\n        return responseOnNextTick\n      case 'prerender':\n      case 'prerender-runtime':\n      case 'prerender-ppr':\n      case 'prerender-legacy':\n      case 'request':\n      case 'cache':\n      case 'private-cache':\n      case 'unstable-cache':\n        break\n      default:\n        workUnitStore satisfies never\n    }\n  }\n\n  flightResponses.set(flightStream, newResponse)\n\n  return newResponse\n}\n\n/**\n * Creates a ReadableStream provides inline script tag chunks for writing hydration\n * data to the client outside the React render itself.\n *\n * @param flightStream The RSC render stream\n * @param nonce optionally a nonce used during this particular render\n * @param formState optionally the formState used with this particular render\n * @returns a ReadableStream without the complete property. This signifies a lazy ReadableStream\n */\nexport function createInlinedDataReadableStream(\n  flightStream: ReadableStream<Uint8Array>,\n  nonce: string | undefined,\n  formState: unknown | null\n): ReadableStream<Uint8Array> {\n  const startScriptTag = nonce\n    ? `<script nonce=${JSON.stringify(nonce)}>`\n    : '<script>'\n\n  const flightReader = flightStream.getReader()\n  const decoder = new TextDecoder('utf-8', { fatal: true })\n\n  const readable = new ReadableStream({\n    type: 'bytes',\n    start(controller) {\n      try {\n        writeInitialInstructions(controller, startScriptTag, formState)\n      } catch (error) {\n        // during encoding or enqueueing forward the error downstream\n        controller.error(error)\n      }\n    },\n    async pull(controller) {\n      try {\n        const { done, value } = await flightReader.read()\n\n        if (value) {\n          try {\n            const decodedString = decoder.decode(value, { stream: !done })\n\n            // The chunk cannot be decoded as valid UTF-8 string as it might\n            // have arbitrary binary data.\n            writeFlightDataInstruction(\n              controller,\n              startScriptTag,\n              decodedString\n            )\n          } catch {\n            // The chunk cannot be decoded as valid UTF-8 string.\n            writeFlightDataInstruction(controller, startScriptTag, value)\n          }\n        }\n\n        if (done) {\n          controller.close()\n        }\n      } catch (error) {\n        // There was a problem in the upstream reader or during decoding or enqueuing\n        // forward the error downstream\n        controller.error(error)\n      }\n    },\n  })\n\n  return readable\n}\n\nfunction writeInitialInstructions(\n  controller: ReadableStreamDefaultController,\n  scriptStart: string,\n  formState: unknown | null\n) {\n  let scriptContents = `(self.__next_f=self.__next_f||[]).push(${htmlEscapeJsonString(\n    JSON.stringify([INLINE_FLIGHT_PAYLOAD_BOOTSTRAP])\n  )})`\n\n  if (formState != null) {\n    scriptContents += `;self.__next_f.push(${htmlEscapeJsonString(\n      JSON.stringify([INLINE_FLIGHT_PAYLOAD_FORM_STATE, formState])\n    )})`\n  }\n\n  controller.enqueue(encoder.encode(`${scriptStart}${scriptContents}</script>`))\n}\n\nfunction writeFlightDataInstruction(\n  controller: ReadableStreamDefaultController,\n  scriptStart: string,\n  chunk: string | Uint8Array\n) {\n  let htmlInlinedData: string\n\n  if (typeof chunk === 'string') {\n    htmlInlinedData = htmlEscapeJsonString(\n      JSON.stringify([INLINE_FLIGHT_PAYLOAD_DATA, chunk])\n    )\n  } else {\n    // The chunk cannot be embedded as a UTF-8 string in the script tag.\n    // Instead let's inline it in base64.\n    // Credits to Devon Govett (devongovett) for the technique.\n    // https://github.com/devongovett/rsc-html-stream\n    const base64 = btoa(String.fromCodePoint(...chunk))\n    htmlInlinedData = htmlEscapeJsonString(\n      JSON.stringify([INLINE_FLIGHT_PAYLOAD_BINARY, base64])\n    )\n  }\n\n  controller.enqueue(\n    encoder.encode(\n      `${scriptStart}self.__next_f.push(${htmlInlinedData})</script>`\n    )\n  )\n}\n"],"names":["createInlinedDataReadableStream","getFlightStream","isEdgeRuntime","process","env","NEXT_RUNTIME","INLINE_FLIGHT_PAYLOAD_BOOTSTRAP","INLINE_FLIGHT_PAYLOAD_DATA","INLINE_FLIGHT_PAYLOAD_FORM_STATE","INLINE_FLIGHT_PAYLOAD_BINARY","flightResponses","WeakMap","encoder","TextEncoder","findSourceMapURL","NODE_ENV","require","findSourceMapURLDEV","undefined","flightStream","debugStream","debugEndTime","nonce","response","get","moduleLoading","edgeSSRModuleMapping","ssrModuleMapping","getClientReferenceManifest","newResponse","ReadableStream","InvariantError","createFromReadableStream","serverConsumerManifest","moduleMap","serverModuleMap","debugChannel","readable","endTime","Readable","createFromNodeStream","workUnitStore","workUnitAsyncStorage","getStore","type","responseOnNextTick","Promise","resolve","nextTick","set","formState","startScriptTag","JSON","stringify","flightReader","getReader","decoder","TextDecoder","fatal","start","controller","writeInitialInstructions","error","pull","done","value","read","decodedString","decode","stream","writeFlightDataInstruction","close","scriptStart","scriptContents","htmlEscapeJsonString","enqueue","encode","chunk","htmlInlinedData","base64","btoa","String","fromCodePoint"],"mappings":"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","ignoreList":[0]}