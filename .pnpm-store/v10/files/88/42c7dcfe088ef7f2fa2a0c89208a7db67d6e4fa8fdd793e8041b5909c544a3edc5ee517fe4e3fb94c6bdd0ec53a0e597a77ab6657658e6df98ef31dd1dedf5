{"version":3,"sources":["../../../../src/build/turbopack-build/index.ts"],"sourcesContent":["import path from 'path'\n\nimport { Worker } from '../../lib/worker'\nimport { NextBuildContext } from '../build-context'\n\nasync function turbopackBuildWithWorker(): ReturnType<\n  typeof import('./impl').turbopackBuild\n> {\n  try {\n    const worker = new Worker(path.join(__dirname, 'impl.js'), {\n      exposedMethods: ['workerMain', 'waitForShutdown'],\n      enableWorkerThreads: true,\n      debuggerPortOffset: -1,\n      isolatedMemory: false,\n      numWorkers: 1,\n      maxRetries: 0,\n      forkOptions: {\n        env: {\n          NEXT_PRIVATE_BUILD_WORKER: '1',\n        },\n      },\n    }) as Worker & typeof import('./impl')\n    const {\n      nextBuildSpan,\n      // Config is not serializable and is loaded in the worker.\n      config: _config,\n      ...prunedBuildContext\n    } = NextBuildContext\n    const { buildTraceContext, duration } = await worker.workerMain({\n      buildContext: prunedBuildContext,\n    })\n\n    return {\n      // destroy worker when Turbopack has shutdown so it's not sticking around using memory\n      // We need to wait for shutdown to make sure filesystem cache is flushed\n      shutdownPromise: worker.waitForShutdown().then(() => {\n        worker.end()\n      }),\n      buildTraceContext,\n      duration,\n    }\n  } catch (err: any) {\n    // When the error is a serialized `Error` object we need to recreate the `Error` instance\n    // in order to keep the consistent error reporting behavior.\n    if (err.type === 'Error') {\n      const error = new Error(err.message)\n      if (err.name) {\n        error.name = err.name\n      }\n      if (err.cause) {\n        error.cause = err.cause\n      }\n      error.message = err.message\n      error.stack = err.stack\n      throw error\n    }\n    throw err\n  }\n}\n\nexport function turbopackBuild(\n  withWorker: boolean\n): ReturnType<typeof import('./impl').turbopackBuild> {\n  const nextBuildSpan = NextBuildContext.nextBuildSpan!\n  return nextBuildSpan.traceChild('run-turbopack').traceAsyncFn(async () => {\n    if (withWorker) {\n      return await turbopackBuildWithWorker()\n    } else {\n      const build = (require('./impl') as typeof import('./impl'))\n        .turbopackBuild\n      return await build()\n    }\n  })\n}\n"],"names":["path","Worker","NextBuildContext","turbopackBuildWithWorker","worker","join","__dirname","exposedMethods","enableWorkerThreads","debuggerPortOffset","isolatedMemory","numWorkers","maxRetries","forkOptions","env","NEXT_PRIVATE_BUILD_WORKER","nextBuildSpan","config","_config","prunedBuildContext","buildTraceContext","duration","workerMain","buildContext","shutdownPromise","waitForShutdown","then","end","err","type","error","Error","message","name","cause","stack","turbopackBuild","withWorker","traceChild","traceAsyncFn","build","require"],"mappings":"AAAA,OAAOA,UAAU,OAAM;AAEvB,SAASC,MAAM,QAAQ,mBAAkB;AACzC,SAASC,gBAAgB,QAAQ,mBAAkB;AAEnD,eAAeC;IAGb,IAAI;QACF,MAAMC,SAAS,IAAIH,OAAOD,KAAKK,IAAI,CAACC,WAAW,YAAY;YACzDC,gBAAgB;gBAAC;gBAAc;aAAkB;YACjDC,qBAAqB;YACrBC,oBAAoB,CAAC;YACrBC,gBAAgB;YAChBC,YAAY;YACZC,YAAY;YACZC,aAAa;gBACXC,KAAK;oBACHC,2BAA2B;gBAC7B;YACF;QACF;QACA,MAAM,EACJC,aAAa,EACb,0DAA0D;QAC1DC,QAAQC,OAAO,EACf,GAAGC,oBACJ,GAAGjB;QACJ,MAAM,EAAEkB,iBAAiB,EAAEC,QAAQ,EAAE,GAAG,MAAMjB,OAAOkB,UAAU,CAAC;YAC9DC,cAAcJ;QAChB;QAEA,OAAO;YACL,sFAAsF;YACtF,wEAAwE;YACxEK,iBAAiBpB,OAAOqB,eAAe,GAAGC,IAAI,CAAC;gBAC7CtB,OAAOuB,GAAG;YACZ;YACAP;YACAC;QACF;IACF,EAAE,OAAOO,KAAU;QACjB,yFAAyF;QACzF,4DAA4D;QAC5D,IAAIA,IAAIC,IAAI,KAAK,SAAS;YACxB,MAAMC,QAAQ,qBAAsB,CAAtB,IAAIC,MAAMH,IAAII,OAAO,GAArB,qBAAA;uBAAA;4BAAA;8BAAA;YAAqB;YACnC,IAAIJ,IAAIK,IAAI,EAAE;gBACZH,MAAMG,IAAI,GAAGL,IAAIK,IAAI;YACvB;YACA,IAAIL,IAAIM,KAAK,EAAE;gBACbJ,MAAMI,KAAK,GAAGN,IAAIM,KAAK;YACzB;YACAJ,MAAME,OAAO,GAAGJ,IAAII,OAAO;YAC3BF,MAAMK,KAAK,GAAGP,IAAIO,KAAK;YACvB,MAAML;QACR;QACA,MAAMF;IACR;AACF;AAEA,OAAO,SAASQ,eACdC,UAAmB;IAEnB,MAAMrB,gBAAgBd,iBAAiBc,aAAa;IACpD,OAAOA,cAAcsB,UAAU,CAAC,iBAAiBC,YAAY,CAAC;QAC5D,IAAIF,YAAY;YACd,OAAO,MAAMlC;QACf,OAAO;YACL,MAAMqC,QAAQ,AAACC,QAAQ,UACpBL,cAAc;YACjB,OAAO,MAAMI;QACf;IACF;AACF","ignoreList":[0]}