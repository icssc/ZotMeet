{"version":3,"file":"cache.cjs","names":["entityKind"],"sources":["../../../src/cache/core/cache.ts"],"sourcesContent":["import { entityKind } from '~/entity.ts';\nimport type { Table } from '~/table.ts';\nimport type { CacheConfig, WithCacheConfig } from './types.ts';\n\nexport abstract class Cache {\n\tstatic readonly [entityKind]: string = 'Cache';\n\n\tabstract strategy(): 'explicit' | 'all';\n\n\t/**\n\t * Invoked if we should check cache for cached response\n\t * @param sql\n\t * @param tables\n\t */\n\tabstract get(\n\t\tkey: string,\n\t\ttables: string[],\n\t\tisTag: boolean,\n\t\tisAutoInvalidate?: boolean,\n\t): Promise<any[] | undefined>;\n\n\t/**\n\t * Invoked if new query should be inserted to cache\n\t * @param sql\n\t * @param tables\n\t */\n\tabstract put(\n\t\thashedQuery: string,\n\t\tresponse: any,\n\t\ttables: string[],\n\t\tisTag: boolean,\n\t\tconfig?: CacheConfig,\n\t): Promise<void>;\n\n\t/**\n\t * Invoked if insert, update, delete was invoked\n\t * @param tables\n\t */\n\tabstract onMutate(\n\t\tparams: MutationOption,\n\t): Promise<void>;\n}\n\nexport class NoopCache extends Cache {\n\tstatic override readonly [entityKind]: string = 'NoopCache';\n\n\toverride strategy() {\n\t\treturn 'all' as const;\n\t}\n\n\toverride async get(_key: string): Promise<any[] | undefined> {\n\t\treturn undefined;\n\t}\n\toverride async put(\n\t\t_hashedQuery: string,\n\t\t_response: any,\n\t\t_tables: string[],\n\t\t_config?: any,\n\t): Promise<void> {\n\t\t// noop\n\t}\n\toverride async onMutate(_params: MutationOption): Promise<void> {\n\t\t// noop\n\t}\n}\n\n// TODO: one place for all dialects\nexport const strategyFor = async (\n\tquery: string,\n\tparams: any[] | undefined,\n\tqueryMetadata: {\n\t\ttype: 'select' | 'update' | 'delete' | 'insert';\n\t\ttables: string[];\n\t} | undefined,\n\twithCacheConfig?: WithCacheConfig,\n) => {\n\tif (!queryMetadata) return { type: 'skip' as const };\n\n\tconst { type, tables } = queryMetadata;\n\n\tif ((type === 'insert' || type === 'update' || type === 'delete') && tables.length > 0) {\n\t\treturn { type: 'invalidate' as const, tables };\n\t}\n\n\tif (!withCacheConfig) return { type: 'skip' as const };\n\tif (!withCacheConfig.enabled) return { type: 'skip' as const };\n\n\tif (type === 'select') {\n\t\tconst tag = withCacheConfig.tag ?? await hashQuery(query, params);\n\n\t\treturn {\n\t\t\ttype: 'try' as const,\n\t\t\tkey: tag,\n\t\t\tisTag: typeof withCacheConfig.tag !== 'undefined',\n\t\t\tautoInvalidate: withCacheConfig.autoInvalidate,\n\t\t\ttables: queryMetadata.tables,\n\t\t\tconfig: withCacheConfig.config,\n\t\t};\n\t}\n\treturn { type: 'skip' as const };\n};\n\nexport type MutationOption = { tags?: string | string[]; tables?: Table<any> | Table<any>[] | string | string[] };\n\nexport async function hashQuery(sql: string, params?: any[]) {\n\tconst dataToHash = `${sql}-${JSON.stringify(params, (_, v) => typeof v === 'bigint' ? `${v}n` : v)}`;\n\tconst encoder = new TextEncoder();\n\tconst data = encoder.encode(dataToHash);\n\tconst hashBuffer = await crypto.subtle.digest('SHA-256', data);\n\tconst hashArray = [...new Uint8Array(hashBuffer)];\n\tconst hashHex = hashArray.map((b) => b.toString(16).padStart(2, '0')).join('');\n\n\treturn hashHex;\n}\n"],"mappings":";;;;AAIA,IAAsB,QAAtB,MAA4B;CAC3B,QAAiBA,0BAAsB;;AAsCxC,IAAa,YAAb,cAA+B,MAAM;CACpC,QAA0BA,0BAAsB;CAEhD,AAAS,WAAW;AACnB,SAAO;;CAGR,MAAe,IAAI,MAA0C;CAG7D,MAAe,IACd,cACA,WACA,SACA,SACgB;CAGjB,MAAe,SAAS,SAAwC;;AAMjE,MAAa,cAAc,OAC1B,OACA,QACA,eAIA,oBACI;AACJ,KAAI,CAAC,cAAe,QAAO,EAAE,MAAM,QAAiB;CAEpD,MAAM,EAAE,MAAM,WAAW;AAEzB,MAAK,SAAS,YAAY,SAAS,YAAY,SAAS,aAAa,OAAO,SAAS,EACpF,QAAO;EAAE,MAAM;EAAuB;EAAQ;AAG/C,KAAI,CAAC,gBAAiB,QAAO,EAAE,MAAM,QAAiB;AACtD,KAAI,CAAC,gBAAgB,QAAS,QAAO,EAAE,MAAM,QAAiB;AAE9D,KAAI,SAAS,SAGZ,QAAO;EACN,MAAM;EACN,KAJW,gBAAgB,OAAO,MAAM,UAAU,OAAO,OAAO;EAKhE,OAAO,OAAO,gBAAgB,QAAQ;EACtC,gBAAgB,gBAAgB;EAChC,QAAQ,cAAc;EACtB,QAAQ,gBAAgB;EACxB;AAEF,QAAO,EAAE,MAAM,QAAiB;;AAKjC,eAAsB,UAAU,KAAa,QAAgB;CAC5D,MAAM,aAAa,GAAG,IAAI,GAAG,KAAK,UAAU,SAAS,GAAG,MAAM,OAAO,MAAM,WAAW,GAAG,EAAE,KAAK,EAAE;CAElG,MAAM,OADU,IAAI,aAAa,CACZ,OAAO,WAAW;CACvC,MAAM,aAAa,MAAM,OAAO,OAAO,OAAO,WAAW,KAAK;AAI9D,QAHkB,CAAC,GAAG,IAAI,WAAW,WAAW,CAAC,CACvB,KAAK,MAAM,EAAE,SAAS,GAAG,CAAC,SAAS,GAAG,IAAI,CAAC,CAAC,KAAK,GAAG"}