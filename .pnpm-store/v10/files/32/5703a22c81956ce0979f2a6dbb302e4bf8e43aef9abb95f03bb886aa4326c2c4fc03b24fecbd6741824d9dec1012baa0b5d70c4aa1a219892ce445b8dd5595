{"version":3,"file":"query.js","names":["schema: TSchema","table: PgTable","tableConfig: TableRelationalConfig","dialect: PgDialect","session: PgSession","parseJson: boolean","builder: PgRelationalQueryConstructor","schema: TablesRelationalConfig","config: DBQueryConfig<'many' | 'one'> | true","mode: 'many' | 'first'"],"sources":["../../../src/pg-core/query-builders/query.ts"],"sourcesContent":["import { entityKind } from '~/entity.ts';\nimport type {\n\tBuildQueryResult,\n\tBuildRelationalQueryResult,\n\tDBQueryConfig,\n\tTableRelationalConfig,\n\tTablesRelationalConfig,\n} from '~/relations.ts';\nimport type { Query, QueryWithTypings, SQL, SQLWrapper } from '~/sql/sql.ts';\nimport type { KnownKeysOnly } from '~/utils.ts';\nimport type { PgDialect } from '../dialect.ts';\nimport type { PgSession } from '../session.ts';\nimport type { PgTable } from '../table.ts';\n\nexport interface PgRelationalQueryConstructor {\n\tnew(\n\t\tschema: TablesRelationalConfig,\n\t\ttable: PgTable,\n\t\ttableConfig: TableRelationalConfig,\n\t\tdialect: PgDialect,\n\t\tsession: PgSession,\n\t\tconfig: DBQueryConfig<'many' | 'one'> | true,\n\t\tmode: 'many' | 'first',\n\t\tparseJson: boolean,\n\t): AnyPgRelationalQuery;\n}\n\nexport type AnyPgRelationalQuery = PgRelationalQuery<any, any>;\n\nexport class RelationalQueryBuilder<\n\tTSchema extends TablesRelationalConfig,\n\tTFields extends TableRelationalConfig,\n\tTBuilderHKT extends PgRelationalQueryHKTBase = PgRelationalQueryHKT,\n> {\n\tstatic readonly [entityKind]: string = 'PgRelationalQueryBuilderV2';\n\n\tconstructor(\n\t\tprivate schema: TSchema,\n\t\tprivate table: PgTable,\n\t\tprivate tableConfig: TableRelationalConfig,\n\t\tprivate dialect: PgDialect,\n\t\tprivate session: PgSession,\n\t\tprivate parseJson: boolean,\n\t\tprivate builder: PgRelationalQueryConstructor = PgRelationalQuery,\n\t) {}\n\n\tfindMany<TConfig extends DBQueryConfig<'many', TSchema, TFields>>(\n\t\tconfig?: KnownKeysOnly<TConfig, DBQueryConfig<'many', TSchema, TFields>>,\n\t): PgRelationalQueryKind<TBuilderHKT, BuildQueryResult<TSchema, TFields, TConfig>[]> {\n\t\treturn new this.builder(\n\t\t\tthis.schema,\n\t\t\tthis.table,\n\t\t\tthis.tableConfig,\n\t\t\tthis.dialect,\n\t\t\tthis.session,\n\t\t\tconfig as DBQueryConfig<'many'> | undefined ?? true,\n\t\t\t'many',\n\t\t\tthis.parseJson,\n\t\t);\n\t}\n\n\tfindFirst<TConfig extends DBQueryConfig<'one', TSchema, TFields>>(\n\t\tconfig?: KnownKeysOnly<TConfig, DBQueryConfig<'one', TSchema, TFields>>,\n\t): PgRelationalQueryKind<TBuilderHKT, BuildQueryResult<TSchema, TFields, TConfig> | undefined> {\n\t\treturn new this.builder(\n\t\t\tthis.schema,\n\t\t\tthis.table,\n\t\t\tthis.tableConfig,\n\t\t\tthis.dialect,\n\t\t\tthis.session,\n\t\t\tconfig as DBQueryConfig<'one'> | undefined ?? true,\n\t\t\t'first',\n\t\t\tthis.parseJson,\n\t\t);\n\t}\n}\n\nexport interface PgRelationalQueryHKTBase {\n\tresult: unknown;\n\t_type: unknown;\n}\n\nexport interface PgRelationalQueryHKT extends PgRelationalQueryHKTBase {\n\t_type: PgRelationalQuery<PgRelationalQueryHKT, this['result']>;\n}\n\nexport type PgRelationalQueryKind<\n\tT extends PgRelationalQueryHKTBase,\n\tTResult,\n> = (T & {\n\tresult: TResult;\n})['_type'];\n\nexport class PgRelationalQuery<THKT extends PgRelationalQueryHKTBase, TResult> implements SQLWrapper {\n\tstatic readonly [entityKind]: string = 'PgRelationalQueryV2';\n\n\tdeclare readonly _: {\n\t\treadonly dialect: 'pg';\n\t\treadonly hkt: THKT;\n\t\treadonly result: TResult;\n\t};\n\n\tconstructor(\n\t\tprotected schema: TablesRelationalConfig,\n\t\tprotected table: PgTable,\n\t\tprotected tableConfig: TableRelationalConfig,\n\t\tprotected dialect: PgDialect,\n\t\tprotected session: PgSession,\n\t\tprotected config: DBQueryConfig<'many' | 'one'> | true,\n\t\tprotected mode: 'many' | 'first',\n\t\tprotected parseJson: boolean,\n\t) {}\n\n\tprotected _getQuery() {\n\t\treturn this.dialect.buildRelationalQuery({\n\t\t\tschema: this.schema,\n\t\t\ttable: this.table,\n\t\t\ttableConfig: this.tableConfig,\n\t\t\tqueryConfig: this.config,\n\t\t\tmode: this.mode,\n\t\t});\n\t}\n\n\t/** @internal */\n\tgetSQL(): SQL {\n\t\treturn this._getQuery().sql;\n\t}\n\n\tprotected _toSQL(): { query: BuildRelationalQueryResult; builtQuery: QueryWithTypings } {\n\t\tconst query = this._getQuery();\n\n\t\tconst builtQuery = this.dialect.sqlToQuery(query.sql);\n\n\t\treturn { query, builtQuery };\n\t}\n\n\ttoSQL(): Query {\n\t\treturn this._toSQL().builtQuery;\n\t}\n}\n"],"mappings":";;;AA6BA,IAAa,yBAAb,MAIE;CACD,QAAiB,cAAsB;CAEvC,YACC,AAAQA,QACR,AAAQC,OACR,AAAQC,aACR,AAAQC,SACR,AAAQC,SACR,AAAQC,WACR,AAAQC,UAAwC,mBAC/C;EAPO;EACA;EACA;EACA;EACA;EACA;EACA;;CAGT,SACC,QACoF;AACpF,SAAO,IAAI,KAAK,QACf,KAAK,QACL,KAAK,OACL,KAAK,aACL,KAAK,SACL,KAAK,SACL,UAA+C,MAC/C,QACA,KAAK,UACL;;CAGF,UACC,QAC8F;AAC9F,SAAO,IAAI,KAAK,QACf,KAAK,QACL,KAAK,OACL,KAAK,aACL,KAAK,SACL,KAAK,SACL,UAA8C,MAC9C,SACA,KAAK,UACL;;;AAoBH,IAAa,oBAAb,MAAqG;CACpG,QAAiB,cAAsB;CAQvC,YACC,AAAUC,QACV,AAAUN,OACV,AAAUC,aACV,AAAUC,SACV,AAAUC,SACV,AAAUI,QACV,AAAUC,MACV,AAAUJ,WACT;EARS;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;CAGX,AAAU,YAAY;AACrB,SAAO,KAAK,QAAQ,qBAAqB;GACxC,QAAQ,KAAK;GACb,OAAO,KAAK;GACZ,aAAa,KAAK;GAClB,aAAa,KAAK;GAClB,MAAM,KAAK;GACX,CAAC;;;CAIH,SAAc;AACb,SAAO,KAAK,WAAW,CAAC;;CAGzB,AAAU,SAA8E;EACvF,MAAM,QAAQ,KAAK,WAAW;AAI9B,SAAO;GAAE;GAAO,YAFG,KAAK,QAAQ,WAAW,MAAM,IAAI;GAEzB;;CAG7B,QAAe;AACd,SAAO,KAAK,QAAQ,CAAC"}