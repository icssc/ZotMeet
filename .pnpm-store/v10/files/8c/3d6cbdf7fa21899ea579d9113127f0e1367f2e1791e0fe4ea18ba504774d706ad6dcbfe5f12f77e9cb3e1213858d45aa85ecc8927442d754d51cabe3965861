{"version":3,"sources":["../../src/build/generate-routes-manifest.ts"],"sourcesContent":["import type { NextConfigComplete } from '../server/config-shared'\nimport type { CustomRoutes } from '../lib/load-custom-routes'\nimport {\n  RSC_HEADER,\n  NEXT_ROUTER_STATE_TREE_HEADER,\n  NEXT_ROUTER_PREFETCH_HEADER,\n  NEXT_DID_POSTPONE_HEADER,\n  RSC_CONTENT_TYPE_HEADER,\n  NEXT_ROUTER_SEGMENT_PREFETCH_HEADER,\n  NEXT_REWRITTEN_PATH_HEADER,\n  NEXT_REWRITTEN_QUERY_HEADER,\n} from '../client/components/app-router-headers'\nimport {\n  RSC_SUFFIX,\n  RSC_SEGMENT_SUFFIX,\n  RSC_SEGMENTS_DIR_SUFFIX,\n  NEXT_RESUME_HEADER,\n} from '../lib/constants'\nimport { isDynamicRoute } from '../shared/lib/router/utils'\nimport { buildCustomRoute } from '../lib/build-custom-route'\nimport { isReservedPage, pageToRoute } from './utils'\nimport type { DynamicManifestRoute } from './utils'\nimport type { RoutesManifest, ManifestRoute } from './index'\nimport { sortPages } from '../shared/lib/router/utils/sortable-routes'\n\nexport interface GenerateRoutesManifestOptions {\n  pageKeys: {\n    pages: string[]\n    app?: string[]\n  }\n  config: NextConfigComplete\n  redirects: CustomRoutes['redirects']\n  headers: CustomRoutes['headers']\n  rewrites: CustomRoutes['rewrites']\n  restrictedRedirectPaths: string[]\n  isAppPPREnabled: boolean\n  appType: 'pages' | 'app' | 'hybrid'\n}\n\nexport interface GenerateRoutesManifestResult {\n  routesManifest: RoutesManifest\n  dynamicRoutes: Array<DynamicManifestRoute>\n  sourcePages: Map<string, string>\n}\n\n/**\n * Generates the routes manifest from the given page keys and configuration.\n * This function extracts the route manifest generation logic to be reusable\n * across different build contexts (webpack build, turbopack build, analyze, etc.)\n */\nexport function generateRoutesManifest(\n  options: GenerateRoutesManifestOptions\n): GenerateRoutesManifestResult {\n  const {\n    pageKeys,\n    config,\n    redirects,\n    headers,\n    rewrites,\n    restrictedRedirectPaths,\n    isAppPPREnabled,\n    appType,\n  } = options\n\n  const sortedRoutes = sortPages([...pageKeys.pages, ...(pageKeys.app ?? [])])\n  const staticRoutes: Array<ManifestRoute> = []\n  const dynamicRoutes: Array<DynamicManifestRoute> = []\n\n  /**\n   * A map of all the pages to their sourcePage value. This is only used for\n   * routes that have PPR enabled and clientSegmentEnabled is true.\n   */\n  const sourcePages = new Map<string, string>()\n\n  for (const route of sortedRoutes) {\n    if (isDynamicRoute(route)) {\n      dynamicRoutes.push(\n        pageToRoute(\n          route,\n          // This property is only relevant when PPR is enabled.\n          undefined\n        )\n      )\n    } else if (\n      !isReservedPage(route) ||\n      // don't consider /api reserved here\n      route.match(/^\\/(api(\\/|$))/)\n    ) {\n      staticRoutes.push(pageToRoute(route))\n    }\n  }\n\n  const routesManifest: RoutesManifest = {\n    version: 3,\n    pages404: true,\n    appType,\n    caseSensitive: !!config.experimental.caseSensitiveRoutes,\n    basePath: config.basePath,\n    redirects: redirects.map((r) =>\n      buildCustomRoute('redirect', r, restrictedRedirectPaths)\n    ),\n    headers: headers.map((r) => buildCustomRoute('header', r)),\n    rewrites: {\n      beforeFiles: rewrites.beforeFiles.map((r) =>\n        buildCustomRoute('rewrite', r)\n      ),\n      afterFiles: rewrites.afterFiles.map((r) =>\n        buildCustomRoute('rewrite', r)\n      ),\n      fallback: rewrites.fallback.map((r) => buildCustomRoute('rewrite', r)),\n    },\n    dynamicRoutes,\n    staticRoutes,\n    dataRoutes: [],\n    i18n: config.i18n || undefined,\n    rsc: {\n      header: RSC_HEADER,\n      // This vary header is used as a default. It is technically re-assigned in `base-server`,\n      // and may include an additional Vary option for `Next-URL`.\n      varyHeader: `${RSC_HEADER}, ${NEXT_ROUTER_STATE_TREE_HEADER}, ${NEXT_ROUTER_PREFETCH_HEADER}, ${NEXT_ROUTER_SEGMENT_PREFETCH_HEADER}`,\n      prefetchHeader: NEXT_ROUTER_PREFETCH_HEADER,\n      didPostponeHeader: NEXT_DID_POSTPONE_HEADER,\n      contentTypeHeader: RSC_CONTENT_TYPE_HEADER,\n      suffix: RSC_SUFFIX,\n      prefetchSegmentHeader: NEXT_ROUTER_SEGMENT_PREFETCH_HEADER,\n      prefetchSegmentSuffix: RSC_SEGMENT_SUFFIX,\n      prefetchSegmentDirSuffix: RSC_SEGMENTS_DIR_SUFFIX,\n      clientParamParsing: config.cacheComponents ?? false,\n      clientParamParsingOrigins: config.experimental.clientParamParsingOrigins,\n      dynamicRSCPrerender: isAppPPREnabled && config.cacheComponents === true,\n    },\n    rewriteHeaders: {\n      pathHeader: NEXT_REWRITTEN_PATH_HEADER,\n      queryHeader: NEXT_REWRITTEN_QUERY_HEADER,\n    },\n    skipProxyUrlNormalize: config.skipProxyUrlNormalize,\n    ppr: isAppPPREnabled\n      ? {\n          chain: {\n            headers: {\n              [NEXT_RESUME_HEADER]: '1',\n            },\n          },\n        }\n      : undefined,\n  }\n\n  return {\n    routesManifest,\n    dynamicRoutes,\n    sourcePages,\n  }\n}\n"],"names":["generateRoutesManifest","options","pageKeys","config","redirects","headers","rewrites","restrictedRedirectPaths","isAppPPREnabled","appType","sortedRoutes","sortPages","pages","app","staticRoutes","dynamicRoutes","sourcePages","Map","route","isDynamicRoute","push","pageToRoute","undefined","isReservedPage","match","routesManifest","version","pages404","caseSensitive","experimental","caseSensitiveRoutes","basePath","map","r","buildCustomRoute","beforeFiles","afterFiles","fallback","dataRoutes","i18n","rsc","header","RSC_HEADER","varyHeader","NEXT_ROUTER_STATE_TREE_HEADER","NEXT_ROUTER_PREFETCH_HEADER","NEXT_ROUTER_SEGMENT_PREFETCH_HEADER","prefetchHeader","didPostponeHeader","NEXT_DID_POSTPONE_HEADER","contentTypeHeader","RSC_CONTENT_TYPE_HEADER","suffix","RSC_SUFFIX","prefetchSegmentHeader","prefetchSegmentSuffix","RSC_SEGMENT_SUFFIX","prefetchSegmentDirSuffix","RSC_SEGMENTS_DIR_SUFFIX","clientParamParsing","cacheComponents","clientParamParsingOrigins","dynamicRSCPrerender","rewriteHeaders","pathHeader","NEXT_REWRITTEN_PATH_HEADER","queryHeader","NEXT_REWRITTEN_QUERY_HEADER","skipProxyUrlNormalize","ppr","chain","NEXT_RESUME_HEADER"],"mappings":";;;;+BAkDgBA;;;eAAAA;;;kCAvCT;2BAMA;uBACwB;kCACE;wBACW;gCAGlB;AA2BnB,SAASA,uBACdC,OAAsC;IAEtC,MAAM,EACJC,QAAQ,EACRC,MAAM,EACNC,SAAS,EACTC,OAAO,EACPC,QAAQ,EACRC,uBAAuB,EACvBC,eAAe,EACfC,OAAO,EACR,GAAGR;IAEJ,MAAMS,eAAeC,IAAAA,yBAAS,EAAC;WAAIT,SAASU,KAAK;WAAMV,SAASW,GAAG,IAAI,EAAE;KAAE;IAC3E,MAAMC,eAAqC,EAAE;IAC7C,MAAMC,gBAA6C,EAAE;IAErD;;;GAGC,GACD,MAAMC,cAAc,IAAIC;IAExB,KAAK,MAAMC,SAASR,aAAc;QAChC,IAAIS,IAAAA,qBAAc,EAACD,QAAQ;YACzBH,cAAcK,IAAI,CAChBC,IAAAA,mBAAW,EACTH,OACA,sDAAsD;YACtDI;QAGN,OAAO,IACL,CAACC,IAAAA,sBAAc,EAACL,UAChB,oCAAoC;QACpCA,MAAMM,KAAK,CAAC,mBACZ;YACAV,aAAaM,IAAI,CAACC,IAAAA,mBAAW,EAACH;QAChC;IACF;IAEA,MAAMO,iBAAiC;QACrCC,SAAS;QACTC,UAAU;QACVlB;QACAmB,eAAe,CAAC,CAACzB,OAAO0B,YAAY,CAACC,mBAAmB;QACxDC,UAAU5B,OAAO4B,QAAQ;QACzB3B,WAAWA,UAAU4B,GAAG,CAAC,CAACC,IACxBC,IAAAA,kCAAgB,EAAC,YAAYD,GAAG1B;QAElCF,SAASA,QAAQ2B,GAAG,CAAC,CAACC,IAAMC,IAAAA,kCAAgB,EAAC,UAAUD;QACvD3B,UAAU;YACR6B,aAAa7B,SAAS6B,WAAW,CAACH,GAAG,CAAC,CAACC,IACrCC,IAAAA,kCAAgB,EAAC,WAAWD;YAE9BG,YAAY9B,SAAS8B,UAAU,CAACJ,GAAG,CAAC,CAACC,IACnCC,IAAAA,kCAAgB,EAAC,WAAWD;YAE9BI,UAAU/B,SAAS+B,QAAQ,CAACL,GAAG,CAAC,CAACC,IAAMC,IAAAA,kCAAgB,EAAC,WAAWD;QACrE;QACAlB;QACAD;QACAwB,YAAY,EAAE;QACdC,MAAMpC,OAAOoC,IAAI,IAAIjB;QACrBkB,KAAK;YACHC,QAAQC,4BAAU;YAClB,yFAAyF;YACzF,4DAA4D;YAC5DC,YAAY,GAAGD,4BAAU,CAAC,EAAE,EAAEE,+CAA6B,CAAC,EAAE,EAAEC,6CAA2B,CAAC,EAAE,EAAEC,qDAAmC,EAAE;YACrIC,gBAAgBF,6CAA2B;YAC3CG,mBAAmBC,0CAAwB;YAC3CC,mBAAmBC,yCAAuB;YAC1CC,QAAQC,qBAAU;YAClBC,uBAAuBR,qDAAmC;YAC1DS,uBAAuBC,6BAAkB;YACzCC,0BAA0BC,kCAAuB;YACjDC,oBAAoBxD,OAAOyD,eAAe,IAAI;YAC9CC,2BAA2B1D,OAAO0B,YAAY,CAACgC,yBAAyB;YACxEC,qBAAqBtD,mBAAmBL,OAAOyD,eAAe,KAAK;QACrE;QACAG,gBAAgB;YACdC,YAAYC,4CAA0B;YACtCC,aAAaC,6CAA2B;QAC1C;QACAC,uBAAuBjE,OAAOiE,qBAAqB;QACnDC,KAAK7D,kBACD;YACE8D,OAAO;gBACLjE,SAAS;oBACP,CAACkE,6BAAkB,CAAC,EAAE;gBACxB;YACF;QACF,IACAjD;IACN;IAEA,OAAO;QACLG;QACAV;QACAC;IACF;AACF","ignoreList":[0]}