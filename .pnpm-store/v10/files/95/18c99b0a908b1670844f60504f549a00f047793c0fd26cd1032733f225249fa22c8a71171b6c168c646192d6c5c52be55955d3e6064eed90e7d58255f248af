{"version":3,"file":"query.cjs","names":["PgRelationalQuery","entityKind","tracer","QueryPromise"],"sources":["../../../src/pg-core/async/query.ts"],"sourcesContent":["import { entityKind } from '~/entity.ts';\nimport { QueryPromise } from '~/query-promise.ts';\nimport { mapRelationalRow } from '~/relations.ts';\nimport type { RunnableQuery } from '~/runnable-query.ts';\nimport { tracer } from '~/tracing.ts';\nimport { applyMixins, type NeonAuthToken } from '~/utils.ts';\nimport { PgRelationalQuery, type PgRelationalQueryHKTBase } from '../query-builders/query.ts';\nimport type { PreparedQueryConfig } from '../session.ts';\nimport type { PgAsyncPreparedQuery, PgAsyncSession } from './session.ts';\n\nexport type AnyPgAsyncRelationalQuery = PgAsyncRelationalQuery<any>;\n\nexport interface PgAsyncRelationalQueryHKT extends PgRelationalQueryHKTBase {\n\t_type: PgAsyncRelationalQuery<this['result']>;\n}\n\nexport interface PgAsyncRelationalQuery<TResult> extends QueryPromise<TResult> {}\nexport class PgAsyncRelationalQuery<TResult> extends PgRelationalQuery<PgAsyncRelationalQueryHKT, TResult>\n\timplements RunnableQuery<TResult, 'pg'>\n{\n\tstatic override readonly [entityKind]: string = 'PgAsyncRelationalQueryV2';\n\n\tdeclare protected session: PgAsyncSession;\n\n\t/** @internal */\n\t_prepare(name?: string): PgAsyncPreparedQuery<PreparedQueryConfig & { execute: TResult }> {\n\t\treturn tracer.startActiveSpan('drizzle.prepareQuery', () => {\n\t\t\tconst { query, builtQuery } = this._toSQL();\n\n\t\t\treturn this.session.prepareRelationalQuery<PreparedQueryConfig & { execute: TResult }>(\n\t\t\t\tbuiltQuery,\n\t\t\t\tundefined,\n\t\t\t\tname,\n\t\t\t\t(rawRows, mapColumnValue) => {\n\t\t\t\t\tconst rows = rawRows.map((row) => mapRelationalRow(row, query.selection, mapColumnValue, this.parseJson));\n\t\t\t\t\tif (this.mode === 'first') {\n\t\t\t\t\t\treturn rows[0] as TResult;\n\t\t\t\t\t}\n\t\t\t\t\treturn rows as TResult;\n\t\t\t\t},\n\t\t\t).setToken(this.authToken);\n\t\t});\n\t}\n\n\tprepare(name: string): PgAsyncPreparedQuery<PreparedQueryConfig & { execute: TResult }> {\n\t\treturn this._prepare(name);\n\t}\n\n\t/** @internal */\n\tprivate authToken?: NeonAuthToken;\n\t/** @internal */\n\tsetToken(token?: NeonAuthToken) {\n\t\tthis.authToken = token;\n\t\treturn this;\n\t}\n\n\texecute(placeholderValues?: Record<string, unknown>): Promise<TResult> {\n\t\treturn tracer.startActiveSpan('drizzle.operation', () => {\n\t\t\treturn this._prepare().execute(placeholderValues);\n\t\t});\n\t}\n}\n\napplyMixins(PgAsyncRelationalQuery, [QueryPromise]);\n"],"mappings":";;;;;;;;;AAiBA,IAAa,yBAAb,cAAqDA,uDAErD;CACC,QAA0BC,0BAAsB;;CAKhD,SAAS,MAAiF;AACzF,SAAOC,oBAAO,gBAAgB,8BAA8B;GAC3D,MAAM,EAAE,OAAO,eAAe,KAAK,QAAQ;AAE3C,UAAO,KAAK,QAAQ,uBACnB,YACA,QACA,OACC,SAAS,mBAAmB;IAC5B,MAAM,OAAO,QAAQ,KAAK,6CAAyB,KAAK,MAAM,WAAW,gBAAgB,KAAK,UAAU,CAAC;AACzG,QAAI,KAAK,SAAS,QACjB,QAAO,KAAK;AAEb,WAAO;KAER,CAAC,SAAS,KAAK,UAAU;IACzB;;CAGH,QAAQ,MAAgF;AACvF,SAAO,KAAK,SAAS,KAAK;;;CAI3B,AAAQ;;CAER,SAAS,OAAuB;AAC/B,OAAK,YAAY;AACjB,SAAO;;CAGR,QAAQ,mBAA+D;AACtE,SAAOA,oBAAO,gBAAgB,2BAA2B;AACxD,UAAO,KAAK,UAAU,CAAC,QAAQ,kBAAkB;IAChD;;;4BAIQ,wBAAwB,CAACC,gCAAa,CAAC"}