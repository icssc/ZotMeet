{"version":3,"file":"alias.cjs","names":["entityKind","table: Table | View","ignoreColumnAlias?: boolean","view: View","selection: TSelection","is","Column","Subquery","SQL","isSQLWrapper","alias: string","replaceOriginalName: boolean","Table","ViewBaseConfig","View","proxiedColumns: { [key: string]: any }","OriginalColumn","sql"],"sources":["../src/alias.ts"],"sourcesContent":["import type * as V1 from './_relations.ts';\nimport { OriginalColumn } from './column-common.ts';\nimport type { AnyColumn } from './column.ts';\nimport { Column } from './column.ts';\nimport { entityKind, is } from './entity.ts';\nimport { View } from './sql/sql.ts';\nimport { isSQLWrapper, SQL, sql } from './sql/sql.ts';\nimport { Subquery } from './subquery.ts';\nimport { Table } from './table.ts';\nimport { ViewBaseConfig } from './view-common.ts';\n\nexport class ColumnTableAliasProxyHandler<TColumn extends Column> implements ProxyHandler<TColumn> {\n\tstatic readonly [entityKind]: string = 'ColumnTableAliasProxyHandler';\n\n\tconstructor(private table: Table | View, private ignoreColumnAlias?: boolean) {}\n\n\tget(columnObj: TColumn, prop: string | symbol): any {\n\t\tif (prop === 'table') {\n\t\t\treturn this.table;\n\t\t}\n\n\t\tif (prop === 'isAlias' && this.ignoreColumnAlias) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn columnObj[prop as keyof TColumn];\n\t}\n}\n\nexport class ViewSelectionAliasProxyHandler<TSelection extends Record<string, unknown>>\n\timplements ProxyHandler<TSelection>\n{\n\tstatic readonly [entityKind]: string = 'ViewSelectionAliasProxyHandler';\n\n\tconstructor(protected view: View, protected selection: TSelection, private ignoreColumnAlias?: boolean) {}\n\n\tget(selection: TSelection, prop: string | symbol): any {\n\t\tconst value = selection[prop as keyof TSelection];\n\n\t\tif (is(value, Column)) return new Proxy(value, new ColumnTableAliasProxyHandler(this.view, this.ignoreColumnAlias));\n\t\tif (\n\t\t\tis(value, Subquery) || is(value, SQL) || is(value, SQL.Aliased) || isSQLWrapper(value)\n\t\t\t|| (typeof value !== 'object' || value === null)\n\t\t) return value;\n\n\t\treturn new Proxy(value as Record<string, unknown>, this);\n\t}\n}\n\nexport class TableAliasProxyHandler<T extends Table | View> implements ProxyHandler<T> {\n\tstatic readonly [entityKind]: string = 'TableAliasProxyHandler';\n\n\tconstructor(private alias: string, private replaceOriginalName: boolean, private ignoreColumnAlias?: boolean) {}\n\n\tget(target: T, prop: string | symbol): any {\n\t\tif (prop === Table.Symbol.IsAlias) {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (prop === Table.Symbol.Name) {\n\t\t\treturn this.alias;\n\t\t}\n\n\t\tif (this.replaceOriginalName && prop === Table.Symbol.OriginalName) {\n\t\t\treturn this.alias;\n\t\t}\n\n\t\tif (prop === ViewBaseConfig) {\n\t\t\treturn {\n\t\t\t\t...target[ViewBaseConfig as keyof typeof target],\n\t\t\t\tname: this.alias,\n\t\t\t\tisAlias: true,\n\t\t\t\tselectedFields: new Proxy(\n\t\t\t\t\t(<View> target)[ViewBaseConfig].selectedFields,\n\t\t\t\t\tnew ViewSelectionAliasProxyHandler(\n\t\t\t\t\t\tnew Proxy(target, this) as View,\n\t\t\t\t\t\t(<View> target)[ViewBaseConfig].selectedFields,\n\t\t\t\t\t\tthis.ignoreColumnAlias,\n\t\t\t\t\t),\n\t\t\t\t),\n\t\t\t};\n\t\t}\n\n\t\tif (prop === Table.Symbol.Columns) {\n\t\t\tconst columns = (target as Table)[Table.Symbol.Columns];\n\t\t\tif (!columns) {\n\t\t\t\treturn columns;\n\t\t\t}\n\n\t\t\tif (is(target, View)) {\n\t\t\t\treturn new Proxy(\n\t\t\t\t\t(<View> target)[Table.Symbol.Columns],\n\t\t\t\t\tnew ViewSelectionAliasProxyHandler(\n\t\t\t\t\t\tnew Proxy(target, this) as View,\n\t\t\t\t\t\t(<View> target)[Table.Symbol.Columns],\n\t\t\t\t\t\tthis.ignoreColumnAlias,\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst proxiedColumns: { [key: string]: any } = {};\n\n\t\t\tObject.keys(columns).map((key) => {\n\t\t\t\tproxiedColumns[key] = new Proxy(\n\t\t\t\t\tcolumns[key]!,\n\t\t\t\t\tnew ColumnTableAliasProxyHandler(new Proxy(target, this), this.ignoreColumnAlias),\n\t\t\t\t);\n\t\t\t});\n\n\t\t\treturn proxiedColumns;\n\t\t}\n\n\t\tconst value = target[prop as keyof typeof target];\n\t\tif (is(value, Column)) {\n\t\t\treturn new Proxy(\n\t\t\t\tvalue as AnyColumn,\n\t\t\t\tnew ColumnTableAliasProxyHandler(new Proxy(target, this), this.ignoreColumnAlias),\n\t\t\t);\n\t\t}\n\n\t\treturn value;\n\t}\n}\n\nexport class ColumnAliasProxyHandler<T extends Column> implements ProxyHandler<T> {\n\tstatic readonly [entityKind]: string = 'ColumnAliasProxyHandler';\n\n\tconstructor(private alias: string) {}\n\n\tget(target: T, prop: keyof Column): any {\n\t\tif (prop === 'isAlias') {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (prop === 'name') {\n\t\t\treturn this.alias;\n\t\t}\n\n\t\tif (prop === 'keyAsName') {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (prop === OriginalColumn) {\n\t\t\treturn () => target;\n\t\t}\n\n\t\treturn target[prop];\n\t}\n}\n\nexport class RelationTableAliasProxyHandler<T extends V1.Relation> implements ProxyHandler<T> {\n\tstatic readonly [entityKind]: string = 'RelationTableAliasProxyHandler';\n\n\tconstructor(private alias: string) {}\n\n\tget(target: T, prop: string | symbol): any {\n\t\tif (prop === 'sourceTable') {\n\t\t\treturn aliasedTable(target.sourceTable, this.alias);\n\t\t}\n\n\t\treturn target[prop as keyof typeof target];\n\t}\n}\n\nexport function aliasedTable<T extends Table | View>(table: T, tableAlias: string): T {\n\treturn new Proxy(table, new TableAliasProxyHandler(tableAlias, false, false));\n}\n\nexport function aliasedColumn<T extends Column>(column: T, alias: string): T {\n\treturn new Proxy(column, new ColumnAliasProxyHandler(alias));\n}\n\nexport function aliasedRelation<T extends V1.Relation>(relation: T, tableAlias: string): T {\n\treturn new Proxy(relation, new RelationTableAliasProxyHandler(tableAlias));\n}\n\nexport function aliasedTableColumn<T extends AnyColumn>(column: T, tableAlias: string): T {\n\treturn new Proxy(\n\t\tcolumn,\n\t\tnew ColumnTableAliasProxyHandler(\n\t\t\tnew Proxy(column.table, new TableAliasProxyHandler(tableAlias, false, false)),\n\t\t\tfalse,\n\t\t),\n\t);\n}\n\nexport function mapColumnsInAliasedSQLToAlias(query: SQL.Aliased, alias: string): SQL.Aliased {\n\treturn new SQL.Aliased(mapColumnsInSQLToAlias(query.sql, alias), query.fieldAlias);\n}\n\nexport function mapColumnsInSQLToAlias(query: SQL, alias: string): SQL {\n\treturn sql.join(query.queryChunks.map((c) => {\n\t\tif (is(c, Column)) {\n\t\t\treturn aliasedTableColumn(c, alias);\n\t\t}\n\t\tif (is(c, SQL)) {\n\t\t\treturn mapColumnsInSQLToAlias(c, alias);\n\t\t}\n\t\tif (is(c, SQL.Aliased)) {\n\t\t\treturn mapColumnsInAliasedSQLToAlias(c, alias);\n\t\t}\n\t\treturn c;\n\t}));\n}\n\n// Defined separately from the Column class to resolve circular dependency\nColumn.prototype.as = function(alias: string): Column {\n\treturn aliasedColumn(this, alias);\n};\n\nexport function getOriginalColumnFromAlias<T extends Column>(column: T): T {\n\treturn column[OriginalColumn]();\n}\n"],"mappings":"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"}