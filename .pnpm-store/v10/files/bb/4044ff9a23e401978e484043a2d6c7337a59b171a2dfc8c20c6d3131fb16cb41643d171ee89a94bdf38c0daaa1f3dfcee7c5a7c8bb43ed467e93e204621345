const require_rolldown_runtime = require('./_virtual/rolldown_runtime.cjs');
const require_migrator_utils = require('./migrator.utils.cjs');
let node_crypto = require("node:crypto");
node_crypto = require_rolldown_runtime.__toESM(node_crypto);
let node_fs = require("node:fs");
node_fs = require_rolldown_runtime.__toESM(node_fs);
let node_path = require("node:path");

//#region src/migrator.ts
function readMigrationFilesOLD(config) {
	const migrationFolderTo = config.migrationsFolder;
	const migrationQueries = [];
	const journalPath = `${migrationFolderTo}/meta/_journal.json`;
	const journalAsString = node_fs.default.readFileSync(journalPath).toString();
	const journal = JSON.parse(journalAsString);
	for (const journalEntry of journal.entries) {
		const migrationPath = `${migrationFolderTo}/${journalEntry.tag}.sql`;
		try {
			const query = node_fs.default.readFileSync(`${migrationFolderTo}/${journalEntry.tag}.sql`).toString();
			const result = query.split("--> statement-breakpoint").map((it) => {
				return it;
			});
			migrationQueries.push({
				sql: result,
				bps: journalEntry.breakpoints,
				folderMillis: journalEntry.when,
				hash: node_crypto.default.createHash("sha256").update(query).digest("hex")
			});
		} catch {
			throw new Error(`No file ${migrationPath} found in ${migrationFolderTo} folder`);
		}
	}
	return migrationQueries;
}
function readMigrationFiles(config) {
	if (node_fs.default.existsSync(`${config.migrationsFolder}/meta/_journal.json`)) {
		console.log("\nWarning: We detected that you have old drizzle-kit migration folders. We suggest to upgrade drizzle-kit and run \"drizzle-kit up\"\n");
		return readMigrationFilesOLD(config);
	}
	const migrationFolderTo = config.migrationsFolder;
	const migrationQueries = [];
	const migrations = (0, node_fs.readdirSync)(migrationFolderTo).map((subdir) => ({
		path: (0, node_path.join)(migrationFolderTo, subdir, "migration.sql"),
		name: subdir
	})).filter((it) => (0, node_fs.existsSync)(it.path));
	migrations.sort((a, b) => a.name.localeCompare(b.name));
	for (const migration of migrations) {
		const migrationPath = migration.path;
		const migrationDate = migration.name.slice(0, 14);
		const query = node_fs.default.readFileSync(migrationPath).toString();
		const result = query.split("--> statement-breakpoint").map((it) => {
			return it;
		});
		const millis = require_migrator_utils.formatToMillis(migrationDate);
		migrationQueries.push({
			sql: result,
			bps: true,
			folderMillis: millis,
			hash: node_crypto.default.createHash("sha256").update(query).digest("hex")
		});
	}
	return migrationQueries;
}

//#endregion
exports.readMigrationFiles = readMigrationFiles;
//# sourceMappingURL=migrator.cjs.map