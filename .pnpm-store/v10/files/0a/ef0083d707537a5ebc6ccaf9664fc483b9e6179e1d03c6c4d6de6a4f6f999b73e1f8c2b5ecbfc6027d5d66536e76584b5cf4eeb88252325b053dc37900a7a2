{"version":3,"file":"blob.js","names":[],"sources":["../../../src/sqlite-core/columns/blob.ts"],"sourcesContent":["import type { ColumnBaseConfig } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { SQLiteTable } from '~/sqlite-core/table.ts';\nimport { type Equal, getColumnNameAndConfig, textDecoder } from '~/utils.ts';\nimport { SQLiteColumn, SQLiteColumnBuilder } from './common.ts';\n\ntype BlobMode = 'buffer' | 'json' | 'bigint';\n\nfunction hexToText(hexString: string) {\n\tlet result = '';\n\tfor (let i = 0; i < hexString.length; i += 2) {\n\t\tconst hexPair = hexString.slice(i, i + 2);\n\t\tconst decimalValue = Number.parseInt(hexPair, 16);\n\t\tresult += String.fromCodePoint(decimalValue);\n\t}\n\treturn result;\n}\n\nexport class SQLiteBigIntBuilder extends SQLiteColumnBuilder<{\n\tdataType: 'bigint int64';\n\tdata: bigint;\n\tdriverParam: Buffer;\n}> {\n\tstatic override readonly [entityKind]: string = 'SQLiteBigIntBuilder';\n\n\tconstructor(name: string) {\n\t\tsuper(name, 'bigint int64', 'SQLiteBigInt');\n\t}\n\n\t/** @internal */\n\toverride build(table: SQLiteTable) {\n\t\treturn new SQLiteBigInt(table, this.config as any);\n\t}\n}\n\nexport class SQLiteBigInt<T extends ColumnBaseConfig<'bigint int64'>> extends SQLiteColumn<T> {\n\tstatic override readonly [entityKind]: string = 'SQLiteBigInt';\n\n\tgetSQLType(): string {\n\t\treturn 'blob';\n\t}\n\n\toverride mapFromDriverValue(value: Buffer | Uint8Array | ArrayBuffer | string): bigint {\n\t\t// For RQBv2\n\t\tif (typeof value === 'string') {\n\t\t\treturn BigInt(hexToText(value));\n\t\t}\n\n\t\tif (typeof Buffer !== 'undefined' && Buffer.from) {\n\t\t\tconst buf = Buffer.isBuffer(value)\n\t\t\t\t? value\n\t\t\t\t// oxlint-disable-next-line drizzle-internal/no-instanceof\n\t\t\t\t: value instanceof ArrayBuffer\n\t\t\t\t? Buffer.from(value)\n\t\t\t\t: value.buffer\n\t\t\t\t? Buffer.from(value.buffer, value.byteOffset, value.byteLength)\n\t\t\t\t: Buffer.from(value);\n\t\t\treturn BigInt(buf.toString('utf8'));\n\t\t}\n\n\t\treturn BigInt(textDecoder!.decode(value as ArrayBuffer));\n\t}\n\n\toverride mapToDriverValue(value: bigint): Buffer {\n\t\treturn Buffer.from(value.toString());\n\t}\n}\n\nexport class SQLiteBlobJsonBuilder extends SQLiteColumnBuilder<{\n\tdataType: 'object json';\n\tdata: unknown;\n\tdriverParam: Buffer;\n}> {\n\tstatic override readonly [entityKind]: string = 'SQLiteBlobJsonBuilder';\n\n\tconstructor(name: string) {\n\t\tsuper(name, 'object json', 'SQLiteBlobJson');\n\t}\n\n\t/** @internal */\n\toverride build(table: SQLiteTable) {\n\t\treturn new SQLiteBlobJson(\n\t\t\ttable,\n\t\t\tthis.config as any,\n\t\t);\n\t}\n}\n\nexport class SQLiteBlobJson<T extends ColumnBaseConfig<'object json'>> extends SQLiteColumn<T> {\n\tstatic override readonly [entityKind]: string = 'SQLiteBlobJson';\n\n\tgetSQLType(): string {\n\t\treturn 'blob';\n\t}\n\n\toverride mapFromDriverValue(value: Buffer | Uint8Array | ArrayBuffer | string): T['data'] {\n\t\t// For RQBv2\n\t\tif (typeof value === 'string') {\n\t\t\treturn JSON.parse(hexToText(value));\n\t\t}\n\n\t\tif (typeof Buffer !== 'undefined' && Buffer.from) {\n\t\t\tconst buf = Buffer.isBuffer(value)\n\t\t\t\t? value\n\t\t\t\t// oxlint-disable-next-line drizzle-internal/no-instanceof\n\t\t\t\t: value instanceof ArrayBuffer\n\t\t\t\t? Buffer.from(value)\n\t\t\t\t: value.buffer\n\t\t\t\t? Buffer.from(value.buffer, value.byteOffset, value.byteLength)\n\t\t\t\t: Buffer.from(value);\n\t\t\treturn JSON.parse(buf.toString('utf8'));\n\t\t}\n\n\t\treturn JSON.parse(textDecoder!.decode(value as ArrayBuffer));\n\t}\n\n\toverride mapToDriverValue(value: T['data']): Buffer {\n\t\treturn Buffer.from(JSON.stringify(value));\n\t}\n}\n\nexport class SQLiteBlobBufferBuilder extends SQLiteColumnBuilder<{\n\tdataType: 'object buffer';\n\tdata: Buffer;\n\tdriverParam: Buffer;\n}> {\n\tstatic override readonly [entityKind]: string = 'SQLiteBlobBufferBuilder';\n\n\tconstructor(name: string) {\n\t\tsuper(name, 'object buffer', 'SQLiteBlobBuffer');\n\t}\n\n\t/** @internal */\n\toverride build(table: SQLiteTable) {\n\t\treturn new SQLiteBlobBuffer(table, this.config as any);\n\t}\n}\n\nexport class SQLiteBlobBuffer<T extends ColumnBaseConfig<'object buffer'>> extends SQLiteColumn<T> {\n\tstatic override readonly [entityKind]: string = 'SQLiteBlobBuffer';\n\n\toverride mapFromDriverValue(value: Buffer | Uint8Array | ArrayBuffer): T['data'] {\n\t\tif (Buffer.isBuffer(value)) {\n\t\t\treturn value;\n\t\t}\n\n\t\t// For RQBv2\n\t\tif (typeof value === 'string') {\n\t\t\treturn Buffer.from(value, 'hex');\n\t\t}\n\n\t\treturn Buffer.from(value as Uint8Array);\n\t}\n\n\tgetSQLType(): string {\n\t\treturn 'blob';\n\t}\n}\n\nexport interface BlobConfig<TMode extends BlobMode = BlobMode> {\n\tmode: TMode;\n}\n\n/**\n *  It's recommended to use `text('...', { mode: 'json' })` instead of `blob` in JSON mode, because it supports JSON functions:\n * >All JSON functions currently throw an error if any of their arguments are BLOBs because BLOBs are reserved for a future enhancement in which BLOBs will store the binary encoding for JSON.\n *\n * https://www.sqlite.org/json1.html\n */\nexport function blob<TMode extends BlobMode = BlobMode>(\n\tconfig?: BlobConfig<TMode>,\n): Equal<TMode, 'bigint'> extends true ? SQLiteBigIntBuilder\n\t: Equal<TMode, 'buffer'> extends true ? SQLiteBlobBufferBuilder\n\t: SQLiteBlobJsonBuilder;\nexport function blob<TMode extends BlobMode = BlobMode>(\n\tname: string,\n\tconfig?: BlobConfig<TMode>,\n): Equal<TMode, 'bigint'> extends true ? SQLiteBigIntBuilder\n\t: Equal<TMode, 'buffer'> extends true ? SQLiteBlobBufferBuilder\n\t: SQLiteBlobJsonBuilder;\nexport function blob(a?: string | BlobConfig, b?: BlobConfig) {\n\tconst { name, config } = getColumnNameAndConfig<BlobConfig | undefined>(a, b);\n\tif (config?.mode === 'json') {\n\t\treturn new SQLiteBlobJsonBuilder(name);\n\t}\n\tif (config?.mode === 'bigint') {\n\t\treturn new SQLiteBigIntBuilder(name);\n\t}\n\treturn new SQLiteBlobBufferBuilder(name);\n}\n"],"mappings":"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"}