{"version":3,"file":"migrator.cjs","names":["migrationQueries: MigrationMeta[]","sql","error: any"],"sources":["../../src/durable-sqlite/migrator.ts"],"sourcesContent":["import type { MigrationMeta, MigratorInitFailResponse } from '~/migrator.ts';\nimport { formatToMillis } from '~/migrator.utils.ts';\nimport type { AnyRelations } from '~/relations.ts';\nimport { sql } from '~/sql/index.ts';\nimport type { DrizzleSqliteDODatabase } from './driver.ts';\n\ninterface MigrationConfig {\n\tmigrations: Record<string, string>;\n\t/** @internal */\n\tinit?: boolean;\n}\n\nfunction readMigrationFiles({ migrations }: MigrationConfig): MigrationMeta[] {\n\tconst migrationQueries: MigrationMeta[] = [];\n\n\tconst sortedMigrations = Object.keys(migrations).sort();\n\n\tfor (const key of sortedMigrations) {\n\t\tconst query = migrations[key];\n\t\tif (!query) {\n\t\t\tthrow new Error(`Missing migration: ${key}`);\n\t\t}\n\n\t\ttry {\n\t\t\tconst result = query.split('--> statement-breakpoint').map((it) => {\n\t\t\t\treturn it;\n\t\t\t});\n\n\t\t\tconst migrationDate = formatToMillis(key.slice(0, 14));\n\n\t\t\tmigrationQueries.push({\n\t\t\t\tsql: result,\n\t\t\t\tbps: true,\n\t\t\t\tfolderMillis: migrationDate,\n\t\t\t\thash: '',\n\t\t\t});\n\t\t} catch {\n\t\t\tthrow new Error(`Failed to parse migration: ${key}`);\n\t\t}\n\t}\n\n\treturn migrationQueries;\n}\n\nexport async function migrate<\n\tTSchema extends Record<string, unknown>,\n\tTRelations extends AnyRelations,\n>(\n\tdb: DrizzleSqliteDODatabase<TSchema, TRelations>,\n\tconfig: MigrationConfig,\n): Promise<void | MigratorInitFailResponse> {\n\tconst migrations = readMigrationFiles(config);\n\n\treturn await db.transaction((tx) => {\n\t\ttry {\n\t\t\tconst migrationsTable = '__drizzle_migrations';\n\n\t\t\tconst migrationTableCreate = sql`\n\t\t\t\tCREATE TABLE IF NOT EXISTS ${sql.identifier(migrationsTable)} (\n\t\t\t\t\tid SERIAL PRIMARY KEY,\n\t\t\t\t\thash text NOT NULL,\n\t\t\t\t\tcreated_at numeric\n\t\t\t\t)\n\t\t\t`;\n\t\t\tdb.run(migrationTableCreate);\n\n\t\t\tconst dbMigrations = db.values<[number, string, string]>(\n\t\t\t\tsql`SELECT id, hash, created_at FROM ${sql.identifier(migrationsTable)} ORDER BY created_at DESC LIMIT 1`,\n\t\t\t);\n\n\t\t\tif (config.init) {\n\t\t\t\tif (dbMigrations.length) {\n\t\t\t\t\treturn { exitCode: 'databaseMigrations' as const };\n\t\t\t\t}\n\n\t\t\t\tif (migrations.length > 1) {\n\t\t\t\t\treturn { exitCode: 'localMigrations' as const };\n\t\t\t\t}\n\n\t\t\t\tconst [migration] = migrations;\n\n\t\t\t\tif (!migration) return;\n\n\t\t\t\tdb.run(\n\t\t\t\t\tsql`insert into ${\n\t\t\t\t\t\tsql.identifier(migrationsTable)\n\t\t\t\t\t} (\"hash\", \"created_at\") values(${migration.hash}, ${migration.folderMillis})`,\n\t\t\t\t);\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst lastDbMigration = dbMigrations[0] ?? undefined;\n\t\t\tfor (const migration of migrations) {\n\t\t\t\tif (!lastDbMigration || Number(lastDbMigration[2])! < migration.folderMillis) {\n\t\t\t\t\tfor (const stmt of migration.sql) {\n\t\t\t\t\t\tdb.run(sql.raw(stmt));\n\t\t\t\t\t}\n\t\t\t\t\tdb.run(\n\t\t\t\t\t\tsql`INSERT INTO ${\n\t\t\t\t\t\t\tsql.identifier(migrationsTable)\n\t\t\t\t\t\t} (\"hash\", \"created_at\") VALUES(${migration.hash}, ${migration.folderMillis})`,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn;\n\t\t} catch (error: any) {\n\t\t\ttx.rollback();\n\t\t\tthrow error;\n\t\t}\n\t});\n}\n"],"mappings":";;;;;AAYA,SAAS,mBAAmB,EAAE,cAAgD;CAC7E,MAAMA,mBAAoC,EAAE;CAE5C,MAAM,mBAAmB,OAAO,KAAK,WAAW,CAAC,MAAM;AAEvD,MAAK,MAAM,OAAO,kBAAkB;EACnC,MAAM,QAAQ,WAAW;AACzB,MAAI,CAAC,MACJ,OAAM,IAAI,MAAM,sBAAsB,MAAM;AAG7C,MAAI;GACH,MAAM,SAAS,MAAM,MAAM,2BAA2B,CAAC,KAAK,OAAO;AAClE,WAAO;KACN;GAEF,MAAM,wDAA+B,IAAI,MAAM,GAAG,GAAG,CAAC;AAEtD,oBAAiB,KAAK;IACrB,KAAK;IACL,KAAK;IACL,cAAc;IACd,MAAM;IACN,CAAC;UACK;AACP,SAAM,IAAI,MAAM,8BAA8B,MAAM;;;AAItD,QAAO;;AAGR,eAAsB,QAIrB,IACA,QAC2C;CAC3C,MAAM,aAAa,mBAAmB,OAAO;AAE7C,QAAO,MAAM,GAAG,aAAa,OAAO;AACnC,MAAI;GACH,MAAM,kBAAkB;GAExB,MAAM,uBAAuB,kBAAG;iCACFC,mBAAI,WAAW,gBAAgB,CAAC;;;;;;AAM9D,MAAG,IAAI,qBAAqB;GAE5B,MAAM,eAAe,GAAG,OACvB,kBAAG,oCAAoCA,mBAAI,WAAW,gBAAgB,CAAC,mCACvE;AAED,OAAI,OAAO,MAAM;AAChB,QAAI,aAAa,OAChB,QAAO,EAAE,UAAU,sBAA+B;AAGnD,QAAI,WAAW,SAAS,EACvB,QAAO,EAAE,UAAU,mBAA4B;IAGhD,MAAM,CAAC,aAAa;AAEpB,QAAI,CAAC,UAAW;AAEhB,OAAG,IACF,kBAAG,eACFA,mBAAI,WAAW,gBAAgB,CAC/B,iCAAiC,UAAU,KAAK,IAAI,UAAU,aAAa,GAC5E;AAED;;GAGD,MAAM,kBAAkB,aAAa,MAAM;AAC3C,QAAK,MAAM,aAAa,WACvB,KAAI,CAAC,mBAAmB,OAAO,gBAAgB,GAAG,GAAI,UAAU,cAAc;AAC7E,SAAK,MAAM,QAAQ,UAAU,IAC5B,IAAG,IAAIA,mBAAI,IAAI,KAAK,CAAC;AAEtB,OAAG,IACF,kBAAG,eACFA,mBAAI,WAAW,gBAAgB,CAC/B,iCAAiC,UAAU,KAAK,IAAI,UAAU,aAAa,GAC5E;;AAIH;WACQC,OAAY;AACpB,MAAG,UAAU;AACb,SAAM;;GAEN"}