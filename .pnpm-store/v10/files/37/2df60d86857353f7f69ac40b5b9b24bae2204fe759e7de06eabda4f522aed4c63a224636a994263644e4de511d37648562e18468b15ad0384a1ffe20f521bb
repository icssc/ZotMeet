{"version":3,"file":"migrator.cjs","names":["sql","queriesToRun: string[]"],"sources":["../../src/mysql-proxy/migrator.ts"],"sourcesContent":["import type { MigrationConfig, MigratorInitFailResponse } from '~/migrator.ts';\nimport { readMigrationFiles } from '~/migrator.ts';\nimport type { AnyRelations } from '~/relations.ts';\nimport { sql } from '~/sql/sql.ts';\nimport type { MySqlRemoteDatabase } from './driver.ts';\n\nexport type ProxyMigrator = (migrationQueries: string[]) => Promise<void>;\n\nexport async function migrate<TSchema extends Record<string, unknown>, TRelations extends AnyRelations>(\n\tdb: MySqlRemoteDatabase<TSchema, TRelations>,\n\tcallback: ProxyMigrator,\n\tconfig: MigrationConfig,\n): Promise<void | MigratorInitFailResponse> {\n\tconst migrations = readMigrationFiles(config);\n\n\tconst migrationsTable = config.migrationsTable ?? '__drizzle_migrations';\n\tconst migrationTableCreate = sql`\n\t\tcreate table if not exists ${sql.identifier(migrationsTable)} (\n\t\t\tid serial primary key,\n\t\t\thash text not null,\n\t\t\tcreated_at bigint\n\t\t)\n\t`;\n\tawait db.execute(migrationTableCreate);\n\n\tconst dbMigrations = await db.select({\n\t\tid: sql.raw('id'),\n\t\thash: sql.raw('hash'),\n\t\tcreated_at: sql.raw('created_at'),\n\t}).from(sql.identifier(migrationsTable).getSQL()).orderBy(\n\t\tsql.raw('created_at desc'),\n\t).limit(1);\n\n\tif (typeof config === 'object' && config.init) {\n\t\tif (dbMigrations.length) {\n\t\t\treturn { exitCode: 'databaseMigrations' as const };\n\t\t}\n\n\t\tif (migrations.length > 1) {\n\t\t\treturn { exitCode: 'localMigrations' as const };\n\t\t}\n\n\t\tconst [migration] = migrations;\n\n\t\tif (!migration) return;\n\n\t\tawait callback([\n\t\t\tdb.dialect.sqlToQuery(\n\t\t\t\tsql`insert into ${\n\t\t\t\t\tsql.identifier(migrationsTable)\n\t\t\t\t} (\\`hash\\`, \\`created_at\\`) values(${migration.hash}, '${migration.folderMillis}')`.inlineParams(),\n\t\t\t).sql,\n\t\t]);\n\n\t\treturn;\n\t}\n\n\tconst lastDbMigration = dbMigrations[0];\n\tconst queriesToRun: string[] = [];\n\tfor (const migration of migrations) {\n\t\tif (\n\t\t\t!lastDbMigration\n\t\t\t|| Number(lastDbMigration.created_at) < migration.folderMillis\n\t\t) {\n\t\t\tqueriesToRun.push(\n\t\t\t\t...migration.sql,\n\t\t\t\tdb.dialect.sqlToQuery(\n\t\t\t\t\tsql`insert into ${\n\t\t\t\t\t\tsql.identifier(migrationsTable)\n\t\t\t\t\t} (\\`hash\\`, \\`created_at\\`) values(${migration.hash}, '${migration.folderMillis}')`.inlineParams(),\n\t\t\t\t).sql,\n\t\t\t);\n\t\t}\n\t}\n\n\tawait callback(queriesToRun);\n}\n"],"mappings":";;;;;AAQA,eAAsB,QACrB,IACA,UACA,QAC2C;CAC3C,MAAM,mDAAgC,OAAO;CAE7C,MAAM,kBAAkB,OAAO,mBAAmB;CAClD,MAAM,uBAAuB,gBAAG;+BACFA,iBAAI,WAAW,gBAAgB,CAAC;;;;;;AAM9D,OAAM,GAAG,QAAQ,qBAAqB;CAEtC,MAAM,eAAe,MAAM,GAAG,OAAO;EACpC,IAAIA,iBAAI,IAAI,KAAK;EACjB,MAAMA,iBAAI,IAAI,OAAO;EACrB,YAAYA,iBAAI,IAAI,aAAa;EACjC,CAAC,CAAC,KAAKA,iBAAI,WAAW,gBAAgB,CAAC,QAAQ,CAAC,CAAC,QACjDA,iBAAI,IAAI,kBAAkB,CAC1B,CAAC,MAAM,EAAE;AAEV,KAAI,OAAO,WAAW,YAAY,OAAO,MAAM;AAC9C,MAAI,aAAa,OAChB,QAAO,EAAE,UAAU,sBAA+B;AAGnD,MAAI,WAAW,SAAS,EACvB,QAAO,EAAE,UAAU,mBAA4B;EAGhD,MAAM,CAAC,aAAa;AAEpB,MAAI,CAAC,UAAW;AAEhB,QAAM,SAAS,CACd,GAAG,QAAQ,WACV,gBAAG,eACFA,iBAAI,WAAW,gBAAgB,CAC/B,qCAAqC,UAAU,KAAK,KAAK,UAAU,aAAa,IAAI,cAAc,CACnG,CAAC,IACF,CAAC;AAEF;;CAGD,MAAM,kBAAkB,aAAa;CACrC,MAAMC,eAAyB,EAAE;AACjC,MAAK,MAAM,aAAa,WACvB,KACC,CAAC,mBACE,OAAO,gBAAgB,WAAW,GAAG,UAAU,aAElD,cAAa,KACZ,GAAG,UAAU,KACb,GAAG,QAAQ,WACV,gBAAG,eACFD,iBAAI,WAAW,gBAAgB,CAC/B,qCAAqC,UAAU,KAAK,KAAK,UAAU,aAAa,IAAI,cAAc,CACnG,CAAC,IACF;AAIH,OAAM,SAAS,aAAa"}