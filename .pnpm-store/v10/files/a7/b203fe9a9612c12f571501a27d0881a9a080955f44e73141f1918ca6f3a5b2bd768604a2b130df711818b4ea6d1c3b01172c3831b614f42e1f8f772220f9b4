{"version":3,"file":"view.cjs","names":["entityKind","name: TConfig['name']","schema: string | undefined","QueryBuilder","SelectionProxyHandler","cockroachTable","CockroachViewBase"],"sources":["../../src/cockroach-core/view.ts"],"sourcesContent":["import type { BuildColumns, ColumnBuilderBase } from '~/column-builder.ts';\nimport { entityKind, is } from '~/entity.ts';\nimport type { TypedQueryBuilder } from '~/query-builders/query-builder.ts';\nimport type { AddAliasToSelection } from '~/query-builders/select.types.ts';\nimport { SelectionProxyHandler } from '~/selection-proxy.ts';\nimport type { ColumnsSelection, SQL } from '~/sql/sql.ts';\nimport { getTableColumns } from '~/utils.ts';\nimport type { CockroachColumn } from './columns/common.ts';\nimport { QueryBuilder } from './query-builders/query-builder.ts';\nimport { cockroachTable } from './table.ts';\nimport { CockroachViewBase } from './view-base.ts';\n\nexport class DefaultViewBuilderCore<TConfig extends { name: string; columns?: unknown }> {\n\tstatic readonly [entityKind]: string = 'CockroachDefaultViewBuilderCore';\n\n\tdeclare readonly _: {\n\t\treadonly name: TConfig['name'];\n\t\treadonly columns: TConfig['columns'];\n\t};\n\n\tconstructor(\n\t\tprotected name: TConfig['name'],\n\t\tprotected schema: string | undefined,\n\t) {}\n}\n\nexport class ViewBuilder<TName extends string = string> extends DefaultViewBuilderCore<{ name: TName }> {\n\tstatic override readonly [entityKind]: string = 'CockroachViewBuilder';\n\n\tas<TSelectedFields extends ColumnsSelection>(\n\t\tqb: TypedQueryBuilder<TSelectedFields> | ((qb: QueryBuilder) => TypedQueryBuilder<TSelectedFields>),\n\t): CockroachViewWithSelection<TName, false, AddAliasToSelection<TSelectedFields, TName, 'cockroach'>> {\n\t\tif (typeof qb === 'function') {\n\t\t\tqb = qb(new QueryBuilder());\n\t\t}\n\t\tconst selectionProxy = new SelectionProxyHandler<TSelectedFields>({\n\t\t\talias: this.name,\n\t\t\tsqlBehavior: 'error',\n\t\t\tsqlAliasedBehavior: 'alias',\n\t\t\treplaceOriginalName: true,\n\t\t});\n\t\tconst aliasedSelection = new Proxy(qb.getSelectedFields(), selectionProxy);\n\t\treturn new Proxy(\n\t\t\tnew CockroachView({\n\t\t\t\tconfig: {\n\t\t\t\t\tname: this.name,\n\t\t\t\t\tschema: this.schema,\n\t\t\t\t\tselectedFields: aliasedSelection,\n\t\t\t\t\tquery: qb.getSQL().inlineParams(),\n\t\t\t\t},\n\t\t\t}),\n\t\t\tselectionProxy as any,\n\t\t) as CockroachViewWithSelection<TName, false, AddAliasToSelection<TSelectedFields, TName, 'cockroach'>>;\n\t}\n}\n\nexport class ManualViewBuilder<\n\tTName extends string = string,\n\tTColumns extends Record<string, ColumnBuilderBase> = Record<string, ColumnBuilderBase>,\n> extends DefaultViewBuilderCore<{ name: TName; columns: TColumns }> {\n\tstatic override readonly [entityKind]: string = 'CockroachManualViewBuilder';\n\n\tprivate columns: Record<string, CockroachColumn>;\n\n\tconstructor(\n\t\tname: TName,\n\t\tcolumns: TColumns,\n\t\tschema: string | undefined,\n\t) {\n\t\tsuper(name, schema);\n\t\tthis.columns = getTableColumns(cockroachTable(name, columns));\n\t}\n\n\texisting(): CockroachViewWithSelection<TName, true, BuildColumns<TName, TColumns, 'cockroach'>> {\n\t\treturn new Proxy(\n\t\t\tnew CockroachView({\n\t\t\t\tconfig: {\n\t\t\t\t\tname: this.name,\n\t\t\t\t\tschema: this.schema,\n\t\t\t\t\tselectedFields: this.columns,\n\t\t\t\t\tquery: undefined,\n\t\t\t\t},\n\t\t\t}),\n\t\t\tnew SelectionProxyHandler({\n\t\t\t\talias: this.name,\n\t\t\t\tsqlBehavior: 'error',\n\t\t\t\tsqlAliasedBehavior: 'alias',\n\t\t\t\treplaceOriginalName: true,\n\t\t\t}),\n\t\t) as CockroachViewWithSelection<TName, true, BuildColumns<TName, TColumns, 'cockroach'>>;\n\t}\n\n\tas(query: SQL): CockroachViewWithSelection<TName, false, BuildColumns<TName, TColumns, 'cockroach'>> {\n\t\treturn new Proxy(\n\t\t\tnew CockroachView({\n\t\t\t\tconfig: {\n\t\t\t\t\tname: this.name,\n\t\t\t\t\tschema: this.schema,\n\t\t\t\t\tselectedFields: this.columns,\n\t\t\t\t\tquery: query.inlineParams(),\n\t\t\t\t},\n\t\t\t}),\n\t\t\tnew SelectionProxyHandler({\n\t\t\t\talias: this.name,\n\t\t\t\tsqlBehavior: 'error',\n\t\t\t\tsqlAliasedBehavior: 'alias',\n\t\t\t\treplaceOriginalName: true,\n\t\t\t}),\n\t\t) as CockroachViewWithSelection<TName, false, BuildColumns<TName, TColumns, 'cockroach'>>;\n\t}\n}\n\nexport class MaterializedViewBuilderCore<TConfig extends { name: string; columns?: unknown }> {\n\tstatic readonly [entityKind]: string = 'CockroachMaterializedViewBuilderCore';\n\n\tdeclare _: {\n\t\treadonly name: TConfig['name'];\n\t\treadonly columns: TConfig['columns'];\n\t};\n\n\tconstructor(\n\t\tprotected name: TConfig['name'],\n\t\tprotected schema: string | undefined,\n\t) {}\n\n\tprotected config: {\n\t\twithNoData?: boolean;\n\t} = {};\n\n\twithNoData(): this {\n\t\tthis.config.withNoData = true;\n\t\treturn this;\n\t}\n}\n\nexport class MaterializedViewBuilder<TName extends string = string>\n\textends MaterializedViewBuilderCore<{ name: TName }>\n{\n\tstatic override readonly [entityKind]: string = 'CockroachMaterializedViewBuilder';\n\n\tas<TSelectedFields extends ColumnsSelection>(\n\t\tqb: TypedQueryBuilder<TSelectedFields> | ((qb: QueryBuilder) => TypedQueryBuilder<TSelectedFields>),\n\t): CockroachMaterializedViewWithSelection<\n\t\tTName,\n\t\tfalse,\n\t\tAddAliasToSelection<TSelectedFields, TName, 'cockroach'>\n\t> {\n\t\tif (typeof qb === 'function') {\n\t\t\tqb = qb(new QueryBuilder());\n\t\t}\n\t\tconst selectionProxy = new SelectionProxyHandler<TSelectedFields>({\n\t\t\talias: this.name,\n\t\t\tsqlBehavior: 'error',\n\t\t\tsqlAliasedBehavior: 'alias',\n\t\t\treplaceOriginalName: true,\n\t\t});\n\t\tconst aliasedSelection = new Proxy(qb.getSelectedFields(), selectionProxy);\n\t\treturn new Proxy(\n\t\t\tnew CockroachMaterializedView({\n\t\t\t\tcockroachConfig: {\n\t\t\t\t\twithNoData: this.config.withNoData,\n\t\t\t\t},\n\t\t\t\tconfig: {\n\t\t\t\t\tname: this.name,\n\t\t\t\t\tschema: this.schema,\n\t\t\t\t\tselectedFields: aliasedSelection,\n\t\t\t\t\tquery: qb.getSQL().inlineParams(),\n\t\t\t\t},\n\t\t\t}),\n\t\t\tselectionProxy as any,\n\t\t) as CockroachMaterializedViewWithSelection<\n\t\t\tTName,\n\t\t\tfalse,\n\t\t\tAddAliasToSelection<TSelectedFields, TName, 'cockroach'>\n\t\t>;\n\t}\n}\n\nexport class ManualMaterializedViewBuilder<\n\tTName extends string = string,\n\tTColumns extends Record<string, ColumnBuilderBase> = Record<string, ColumnBuilderBase>,\n> extends MaterializedViewBuilderCore<{ name: TName; columns: TColumns }> {\n\tstatic override readonly [entityKind]: string = 'CockroachManualMaterializedViewBuilder';\n\n\tprivate columns: Record<string, CockroachColumn>;\n\n\tconstructor(\n\t\tname: TName,\n\t\tcolumns: TColumns,\n\t\tschema: string | undefined,\n\t) {\n\t\tsuper(name, schema);\n\t\tthis.columns = getTableColumns(cockroachTable(name, columns));\n\t}\n\n\texisting(): CockroachMaterializedViewWithSelection<TName, true, BuildColumns<TName, TColumns, 'cockroach'>> {\n\t\treturn new Proxy(\n\t\t\tnew CockroachMaterializedView({\n\t\t\t\tcockroachConfig: {\n\t\t\t\t\twithNoData: this.config.withNoData,\n\t\t\t\t},\n\t\t\t\tconfig: {\n\t\t\t\t\tname: this.name,\n\t\t\t\t\tschema: this.schema,\n\t\t\t\t\tselectedFields: this.columns,\n\t\t\t\t\tquery: undefined,\n\t\t\t\t},\n\t\t\t}),\n\t\t\tnew SelectionProxyHandler({\n\t\t\t\talias: this.name,\n\t\t\t\tsqlBehavior: 'error',\n\t\t\t\tsqlAliasedBehavior: 'alias',\n\t\t\t\treplaceOriginalName: true,\n\t\t\t}),\n\t\t) as CockroachMaterializedViewWithSelection<TName, true, BuildColumns<TName, TColumns, 'cockroach'>>;\n\t}\n\n\tas(query: SQL): CockroachMaterializedViewWithSelection<TName, false, BuildColumns<TName, TColumns, 'cockroach'>> {\n\t\treturn new Proxy(\n\t\t\tnew CockroachMaterializedView({\n\t\t\t\tcockroachConfig: {\n\t\t\t\t\twithNoData: this.config.withNoData,\n\t\t\t\t},\n\t\t\t\tconfig: {\n\t\t\t\t\tname: this.name,\n\t\t\t\t\tschema: this.schema,\n\t\t\t\t\tselectedFields: this.columns,\n\t\t\t\t\tquery: query.inlineParams(),\n\t\t\t\t},\n\t\t\t}),\n\t\t\tnew SelectionProxyHandler({\n\t\t\t\talias: this.name,\n\t\t\t\tsqlBehavior: 'error',\n\t\t\t\tsqlAliasedBehavior: 'alias',\n\t\t\t\treplaceOriginalName: true,\n\t\t\t}),\n\t\t) as CockroachMaterializedViewWithSelection<TName, false, BuildColumns<TName, TColumns, 'cockroach'>>;\n\t}\n}\n\nexport class CockroachView<\n\tTName extends string = string,\n\tTExisting extends boolean = boolean,\n\tTSelectedFields extends ColumnsSelection = ColumnsSelection,\n> extends CockroachViewBase<TName, TExisting, TSelectedFields> {\n\tstatic override readonly [entityKind]: string = 'CockroachView';\n\n\tconstructor({ config }: {\n\t\tconfig: {\n\t\t\tname: TName;\n\t\t\tschema: string | undefined;\n\t\t\tselectedFields: ColumnsSelection;\n\t\t\tquery: SQL | undefined;\n\t\t};\n\t}) {\n\t\tsuper(config);\n\t}\n}\n\nexport type CockroachViewWithSelection<\n\tTName extends string = string,\n\tTExisting extends boolean = boolean,\n\tTSelectedFields extends ColumnsSelection = ColumnsSelection,\n> = CockroachView<TName, TExisting, TSelectedFields> & TSelectedFields;\n\nexport const CockroachMaterializedViewConfig = Symbol.for('drizzle:CockroachMaterializedViewConfig');\n\nexport class CockroachMaterializedView<\n\tTName extends string = string,\n\tTExisting extends boolean = boolean,\n\tTSelectedFields extends ColumnsSelection = ColumnsSelection,\n> extends CockroachViewBase<TName, TExisting, TSelectedFields> {\n\tstatic override readonly [entityKind]: string = 'CockroachMaterializedView';\n\n\treadonly [CockroachMaterializedViewConfig]: {\n\t\treadonly withNoData?: boolean;\n\t} | undefined;\n\n\tconstructor({ cockroachConfig, config }: {\n\t\tcockroachConfig: {\n\t\t\twithNoData: boolean | undefined;\n\t\t} | undefined;\n\t\tconfig: {\n\t\t\tname: TName;\n\t\t\tschema: string | undefined;\n\t\t\tselectedFields: ColumnsSelection;\n\t\t\tquery: SQL | undefined;\n\t\t};\n\t}) {\n\t\tsuper(config);\n\t\tthis[CockroachMaterializedViewConfig] = {\n\t\t\twithNoData: cockroachConfig?.withNoData,\n\t\t};\n\t}\n}\n\nexport type CockroachMaterializedViewWithSelection<\n\tTName extends string = string,\n\tTExisting extends boolean = boolean,\n\tTSelectedFields extends ColumnsSelection = ColumnsSelection,\n> = CockroachMaterializedView<TName, TExisting, TSelectedFields> & TSelectedFields;\n\n/** @internal */\nexport function cockroachViewWithSchema(\n\tname: string,\n\tselection: Record<string, ColumnBuilderBase> | undefined,\n\tschema: string | undefined,\n): ViewBuilder | ManualViewBuilder {\n\tif (selection) {\n\t\treturn new ManualViewBuilder(name, selection, schema);\n\t}\n\treturn new ViewBuilder(name, schema);\n}\n\n/** @internal */\nexport function cockroachMaterializedViewWithSchema(\n\tname: string,\n\tselection: Record<string, ColumnBuilderBase> | undefined,\n\tschema: string | undefined,\n): MaterializedViewBuilder | ManualMaterializedViewBuilder {\n\tif (selection) {\n\t\treturn new ManualMaterializedViewBuilder(name, selection, schema);\n\t}\n\treturn new MaterializedViewBuilder(name, schema);\n}\n\nexport function cockroachView<TName extends string>(name: TName): ViewBuilder<TName>;\nexport function cockroachView<TName extends string, TColumns extends Record<string, ColumnBuilderBase>>(\n\tname: TName,\n\tcolumns: TColumns,\n): ManualViewBuilder<TName, TColumns>;\nexport function cockroachView(\n\tname: string,\n\tcolumns?: Record<string, ColumnBuilderBase>,\n): ViewBuilder | ManualViewBuilder {\n\treturn cockroachViewWithSchema(name, columns, undefined);\n}\n\nexport function cockroachMaterializedView<TName extends string>(name: TName): MaterializedViewBuilder<TName>;\nexport function cockroachMaterializedView<\n\tTName extends string,\n\tTColumns extends Record<string, ColumnBuilderBase>,\n>(\n\tname: TName,\n\tcolumns: TColumns,\n): ManualMaterializedViewBuilder<TName, TColumns>;\nexport function cockroachMaterializedView(\n\tname: string,\n\tcolumns?: Record<string, ColumnBuilderBase>,\n): MaterializedViewBuilder | ManualMaterializedViewBuilder {\n\treturn cockroachMaterializedViewWithSchema(name, columns, undefined);\n}\n\nexport function isCockroachView(obj: unknown): obj is CockroachView {\n\treturn is(obj, CockroachView);\n}\n\nexport function isCockroachMaterializedView(obj: unknown): obj is CockroachMaterializedView {\n\treturn is(obj, CockroachMaterializedView);\n}\n"],"mappings":";;;;;;;;;AAYA,IAAa,yBAAb,MAAyF;CACxF,QAAiBA,0BAAsB;CAOvC,YACC,AAAUC,MACV,AAAUC,QACT;EAFS;EACA;;;AAIZ,IAAa,cAAb,cAAgE,uBAAwC;CACvG,QAA0BF,0BAAsB;CAEhD,GACC,IACqG;AACrG,MAAI,OAAO,OAAO,WACjB,MAAK,GAAG,IAAIG,kEAAc,CAAC;EAE5B,MAAM,iBAAiB,IAAIC,2CAAuC;GACjE,OAAO,KAAK;GACZ,aAAa;GACb,oBAAoB;GACpB,qBAAqB;GACrB,CAAC;EACF,MAAM,mBAAmB,IAAI,MAAM,GAAG,mBAAmB,EAAE,eAAe;AAC1E,SAAO,IAAI,MACV,IAAI,cAAc,EACjB,QAAQ;GACP,MAAM,KAAK;GACX,QAAQ,KAAK;GACb,gBAAgB;GAChB,OAAO,GAAG,QAAQ,CAAC,cAAc;GACjC,EACD,CAAC,EACF,eACA;;;AAIH,IAAa,oBAAb,cAGU,uBAA2D;CACpE,QAA0BJ,0BAAsB;CAEhD,AAAQ;CAER,YACC,MACA,SACA,QACC;AACD,QAAM,MAAM,OAAO;AACnB,OAAK,0CAA0BK,4CAAe,MAAM,QAAQ,CAAC;;CAG9D,WAAgG;AAC/F,SAAO,IAAI,MACV,IAAI,cAAc,EACjB,QAAQ;GACP,MAAM,KAAK;GACX,QAAQ,KAAK;GACb,gBAAgB,KAAK;GACrB,OAAO;GACP,EACD,CAAC,EACF,IAAID,2CAAsB;GACzB,OAAO,KAAK;GACZ,aAAa;GACb,oBAAoB;GACpB,qBAAqB;GACrB,CAAC,CACF;;CAGF,GAAG,OAAkG;AACpG,SAAO,IAAI,MACV,IAAI,cAAc,EACjB,QAAQ;GACP,MAAM,KAAK;GACX,QAAQ,KAAK;GACb,gBAAgB,KAAK;GACrB,OAAO,MAAM,cAAc;GAC3B,EACD,CAAC,EACF,IAAIA,2CAAsB;GACzB,OAAO,KAAK;GACZ,aAAa;GACb,oBAAoB;GACpB,qBAAqB;GACrB,CAAC,CACF;;;AAIH,IAAa,8BAAb,MAA8F;CAC7F,QAAiBJ,0BAAsB;CAOvC,YACC,AAAUC,MACV,AAAUC,QACT;EAFS;EACA;;CAGX,AAAU,SAEN,EAAE;CAEN,aAAmB;AAClB,OAAK,OAAO,aAAa;AACzB,SAAO;;;AAIT,IAAa,0BAAb,cACS,4BACT;CACC,QAA0BF,0BAAsB;CAEhD,GACC,IAKC;AACD,MAAI,OAAO,OAAO,WACjB,MAAK,GAAG,IAAIG,kEAAc,CAAC;EAE5B,MAAM,iBAAiB,IAAIC,2CAAuC;GACjE,OAAO,KAAK;GACZ,aAAa;GACb,oBAAoB;GACpB,qBAAqB;GACrB,CAAC;EACF,MAAM,mBAAmB,IAAI,MAAM,GAAG,mBAAmB,EAAE,eAAe;AAC1E,SAAO,IAAI,MACV,IAAI,0BAA0B;GAC7B,iBAAiB,EAChB,YAAY,KAAK,OAAO,YACxB;GACD,QAAQ;IACP,MAAM,KAAK;IACX,QAAQ,KAAK;IACb,gBAAgB;IAChB,OAAO,GAAG,QAAQ,CAAC,cAAc;IACjC;GACD,CAAC,EACF,eACA;;;AAQH,IAAa,gCAAb,cAGU,4BAAgE;CACzE,QAA0BJ,0BAAsB;CAEhD,AAAQ;CAER,YACC,MACA,SACA,QACC;AACD,QAAM,MAAM,OAAO;AACnB,OAAK,0CAA0BK,4CAAe,MAAM,QAAQ,CAAC;;CAG9D,WAA4G;AAC3G,SAAO,IAAI,MACV,IAAI,0BAA0B;GAC7B,iBAAiB,EAChB,YAAY,KAAK,OAAO,YACxB;GACD,QAAQ;IACP,MAAM,KAAK;IACX,QAAQ,KAAK;IACb,gBAAgB,KAAK;IACrB,OAAO;IACP;GACD,CAAC,EACF,IAAID,2CAAsB;GACzB,OAAO,KAAK;GACZ,aAAa;GACb,oBAAoB;GACpB,qBAAqB;GACrB,CAAC,CACF;;CAGF,GAAG,OAA8G;AAChH,SAAO,IAAI,MACV,IAAI,0BAA0B;GAC7B,iBAAiB,EAChB,YAAY,KAAK,OAAO,YACxB;GACD,QAAQ;IACP,MAAM,KAAK;IACX,QAAQ,KAAK;IACb,gBAAgB,KAAK;IACrB,OAAO,MAAM,cAAc;IAC3B;GACD,CAAC,EACF,IAAIA,2CAAsB;GACzB,OAAO,KAAK;GACZ,aAAa;GACb,oBAAoB;GACpB,qBAAqB;GACrB,CAAC,CACF;;;AAIH,IAAa,gBAAb,cAIUE,mDAAqD;CAC9D,QAA0BN,0BAAsB;CAEhD,YAAY,EAAE,UAOX;AACF,QAAM,OAAO;;;AAUf,MAAa,kCAAkC,OAAO,IAAI,0CAA0C;AAEpG,IAAa,4BAAb,cAIUM,mDAAqD;CAC9D,QAA0BN,0BAAsB;CAEhD,CAAU;CAIV,YAAY,EAAE,iBAAiB,UAU5B;AACF,QAAM,OAAO;AACb,OAAK,mCAAmC,EACvC,YAAY,iBAAiB,YAC7B;;;;AAWH,SAAgB,wBACf,MACA,WACA,QACkC;AAClC,KAAI,UACH,QAAO,IAAI,kBAAkB,MAAM,WAAW,OAAO;AAEtD,QAAO,IAAI,YAAY,MAAM,OAAO;;;AAIrC,SAAgB,oCACf,MACA,WACA,QAC0D;AAC1D,KAAI,UACH,QAAO,IAAI,8BAA8B,MAAM,WAAW,OAAO;AAElE,QAAO,IAAI,wBAAwB,MAAM,OAAO;;AAQjD,SAAgB,cACf,MACA,SACkC;AAClC,QAAO,wBAAwB,MAAM,SAAS,OAAU;;AAWzD,SAAgB,0BACf,MACA,SAC0D;AAC1D,QAAO,oCAAoC,MAAM,SAAS,OAAU;;AAGrE,SAAgB,gBAAgB,KAAoC;AACnE,4BAAU,KAAK,cAAc;;AAG9B,SAAgB,4BAA4B,KAAgD;AAC3F,4BAAU,KAAK,0BAA0B"}