{"version":3,"sources":["../../../src/server/app-render/app-render-render-utils.ts"],"sourcesContent":["import { InvariantError } from '../../shared/lib/invariant-error'\nimport { createAtomicTimerGroup } from './app-render-scheduling'\nimport {\n  DANGEROUSLY_runPendingImmediatesAfterCurrentTask,\n  expectNoPendingImmediates,\n} from '../node-environment-extensions/fast-set-immediate.external'\n\n/**\n * This is a utility function to make scheduling sequential tasks that run back to back easier.\n * We schedule on the same queue (setTimeout) at the same time to ensure no other events can sneak in between.\n */\nexport function scheduleInSequentialTasks<R>(\n  render: () => R | Promise<R>,\n  followup: () => void\n): Promise<R> {\n  if (process.env.NEXT_RUNTIME === 'edge') {\n    throw new InvariantError(\n      '`scheduleInSequentialTasks` should not be called in edge runtime.'\n    )\n  } else {\n    return new Promise((resolve, reject) => {\n      const scheduleTimeout = createAtomicTimerGroup()\n\n      let pendingResult: R | Promise<R>\n      scheduleTimeout(() => {\n        try {\n          DANGEROUSLY_runPendingImmediatesAfterCurrentTask()\n          pendingResult = render()\n        } catch (err) {\n          reject(err)\n        }\n      })\n\n      scheduleTimeout(() => {\n        try {\n          expectNoPendingImmediates()\n          followup()\n          resolve(pendingResult)\n        } catch (err) {\n          reject(err)\n        }\n      })\n    })\n  }\n}\n\n/**\n * This is a utility function to make scheduling sequential tasks that run back to back easier.\n * We schedule on the same queue (setTimeout) at the same time to ensure no other events can sneak in between.\n * The function that runs in the second task gets access to the first tasks's result.\n */\nexport function pipelineInSequentialTasks<A, B, C>(\n  one: () => A,\n  two: (a: A) => B,\n  three: (b: B) => C\n): Promise<C> {\n  if (process.env.NEXT_RUNTIME === 'edge') {\n    throw new InvariantError(\n      '`pipelineInSequentialTasks` should not be called in edge runtime.'\n    )\n  } else {\n    return new Promise((resolve, reject) => {\n      const scheduleTimeout = createAtomicTimerGroup()\n\n      let oneResult: A\n      scheduleTimeout(() => {\n        try {\n          DANGEROUSLY_runPendingImmediatesAfterCurrentTask()\n          oneResult = one()\n        } catch (err) {\n          clearTimeout(twoId)\n          clearTimeout(threeId)\n          clearTimeout(fourId)\n          reject(err)\n        }\n      })\n\n      let twoResult: B\n      const twoId = scheduleTimeout(() => {\n        // if `one` threw, then this timeout would've been cleared,\n        // so if we got here, we're guaranteed to have a value.\n        try {\n          DANGEROUSLY_runPendingImmediatesAfterCurrentTask()\n          twoResult = two(oneResult!)\n        } catch (err) {\n          clearTimeout(threeId)\n          clearTimeout(fourId)\n          reject(err)\n        }\n      })\n\n      let threeResult: C\n      const threeId = scheduleTimeout(() => {\n        // if `two` threw, then this timeout would've been cleared,\n        // so if we got here, we're guaranteed to have a value.\n        try {\n          expectNoPendingImmediates()\n          threeResult = three(twoResult!)\n        } catch (err) {\n          clearTimeout(fourId)\n          reject(err)\n        }\n      })\n\n      // We wait a task before resolving/rejecting\n      const fourId = scheduleTimeout(() => {\n        resolve(threeResult)\n      })\n    })\n  }\n}\n"],"names":["pipelineInSequentialTasks","scheduleInSequentialTasks","render","followup","process","env","NEXT_RUNTIME","InvariantError","Promise","resolve","reject","scheduleTimeout","createAtomicTimerGroup","pendingResult","DANGEROUSLY_runPendingImmediatesAfterCurrentTask","err","expectNoPendingImmediates","one","two","three","oneResult","clearTimeout","twoId","threeId","fourId","twoResult","threeResult"],"mappings":";;;;;;;;;;;;;;;IAmDgBA,yBAAyB;eAAzBA;;IAxCAC,yBAAyB;eAAzBA;;;gCAXe;qCACQ;0CAIhC;AAMA,SAASA,0BACdC,MAA4B,EAC5BC,QAAoB;IAEpB,IAAIC,QAAQC,GAAG,CAACC,YAAY,KAAK,QAAQ;QACvC,MAAM,qBAEL,CAFK,IAAIC,8BAAc,CACtB,sEADI,qBAAA;mBAAA;wBAAA;0BAAA;QAEN;IACF,OAAO;QACL,OAAO,IAAIC,QAAQ,CAACC,SAASC;YAC3B,MAAMC,kBAAkBC,IAAAA,2CAAsB;YAE9C,IAAIC;YACJF,gBAAgB;gBACd,IAAI;oBACFG,IAAAA,0EAAgD;oBAChDD,gBAAgBX;gBAClB,EAAE,OAAOa,KAAK;oBACZL,OAAOK;gBACT;YACF;YAEAJ,gBAAgB;gBACd,IAAI;oBACFK,IAAAA,mDAAyB;oBACzBb;oBACAM,QAAQI;gBACV,EAAE,OAAOE,KAAK;oBACZL,OAAOK;gBACT;YACF;QACF;IACF;AACF;AAOO,SAASf,0BACdiB,GAAY,EACZC,GAAgB,EAChBC,KAAkB;IAElB,IAAIf,QAAQC,GAAG,CAACC,YAAY,KAAK,QAAQ;QACvC,MAAM,qBAEL,CAFK,IAAIC,8BAAc,CACtB,sEADI,qBAAA;mBAAA;wBAAA;0BAAA;QAEN;IACF,OAAO;QACL,OAAO,IAAIC,QAAQ,CAACC,SAASC;YAC3B,MAAMC,kBAAkBC,IAAAA,2CAAsB;YAE9C,IAAIQ;YACJT,gBAAgB;gBACd,IAAI;oBACFG,IAAAA,0EAAgD;oBAChDM,YAAYH;gBACd,EAAE,OAAOF,KAAK;oBACZM,aAAaC;oBACbD,aAAaE;oBACbF,aAAaG;oBACbd,OAAOK;gBACT;YACF;YAEA,IAAIU;YACJ,MAAMH,QAAQX,gBAAgB;gBAC5B,2DAA2D;gBAC3D,uDAAuD;gBACvD,IAAI;oBACFG,IAAAA,0EAAgD;oBAChDW,YAAYP,IAAIE;gBAClB,EAAE,OAAOL,KAAK;oBACZM,aAAaE;oBACbF,aAAaG;oBACbd,OAAOK;gBACT;YACF;YAEA,IAAIW;YACJ,MAAMH,UAAUZ,gBAAgB;gBAC9B,2DAA2D;gBAC3D,uDAAuD;gBACvD,IAAI;oBACFK,IAAAA,mDAAyB;oBACzBU,cAAcP,MAAMM;gBACtB,EAAE,OAAOV,KAAK;oBACZM,aAAaG;oBACbd,OAAOK;gBACT;YACF;YAEA,4CAA4C;YAC5C,MAAMS,SAASb,gBAAgB;gBAC7BF,QAAQiB;YACV;QACF;IACF;AACF","ignoreList":[0]}