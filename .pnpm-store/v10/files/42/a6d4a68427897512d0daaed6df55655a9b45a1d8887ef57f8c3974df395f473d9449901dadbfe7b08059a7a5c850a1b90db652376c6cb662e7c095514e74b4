{"version":3,"sources":["../../../../../../src/client/components/router-reducer/reducers/refresh-reducer.ts"],"sourcesContent":["import type {\n  Mutable,\n  ReadonlyReducerState,\n  ReducerState,\n} from '../router-reducer-types'\nimport { handleNavigationResult } from './navigate-reducer'\nimport { navigateToSeededRoute } from '../../segment-cache/navigation'\nimport { revalidateEntireCache } from '../../segment-cache/cache'\nimport { hasInterceptionRouteInCurrentTree } from './has-interception-route-in-current-tree'\nimport { FreshnessPolicy } from '../ppr-navigations'\n\nexport function refreshReducer(state: ReadonlyReducerState): ReducerState {\n  // TODO: Currently, all refreshes purge the prefetch cache. In the future,\n  // only client-side refreshes will have this behavior; the server-side\n  // `refresh` should send new data without purging the prefetch cache.\n  const currentNextUrl = state.nextUrl\n  const currentRouterState = state.tree\n  revalidateEntireCache(currentNextUrl, currentRouterState)\n  return refreshDynamicData(state, FreshnessPolicy.RefreshAll)\n}\n\nexport function refreshDynamicData(\n  state: ReadonlyReducerState,\n  freshnessPolicy: FreshnessPolicy.RefreshAll | FreshnessPolicy.HMRRefresh\n): ReducerState {\n  const currentNextUrl = state.nextUrl\n\n  // We always send the last next-url, not the current when performing a dynamic\n  // request. This is because we update the next-url after a navigation, but we\n  // want the same interception route to be matched that used the last next-url.\n  const nextUrlForRefresh = hasInterceptionRouteInCurrentTree(state.tree)\n    ? state.previousNextUrl || currentNextUrl\n    : null\n\n  // A refresh is modeled as a navigation to the current URL, but where any\n  // existing dynamic data (including in shared layouts) is re-fetched.\n  const currentCanonicalUrl = state.canonicalUrl\n  const currentUrl = new URL(currentCanonicalUrl, location.origin)\n  const currentFlightRouterState = state.tree\n  const shouldScroll = true\n\n  const navigationSeed = {\n    tree: state.tree,\n    renderedSearch: state.renderedSearch,\n    data: null,\n    head: null,\n  }\n\n  const now = Date.now()\n  const result = navigateToSeededRoute(\n    now,\n    currentUrl,\n    currentCanonicalUrl,\n    navigationSeed,\n    currentUrl,\n    state.cache,\n    currentFlightRouterState,\n    freshnessPolicy,\n    nextUrlForRefresh,\n    shouldScroll\n  )\n\n  const mutable: Mutable = {}\n  mutable.preserveCustomHistoryState = false\n\n  return handleNavigationResult(currentUrl, state, mutable, false, result)\n}\n"],"names":["handleNavigationResult","navigateToSeededRoute","revalidateEntireCache","hasInterceptionRouteInCurrentTree","FreshnessPolicy","refreshReducer","state","currentNextUrl","nextUrl","currentRouterState","tree","refreshDynamicData","RefreshAll","freshnessPolicy","nextUrlForRefresh","previousNextUrl","currentCanonicalUrl","canonicalUrl","currentUrl","URL","location","origin","currentFlightRouterState","shouldScroll","navigationSeed","renderedSearch","data","head","now","Date","result","cache","mutable","preserveCustomHistoryState"],"mappings":"AAKA,SAASA,sBAAsB,QAAQ,qBAAoB;AAC3D,SAASC,qBAAqB,QAAQ,iCAAgC;AACtE,SAASC,qBAAqB,QAAQ,4BAA2B;AACjE,SAASC,iCAAiC,QAAQ,2CAA0C;AAC5F,SAASC,eAAe,QAAQ,qBAAoB;AAEpD,OAAO,SAASC,eAAeC,KAA2B;IACxD,0EAA0E;IAC1E,sEAAsE;IACtE,qEAAqE;IACrE,MAAMC,iBAAiBD,MAAME,OAAO;IACpC,MAAMC,qBAAqBH,MAAMI,IAAI;IACrCR,sBAAsBK,gBAAgBE;IACtC,OAAOE,mBAAmBL,OAAOF,gBAAgBQ,UAAU;AAC7D;AAEA,OAAO,SAASD,mBACdL,KAA2B,EAC3BO,eAAwE;IAExE,MAAMN,iBAAiBD,MAAME,OAAO;IAEpC,8EAA8E;IAC9E,6EAA6E;IAC7E,8EAA8E;IAC9E,MAAMM,oBAAoBX,kCAAkCG,MAAMI,IAAI,IAClEJ,MAAMS,eAAe,IAAIR,iBACzB;IAEJ,yEAAyE;IACzE,qEAAqE;IACrE,MAAMS,sBAAsBV,MAAMW,YAAY;IAC9C,MAAMC,aAAa,IAAIC,IAAIH,qBAAqBI,SAASC,MAAM;IAC/D,MAAMC,2BAA2BhB,MAAMI,IAAI;IAC3C,MAAMa,eAAe;IAErB,MAAMC,iBAAiB;QACrBd,MAAMJ,MAAMI,IAAI;QAChBe,gBAAgBnB,MAAMmB,cAAc;QACpCC,MAAM;QACNC,MAAM;IACR;IAEA,MAAMC,MAAMC,KAAKD,GAAG;IACpB,MAAME,SAAS7B,sBACb2B,KACAV,YACAF,qBACAQ,gBACAN,YACAZ,MAAMyB,KAAK,EACXT,0BACAT,iBACAC,mBACAS;IAGF,MAAMS,UAAmB,CAAC;IAC1BA,QAAQC,0BAA0B,GAAG;IAErC,OAAOjC,uBAAuBkB,YAAYZ,OAAO0B,SAAS,OAAOF;AACnE","ignoreList":[0]}