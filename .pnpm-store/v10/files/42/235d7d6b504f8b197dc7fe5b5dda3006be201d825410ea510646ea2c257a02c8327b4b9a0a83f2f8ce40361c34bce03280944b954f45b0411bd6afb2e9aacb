{"version":3,"file":"common.js","names":["ref","actions"],"sources":["../../../src/mssql-core/columns/common.ts"],"sourcesContent":["import { ColumnBuilder } from '~/column-builder.ts';\nimport type {\n\tColumnBuilderBaseConfig,\n\tColumnBuilderExtraConfig,\n\tColumnBuilderRuntimeConfig,\n\tColumnType,\n\tHasGenerated,\n\tNotNull,\n} from '~/column-builder.ts';\nimport type { ColumnBaseConfig } from '~/column.ts';\nimport { Column } from '~/column.ts';\nimport { entityKind } from '~/entity.ts';\nimport type { ForeignKey, UpdateDeleteAction } from '~/mssql-core/foreign-keys.ts';\nimport { ForeignKeyBuilder } from '~/mssql-core/foreign-keys.ts';\nimport type { AnyMsSqlTable, MsSqlTable } from '~/mssql-core/table.ts';\nimport type { SQL } from '~/sql/index.ts';\nimport type { Update } from '~/utils.ts';\n\nexport type MsSqlColumns = Record<string, MsSqlColumn<any>>;\n\nexport interface ReferenceConfig {\n\tref: () => MsSqlColumn;\n\tactions: {\n\t\tonUpdate?: UpdateDeleteAction;\n\t\tonDelete?: UpdateDeleteAction;\n\t};\n}\n\nexport interface MsSqlGeneratedColumnConfig {\n\tmode?: 'virtual' | 'persisted';\n}\n\nexport abstract class MsSqlColumnBuilder<\n\tT extends ColumnBuilderBaseConfig<ColumnType> = ColumnBuilderBaseConfig<ColumnType>,\n\tTRuntimeConfig extends object = object,\n\tTExtraConfig extends ColumnBuilderExtraConfig = ColumnBuilderExtraConfig,\n> extends ColumnBuilder<T, TRuntimeConfig, TExtraConfig> {\n\tstatic override readonly [entityKind]: string = 'MsSqlColumnBuilder';\n\n\tprivate foreignKeyConfigs: ReferenceConfig[] = [];\n\n\treferences(ref: ReferenceConfig['ref'], actions: ReferenceConfig['actions'] = {}): this {\n\t\tthis.foreignKeyConfigs.push({ ref, actions });\n\t\treturn this;\n\t}\n\n\tunique(name?: string): this {\n\t\tthis.config.isUnique = true;\n\t\tthis.config.uniqueName = name;\n\t\treturn this;\n\t}\n\n\tgeneratedAlwaysAs(\n\t\tas: SQL | (() => SQL),\n\t\tconfig?: MsSqlGeneratedColumnConfig,\n\t): HasGenerated<this, {\n\t\ttype: 'always';\n\t}> {\n\t\tthis.config.generated = {\n\t\t\tas,\n\t\t\ttype: 'always',\n\t\t\tmode: config?.mode ?? 'virtual',\n\t\t};\n\t\treturn this as any;\n\t}\n\n\t/** @internal */\n\tbuildForeignKeys(column: MsSqlColumn, table: MsSqlTable): ForeignKey[] {\n\t\treturn this.foreignKeyConfigs.map(({ ref, actions }) => {\n\t\t\treturn ((ref, actions) => {\n\t\t\t\tconst builder = new ForeignKeyBuilder(() => {\n\t\t\t\t\tconst foreignColumn = ref();\n\t\t\t\t\treturn { columns: [column], foreignColumns: [foreignColumn] };\n\t\t\t\t});\n\t\t\t\tif (actions.onUpdate) {\n\t\t\t\t\tbuilder.onUpdate(actions.onUpdate);\n\t\t\t\t}\n\t\t\t\tif (actions.onDelete) {\n\t\t\t\t\tbuilder.onDelete(actions.onDelete);\n\t\t\t\t}\n\t\t\t\treturn builder.build(table);\n\t\t\t})(ref, actions);\n\t\t});\n\t}\n\n\t/** @internal */\n\tabstract build<TTableName extends string>(\n\t\ttable: AnyMsSqlTable<{ name: TTableName }>,\n\t): MsSqlColumn<any>;\n}\n\n// To understand how to use `MsSqlColumn` and `AnyMsSqlColumn`, see `Column` and `AnyColumn` documentation.\nexport abstract class MsSqlColumn<\n\tT extends ColumnBaseConfig<ColumnType> = ColumnBaseConfig<ColumnType>,\n\tTRuntimeConfig extends object = object,\n> extends Column<T, TRuntimeConfig> {\n\tstatic override readonly [entityKind]: string = 'MsSqlColumn';\n\n\t/** @internal */\n\toverride readonly table: MsSqlTable;\n\n\tconstructor(\n\t\ttable: MsSqlTable,\n\t\tconfig: ColumnBuilderRuntimeConfig<T['data']> & TRuntimeConfig,\n\t) {\n\t\tsuper(table, config);\n\t\tthis.table = table;\n\t}\n\n\t/** @internal */\n\toverride shouldDisableInsert(): boolean {\n\t\treturn false;\n\t}\n}\n\nexport type AnyMsSqlColumn<TPartial extends Partial<ColumnBaseConfig<ColumnType>> = {}> = MsSqlColumn<\n\tRequired<Update<ColumnBaseConfig<ColumnType>, TPartial>>\n>;\n\nexport interface MsSqlColumnWithIdentityConfig {\n\tidentity: { seed?: number; increment?: number } | undefined;\n}\n\nexport abstract class MsSqlColumnBuilderWithIdentity<\n\tT extends ColumnBuilderBaseConfig<ColumnType> = ColumnBuilderBaseConfig<\n\t\tColumnType\n\t>,\n\tTRuntimeConfig extends object = object,\n\tTExtraConfig extends ColumnBuilderExtraConfig = ColumnBuilderExtraConfig,\n> extends MsSqlColumnBuilder<T, TRuntimeConfig & MsSqlColumnWithIdentityConfig, TExtraConfig> {\n\tstatic override readonly [entityKind]: string = 'MsSqlColumnBuilderWithAutoIncrement';\n\n\tconstructor(name: string, dataType: T['dataType'], columnType: string) {\n\t\tsuper(name, dataType, columnType);\n\t}\n\n\tidentity(): NotNull<HasGenerated<this>>;\n\tidentity(config: { seed: number; increment: number }): NotNull<HasGenerated<this>>;\n\tidentity(config?: { seed: number; increment: number }): NotNull<HasGenerated<this>> {\n\t\tthis.config.identity = {\n\t\t\tseed: config ? config.seed : 1,\n\t\t\tincrement: config ? config.increment : 1,\n\t\t};\n\t\tthis.config.hasDefault = true;\n\t\tthis.config.notNull = true;\n\t\treturn this as NotNull<HasGenerated<this>>;\n\t}\n}\n\nexport abstract class MsSqlColumnWithIdentity<\n\tT extends ColumnBaseConfig<ColumnType> = ColumnBaseConfig<ColumnType>,\n\tTRuntimeConfig extends object = object,\n> extends MsSqlColumn<T, MsSqlColumnWithIdentityConfig & TRuntimeConfig> {\n\tstatic override readonly [entityKind]: string = 'MsSqlColumnWithAutoIncrement';\n\n\treadonly identity = this.config.identity;\n\n\toverride shouldDisableInsert(): boolean {\n\t\treturn !!this.identity;\n\t}\n}\n"],"mappings":";;;;;;AAgCA,IAAsB,qBAAtB,cAIU,cAA+C;CACxD,QAA0B,cAAsB;CAEhD,AAAQ,oBAAuC,EAAE;CAEjD,WAAW,KAA6B,UAAsC,EAAE,EAAQ;AACvF,OAAK,kBAAkB,KAAK;GAAE;GAAK;GAAS,CAAC;AAC7C,SAAO;;CAGR,OAAO,MAAqB;AAC3B,OAAK,OAAO,WAAW;AACvB,OAAK,OAAO,aAAa;AACzB,SAAO;;CAGR,kBACC,IACA,QAGE;AACF,OAAK,OAAO,YAAY;GACvB;GACA,MAAM;GACN,MAAM,QAAQ,QAAQ;GACtB;AACD,SAAO;;;CAIR,iBAAiB,QAAqB,OAAiC;AACtE,SAAO,KAAK,kBAAkB,KAAK,EAAE,KAAK,cAAc;AACvD,YAAS,OAAK,cAAY;IACzB,MAAM,UAAU,IAAI,wBAAwB;KAC3C,MAAM,gBAAgBA,OAAK;AAC3B,YAAO;MAAE,SAAS,CAAC,OAAO;MAAE,gBAAgB,CAAC,cAAc;MAAE;MAC5D;AACF,QAAIC,UAAQ,SACX,SAAQ,SAASA,UAAQ,SAAS;AAEnC,QAAIA,UAAQ,SACX,SAAQ,SAASA,UAAQ,SAAS;AAEnC,WAAO,QAAQ,MAAM,MAAM;MACzB,KAAK,QAAQ;IACf;;;AAUJ,IAAsB,cAAtB,cAGU,OAA0B;CACnC,QAA0B,cAAsB;;CAGhD,AAAkB;CAElB,YACC,OACA,QACC;AACD,QAAM,OAAO,OAAO;AACpB,OAAK,QAAQ;;;CAId,AAAS,sBAA+B;AACvC,SAAO;;;AAYT,IAAsB,iCAAtB,cAMU,mBAAoF;CAC7F,QAA0B,cAAsB;CAEhD,YAAY,MAAc,UAAyB,YAAoB;AACtE,QAAM,MAAM,UAAU,WAAW;;CAKlC,SAAS,QAA2E;AACnF,OAAK,OAAO,WAAW;GACtB,MAAM,SAAS,OAAO,OAAO;GAC7B,WAAW,SAAS,OAAO,YAAY;GACvC;AACD,OAAK,OAAO,aAAa;AACzB,OAAK,OAAO,UAAU;AACtB,SAAO;;;AAIT,IAAsB,0BAAtB,cAGU,YAA+D;CACxE,QAA0B,cAAsB;CAEhD,AAAS,WAAW,KAAK,OAAO;CAEhC,AAAS,sBAA+B;AACvC,SAAO,CAAC,CAAC,KAAK"}