{"version":3,"file":"count.js","names":["params: {\n\t\t\tsource: CockroachTable | CockroachViewBase | SQL | SQLWrapper;\n\t\t\tfilters?: SQL<unknown>;\n\t\t\tsession: TSession;\n\t\t}"],"sources":["../../../src/cockroach-core/query-builders/count.ts"],"sourcesContent":["import { entityKind } from '~/entity.ts';\nimport { SQL, sql, type SQLWrapper } from '~/sql/sql.ts';\nimport type { NeonAuthToken } from '~/utils.ts';\nimport type { CockroachSession } from '../session.ts';\nimport type { CockroachTable } from '../table.ts';\nimport type { CockroachViewBase } from '../view-base.ts';\n\nexport class CockroachCountBuilder<\n\tTSession extends CockroachSession<any, any, any>,\n> extends SQL<number> implements Promise<number>, SQLWrapper {\n\tprivate sql: SQL<number>;\n\tprivate token?: NeonAuthToken;\n\n\tstatic override readonly [entityKind]: string = 'CockroachCountBuilder';\n\t[Symbol.toStringTag] = 'CockroachCountBuilder';\n\n\tprivate session: TSession;\n\n\tprivate static buildEmbeddedCount(\n\t\tsource: CockroachTable | CockroachViewBase | SQL | SQLWrapper,\n\t\tfilters?: SQL<unknown>,\n\t): SQL<number> {\n\t\treturn sql<number>`(select count(*) from ${source}${sql.raw(' where ').if(filters)}${filters})`;\n\t}\n\n\tprivate static buildCount(\n\t\tsource: CockroachTable | CockroachViewBase | SQL | SQLWrapper,\n\t\tfilters?: SQL<unknown>,\n\t): SQL<number> {\n\t\treturn sql<number>`select count(*) as count from ${source}${sql.raw(' where ').if(filters)}${filters};`;\n\t}\n\n\tconstructor(\n\t\treadonly params: {\n\t\t\tsource: CockroachTable | CockroachViewBase | SQL | SQLWrapper;\n\t\t\tfilters?: SQL<unknown>;\n\t\t\tsession: TSession;\n\t\t},\n\t) {\n\t\tsuper(CockroachCountBuilder.buildEmbeddedCount(params.source, params.filters).queryChunks);\n\n\t\tthis.mapWith(Number);\n\n\t\tthis.session = params.session;\n\n\t\tthis.sql = CockroachCountBuilder.buildCount(\n\t\t\tparams.source,\n\t\t\tparams.filters,\n\t\t);\n\t}\n\n\t/** @intrnal */\n\tsetToken(token?: NeonAuthToken) {\n\t\tthis.token = token;\n\t\treturn this;\n\t}\n\n\tthen<TResult1 = number, TResult2 = never>(\n\t\tonfulfilled?: ((value: number) => TResult1 | PromiseLike<TResult1>) | null | undefined,\n\t\tonrejected?: ((reason: any) => TResult2 | PromiseLike<TResult2>) | null | undefined,\n\t): Promise<TResult1 | TResult2> {\n\t\treturn Promise.resolve(this.session.count(this.sql, this.token))\n\t\t\t.then(\n\t\t\t\tonfulfilled,\n\t\t\t\tonrejected,\n\t\t\t);\n\t}\n\n\tcatch(\n\t\tonRejected?: ((reason: any) => any) | null | undefined,\n\t): Promise<number> {\n\t\treturn this.then(undefined, onRejected);\n\t}\n\n\tfinally(onFinally?: (() => void) | null | undefined): Promise<number> {\n\t\treturn this.then(\n\t\t\t(value) => {\n\t\t\t\tonFinally?.();\n\t\t\t\treturn value;\n\t\t\t},\n\t\t\t(reason) => {\n\t\t\t\tonFinally?.();\n\t\t\t\tthrow reason;\n\t\t\t},\n\t\t);\n\t}\n}\n"],"mappings":";;;;AAOA,IAAa,wBAAb,MAAa,8BAEH,IAAmD;CAC5D,AAAQ;CACR,AAAQ;CAER,QAA0B,cAAsB;CAChD,CAAC,OAAO,eAAe;CAEvB,AAAQ;CAER,OAAe,mBACd,QACA,SACc;AACd,SAAO,GAAW,yBAAyB,SAAS,IAAI,IAAI,UAAU,CAAC,GAAG,QAAQ,GAAG,QAAQ;;CAG9F,OAAe,WACd,QACA,SACc;AACd,SAAO,GAAW,iCAAiC,SAAS,IAAI,IAAI,UAAU,CAAC,GAAG,QAAQ,GAAG,QAAQ;;CAGtG,YACC,AAASA,QAKR;AACD,QAAM,sBAAsB,mBAAmB,OAAO,QAAQ,OAAO,QAAQ,CAAC,YAAY;EANjF;AAQT,OAAK,QAAQ,OAAO;AAEpB,OAAK,UAAU,OAAO;AAEtB,OAAK,MAAM,sBAAsB,WAChC,OAAO,QACP,OAAO,QACP;;;CAIF,SAAS,OAAuB;AAC/B,OAAK,QAAQ;AACb,SAAO;;CAGR,KACC,aACA,YAC+B;AAC/B,SAAO,QAAQ,QAAQ,KAAK,QAAQ,MAAM,KAAK,KAAK,KAAK,MAAM,CAAC,CAC9D,KACA,aACA,WACA;;CAGH,MACC,YACkB;AAClB,SAAO,KAAK,KAAK,QAAW,WAAW;;CAGxC,QAAQ,WAA8D;AACrE,SAAO,KAAK,MACV,UAAU;AACV,gBAAa;AACb,UAAO;MAEP,WAAW;AACX,gBAAa;AACb,SAAM;IAEP"}