{"version":3,"sources":["../../../../src/server/lib/chrome-devtools-workspace.ts"],"sourcesContent":["import type { ServerResponse } from 'http'\nimport type { NextConfigRuntime } from '../config-shared'\n\nimport { randomUUID } from 'crypto'\nimport * as fs from 'fs'\nimport * as path from 'path'\nimport { getStorageDirectory } from '../cache-dir'\n\n// Keep the uuid in memory as it should never change during the lifetime of the server.\nlet workspaceUUID: string | null = null\n\nexport function isChromeDevtoolsWorkspaceUrl(\n  pathname: string | undefined\n): boolean {\n  return pathname === '/.well-known/appspecific/com.chrome.devtools.json'\n}\n\nexport async function handleChromeDevtoolsWorkspaceRequest(\n  response: ServerResponse,\n  opts: { dir: string },\n  config: NextConfigRuntime\n): Promise<void> {\n  response.setHeader('Content-Type', 'application/json')\n  response.end(\n    JSON.stringify(\n      await getChromeDevtoolsWorkspace(opts.dir, config.distDir),\n      null,\n      2\n    )\n  )\n}\n\n/**\n * https://developer.chrome.com/docs/devtools/workspaces#generate-json\n */\ninterface ChromeDevtoolsWorkspace {\n  workspace: {\n    uuid: string\n    root: string\n  }\n}\n\n/**\n * For https://developer.chrome.com/docs/devtools/workspaces\n */\nasync function getChromeDevtoolsWorkspace(\n  root: string,\n  configDistDir: string\n): Promise<ChromeDevtoolsWorkspace> {\n  if (workspaceUUID === null) {\n    const distDir = path.join(root, configDistDir)\n    const cacheBaseDir = getStorageDirectory(distDir)\n\n    if (cacheBaseDir === undefined) {\n      workspaceUUID = randomUUID()\n    } else {\n      const cachedUUIDPath = path.join(\n        cacheBaseDir,\n        'chrome-devtools-workspace-uuid'\n      )\n      try {\n        workspaceUUID = await fs.promises.readFile(cachedUUIDPath, 'utf8')\n      } catch {\n        // TODO: Why does this need to be v4 and not v5?\n        // With v5 we could base it off of the `distDir` and `root` which would\n        // allow us to persist the workspace across .next wipes.\n        workspaceUUID = randomUUID()\n\n        try {\n          await fs.promises.writeFile(cachedUUIDPath, workspaceUUID, 'utf8')\n        } catch (cause) {\n          console.warn(\n            new Error(\n              'Failed to persist Chrome DevTools workspace UUID. The Chrome DevTools Workspace needs to be reconnected after the next page reload.',\n              { cause }\n            )\n          )\n        }\n      }\n    }\n  }\n\n  return {\n    workspace: {\n      uuid: workspaceUUID,\n      root,\n    },\n  }\n}\n"],"names":["randomUUID","fs","path","getStorageDirectory","workspaceUUID","isChromeDevtoolsWorkspaceUrl","pathname","handleChromeDevtoolsWorkspaceRequest","response","opts","config","setHeader","end","JSON","stringify","getChromeDevtoolsWorkspace","dir","distDir","root","configDistDir","join","cacheBaseDir","undefined","cachedUUIDPath","promises","readFile","writeFile","cause","console","warn","Error","workspace","uuid"],"mappings":"AAGA,SAASA,UAAU,QAAQ,SAAQ;AACnC,YAAYC,QAAQ,KAAI;AACxB,YAAYC,UAAU,OAAM;AAC5B,SAASC,mBAAmB,QAAQ,eAAc;AAElD,uFAAuF;AACvF,IAAIC,gBAA+B;AAEnC,OAAO,SAASC,6BACdC,QAA4B;IAE5B,OAAOA,aAAa;AACtB;AAEA,OAAO,eAAeC,qCACpBC,QAAwB,EACxBC,IAAqB,EACrBC,MAAyB;IAEzBF,SAASG,SAAS,CAAC,gBAAgB;IACnCH,SAASI,GAAG,CACVC,KAAKC,SAAS,CACZ,MAAMC,2BAA2BN,KAAKO,GAAG,EAAEN,OAAOO,OAAO,GACzD,MACA;AAGN;AAYA;;CAEC,GACD,eAAeF,2BACbG,IAAY,EACZC,aAAqB;IAErB,IAAIf,kBAAkB,MAAM;QAC1B,MAAMa,UAAUf,KAAKkB,IAAI,CAACF,MAAMC;QAChC,MAAME,eAAelB,oBAAoBc;QAEzC,IAAII,iBAAiBC,WAAW;YAC9BlB,gBAAgBJ;QAClB,OAAO;YACL,MAAMuB,iBAAiBrB,KAAKkB,IAAI,CAC9BC,cACA;YAEF,IAAI;gBACFjB,gBAAgB,MAAMH,GAAGuB,QAAQ,CAACC,QAAQ,CAACF,gBAAgB;YAC7D,EAAE,OAAM;gBACN,gDAAgD;gBAChD,uEAAuE;gBACvE,wDAAwD;gBACxDnB,gBAAgBJ;gBAEhB,IAAI;oBACF,MAAMC,GAAGuB,QAAQ,CAACE,SAAS,CAACH,gBAAgBnB,eAAe;gBAC7D,EAAE,OAAOuB,OAAO;oBACdC,QAAQC,IAAI,CACV,qBAGC,CAHD,IAAIC,MACF,uIACA;wBAAEH;oBAAM,IAFV,qBAAA;+BAAA;oCAAA;sCAAA;oBAGA;gBAEJ;YACF;QACF;IACF;IAEA,OAAO;QACLI,WAAW;YACTC,MAAM5B;YACNc;QACF;IACF;AACF","ignoreList":[0]}