{"version":3,"sources":["../../../src/build/type-check.ts"],"sourcesContent":["import type { NextConfigComplete } from '../server/config-shared'\nimport type { Telemetry } from '../telemetry/storage'\nimport type { Span } from '../trace'\n\nimport * as Log from './output/log'\nimport { Worker } from '../lib/worker'\nimport createSpinner from './spinner'\nimport { eventTypeCheckCompleted } from '../telemetry/events'\nimport isError from '../lib/is-error'\nimport { hrtimeDurationToString } from './duration-to-string'\n\n/**\n * typescript will be loaded in \"next/lib/verify-typescript-setup\" and\n * then passed to \"next/lib/typescript/runTypeCheck\" as a parameter.\n *\n * Since it is impossible to pass a function from main thread to a worker,\n * instead of running \"next/lib/typescript/runTypeCheck\" in a worker,\n * we will run entire \"next/lib/verify-typescript-setup\" in a worker instead.\n */\nfunction verifyTypeScriptSetup(\n  dir: string,\n  distDir: string,\n  typeCheckPreflight: boolean,\n  tsconfigPath: string | undefined,\n  disableStaticImages: boolean,\n  cacheDir: string | undefined,\n  enableWorkerThreads: boolean | undefined,\n  hasAppDir: boolean,\n  hasPagesDir: boolean,\n  isolatedDevBuild: boolean | undefined,\n  appDir: string | undefined,\n  pagesDir: string | undefined,\n  debugBuildPaths: { app?: string[]; pages?: string[] } | undefined\n) {\n  const typeCheckWorker = new Worker(\n    require.resolve('../lib/verify-typescript-setup'),\n    {\n      exposedMethods: ['verifyTypeScriptSetup'],\n      debuggerPortOffset: -1,\n      isolatedMemory: false,\n      numWorkers: 1,\n      enableWorkerThreads,\n      maxRetries: 0,\n    }\n  ) as Worker & {\n    verifyTypeScriptSetup: typeof import('../lib/verify-typescript-setup').verifyTypeScriptSetup\n  }\n\n  return typeCheckWorker\n    .verifyTypeScriptSetup({\n      dir,\n      distDir,\n      typeCheckPreflight,\n      tsconfigPath,\n      disableStaticImages,\n      cacheDir,\n      hasAppDir,\n      hasPagesDir,\n      isolatedDevBuild,\n      appDir,\n      pagesDir,\n      debugBuildPaths,\n    })\n    .then((result) => {\n      typeCheckWorker.end()\n      return result\n    })\n    .catch(() => {\n      // The error is already logged in the worker, we simply exit the main thread to prevent the\n      // `Jest worker encountered 1 child process exceptions, exceeding retry limit` from showing up\n      process.exit(1)\n    })\n}\n\nexport async function startTypeChecking({\n  cacheDir,\n  config,\n  dir,\n  nextBuildSpan,\n  pagesDir,\n  telemetry,\n  appDir,\n  debugBuildPaths,\n}: {\n  cacheDir: string\n  config: NextConfigComplete\n  dir: string\n  nextBuildSpan: Span\n  pagesDir?: string\n  telemetry: Telemetry\n  appDir?: string\n  debugBuildPaths?: { app?: string[]; pages?: string[] }\n}) {\n  const ignoreTypeScriptErrors = Boolean(config.typescript.ignoreBuildErrors)\n\n  if (ignoreTypeScriptErrors) {\n    Log.info('Skipping validation of types')\n  }\n\n  let typeCheckingSpinnerPrefixText: string | undefined\n  let typeCheckingSpinner: ReturnType<typeof createSpinner> | undefined\n\n  if (!ignoreTypeScriptErrors) {\n    typeCheckingSpinnerPrefixText = 'Running TypeScript'\n  }\n\n  if (typeCheckingSpinnerPrefixText) {\n    typeCheckingSpinner = createSpinner(typeCheckingSpinnerPrefixText)\n  }\n\n  const typeCheckAndLintStart = process.hrtime()\n\n  try {\n    const [verifyResult, typeCheckEnd] = await nextBuildSpan\n      .traceChild('run-typescript')\n      .traceAsyncFn(() =>\n        verifyTypeScriptSetup(\n          dir,\n          config.distDir,\n          !ignoreTypeScriptErrors,\n          config.typescript.tsconfigPath,\n          config.images.disableStaticImages,\n          cacheDir,\n          config.experimental.workerThreads,\n          !!appDir,\n          !!pagesDir,\n          config.experimental.isolatedDevBuild,\n          appDir,\n          pagesDir,\n          debugBuildPaths\n        ).then((resolved) => {\n          const checkEnd = process.hrtime(typeCheckAndLintStart)\n          return [resolved, checkEnd] as const\n        })\n      )\n\n    if (typeCheckingSpinner) {\n      typeCheckingSpinner.stop()\n\n      createSpinner(\n        `Finished TypeScript${ignoreTypeScriptErrors ? ' config validation' : ''} in ${hrtimeDurationToString(typeCheckEnd)}`\n      )?.stopAndPersist()\n    }\n\n    if (!ignoreTypeScriptErrors && verifyResult) {\n      telemetry.record(\n        eventTypeCheckCompleted({\n          durationInSeconds: typeCheckEnd[0],\n          typescriptVersion: verifyResult.version,\n          inputFilesCount: verifyResult.result?.inputFilesCount,\n          totalFilesCount: verifyResult.result?.totalFilesCount,\n          incremental: verifyResult.result?.incremental,\n        })\n      )\n    }\n  } catch (err) {\n    // prevent showing jest-worker internal error as it\n    // isn't helpful for users and clutters output\n    if (isError(err) && err.message === 'Call retries were exceeded') {\n      await telemetry.flush()\n      process.exit(1)\n    }\n    throw err\n  }\n}\n"],"names":["Log","Worker","createSpinner","eventTypeCheckCompleted","isError","hrtimeDurationToString","verifyTypeScriptSetup","dir","distDir","typeCheckPreflight","tsconfigPath","disableStaticImages","cacheDir","enableWorkerThreads","hasAppDir","hasPagesDir","isolatedDevBuild","appDir","pagesDir","debugBuildPaths","typeCheckWorker","require","resolve","exposedMethods","debuggerPortOffset","isolatedMemory","numWorkers","maxRetries","then","result","end","catch","process","exit","startTypeChecking","config","nextBuildSpan","telemetry","ignoreTypeScriptErrors","Boolean","typescript","ignoreBuildErrors","info","typeCheckingSpinnerPrefixText","typeCheckingSpinner","typeCheckAndLintStart","hrtime","verifyResult","typeCheckEnd","traceChild","traceAsyncFn","images","experimental","workerThreads","resolved","checkEnd","stop","stopAndPersist","record","durationInSeconds","typescriptVersion","version","inputFilesCount","totalFilesCount","incremental","err","message","flush"],"mappings":"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","ignoreList":[0]}