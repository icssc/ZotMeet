import { formatToMillis } from "./migrator.utils.js";
import crypto from "node:crypto";
import fs, { existsSync, readdirSync } from "node:fs";
import { join } from "node:path";

//#region src/migrator.ts
function readMigrationFilesOLD(config) {
	const migrationFolderTo = config.migrationsFolder;
	const migrationQueries = [];
	const journalPath = `${migrationFolderTo}/meta/_journal.json`;
	const journalAsString = fs.readFileSync(journalPath).toString();
	const journal = JSON.parse(journalAsString);
	for (const journalEntry of journal.entries) {
		const migrationPath = `${migrationFolderTo}/${journalEntry.tag}.sql`;
		try {
			const query = fs.readFileSync(`${migrationFolderTo}/${journalEntry.tag}.sql`).toString();
			const result = query.split("--> statement-breakpoint").map((it) => {
				return it;
			});
			migrationQueries.push({
				sql: result,
				bps: journalEntry.breakpoints,
				folderMillis: journalEntry.when,
				hash: crypto.createHash("sha256").update(query).digest("hex")
			});
		} catch {
			throw new Error(`No file ${migrationPath} found in ${migrationFolderTo} folder`);
		}
	}
	return migrationQueries;
}
function readMigrationFiles(config) {
	if (fs.existsSync(`${config.migrationsFolder}/meta/_journal.json`)) {
		console.log("\nWarning: We detected that you have old drizzle-kit migration folders. We suggest to upgrade drizzle-kit and run \"drizzle-kit up\"\n");
		return readMigrationFilesOLD(config);
	}
	const migrationFolderTo = config.migrationsFolder;
	const migrationQueries = [];
	const migrations = readdirSync(migrationFolderTo).map((subdir) => ({
		path: join(migrationFolderTo, subdir, "migration.sql"),
		name: subdir
	})).filter((it) => existsSync(it.path));
	migrations.sort((a, b) => a.name.localeCompare(b.name));
	for (const migration of migrations) {
		const migrationPath = migration.path;
		const migrationDate = migration.name.slice(0, 14);
		const query = fs.readFileSync(migrationPath).toString();
		const result = query.split("--> statement-breakpoint").map((it) => {
			return it;
		});
		const millis = formatToMillis(migrationDate);
		migrationQueries.push({
			sql: result,
			bps: true,
			folderMillis: millis,
			hash: crypto.createHash("sha256").update(query).digest("hex")
		});
	}
	return migrationQueries;
}

//#endregion
export { readMigrationFiles };
//# sourceMappingURL=migrator.js.map